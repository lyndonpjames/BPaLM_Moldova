---
title: "Manuscript Tables and Figures"
author: "Lyndon James"
date: "2024-01-22"
output:
  pdf_document: default
  html_document: default
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova")
install.packages("gdata")
install.packages("tidyverse")
install.packages("ggpubr")
install.packages("viridis")
install.packages("hrbrthemes")
install.packages("janitor")
install.packages("reshape2")
library(gdata)
library(tidyverse)
library(stringr)
library(broom)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(viridis)
library(janitor)
library(reshape2)
```


```{r specify constant values, echo = FALSE}

# Specify WTP 

WTP_L <- 0.85*5528.59
WTP_U <- 1.27*5528.59

WTP <- WTP_L

data_bc <- read.csv("Results/TreeAgeOutputBaseCase_20231221.csv")
```

#############################################################################
#
# DATA PROCESSING FUNCTIONS
#
#############################################################################

```{r postprocessing function 1 health outcomes, echo=FALSE}

fn_process_healthoutcomes <- function(data_bc){
# Generate 1000x4 matrix for health outcomes per PSA run
bc_QALY_d <- subset(data_bc, select = c(QALYs..discounted...1., QALYs..discounted...2., QALYs..discounted...3., QALYs..discounted...4., QALYs..discounted...5., QALYs..discounted...6., QALYs..discounted...7., QALYs..discounted...8., QALYs..discounted...9., dist_FQR, dist_HRR_cure_SensAnalysis))

bc_QALY_und <- subset(data_bc, select = c(QALYs..undiscounted...1., QALYs..undiscounted...2., QALYs..undiscounted...3., QALYs..undiscounted...4., QALYs..undiscounted...5., QALYs..undiscounted...6., QALYs..undiscounted...7., QALYs..undiscounted...8., QALYs..undiscounted...9., dist_FQR, dist_HRR_cure_SensAnalysis))

bc_LY_und <- subset(data_bc, select = c(Life.Years..1., Life.Years..2., Life.Years..3., Life.Years..4., Life.Years..5., Life.Years..6., Life.Years..7., Life.Years..8., Life.Years..9., dist_FQR, dist_HRR_cure_SensAnalysis))

# Generate 1000x4 matrix for cost outcomes per PSA run

bc_totalcost_d <- subset(data_bc, select = c(Total.Cost..discounted...1., Total.Cost..discounted...2., Total.Cost..discounted...3., Total.Cost..discounted...4., Total.Cost..discounted...5., Total.Cost..discounted...6., Total.Cost..discounted...7., Total.Cost..discounted...8., Total.Cost..discounted...9., dist_FQR, dist_HRR_cure_SensAnalysis))

bc_totalcost_und <- subset(data_bc, select = c(Total.Cost..undiscounted...1., Total.Cost..undiscounted...2., Total.Cost..undiscounted...3., Total.Cost..undiscounted...4., Total.Cost..undiscounted...5., Total.Cost..undiscounted...6., Total.Cost..undiscounted...7., Total.Cost..undiscounted...8., Total.Cost..undiscounted...9., dist_FQR, dist_HRR_cure_SensAnalysis))

bc_directmedicalcost_und <- subset(data_bc, select = c(Direct.Medical.Costs..1., Direct.Medical.Costs..2., Direct.Medical.Costs..3., Direct.Medical.Costs..4., Direct.Medical.Costs..5., Direct.Medical.Costs..6., Direct.Medical.Costs..7., Direct.Medical.Costs..8., Direct.Medical.Costs..9., dist_FQR, dist_HRR_cure_SensAnalysis))

bc_directnonmedicalcost_und <- subset(data_bc, select = c(Direct.Nonmedical.Costs..1., Direct.Nonmedical.Costs..2., Direct.Nonmedical.Costs..3., Direct.Nonmedical.Costs..4., Direct.Nonmedical.Costs..5., Direct.Nonmedical.Costs..6., Direct.Nonmedical.Costs..7., Direct.Nonmedical.Costs..8., Direct.Nonmedical.Costs..9., dist_FQR, dist_HRR_cure_SensAnalysis))

bc_indirectcost_und <- subset(data_bc, select = c(Indirect.Costs..1., Indirect.Costs..2., Indirect.Costs..3., Indirect.Costs..4., Indirect.Costs..5., Indirect.Costs..6., Indirect.Costs..7., Indirect.Costs..8., Indirect.Costs..9., dist_FQR, dist_HRR_cure_SensAnalysis))

bc_postfatalcost_und <- subset(data_bc, select = c(Productivity.Loss.2nd.to.Early.Mortality..1., Productivity.Loss.2nd.to.Early.Mortality..2., Productivity.Loss.2nd.to.Early.Mortality..3., Productivity.Loss.2nd.to.Early.Mortality..4., Productivity.Loss.2nd.to.Early.Mortality..5., Productivity.Loss.2nd.to.Early.Mortality..6., Productivity.Loss.2nd.to.Early.Mortality..7., Productivity.Loss.2nd.to.Early.Mortality..8., Productivity.Loss.2nd.to.Early.Mortality..9., dist_FQR, dist_HRR_cure_SensAnalysis))


# Rename variables in each 
bc_QALY_d <- bc_QALY_d %>% 
  rename(
    s1 = QALYs..discounted...1.,
    s2 = QALYs..discounted...2.,
    s3 = QALYs..discounted...3.,
    s4 = QALYs..discounted...4.,
    s5 = QALYs..discounted...5.,
    s6 = QALYs..discounted...6.,
    s7 = QALYs..discounted...7.,
    s8 = QALYs..discounted...8.,
    s9 = QALYs..discounted...9.
    )

bc_QALY_und <- bc_QALY_und %>% 
  rename(
    s1 = QALYs..undiscounted...1.,
    s2 = QALYs..undiscounted...2.,
    s3 = QALYs..undiscounted...3.,
    s4 = QALYs..undiscounted...4.,
    s5 = QALYs..undiscounted...5.,
    s6 = QALYs..undiscounted...6.,
    s7 = QALYs..undiscounted...7.,
    s8 = QALYs..undiscounted...8.,
    s9 = QALYs..undiscounted...9.
    )

bc_LY_und <- bc_LY_und %>% 
  rename(
    s1 = Life.Years..1.,
    s2 = Life.Years..2.,
    s3 = Life.Years..3.,
    s4 = Life.Years..4.,
    s5 = Life.Years..5.,
    s6 = Life.Years..6.,
    s7 = Life.Years..7.,
    s8 = Life.Years..8.,
    s9 = Life.Years..9.
    )

bc_totalcost_d <- bc_totalcost_d %>% 
  rename(
    s1 = Total.Cost..discounted...1.,
    s2 = Total.Cost..discounted...2.,
    s3 = Total.Cost..discounted...3.,
    s4 = Total.Cost..discounted...4.,
    s5 = Total.Cost..discounted...5.,
    s6 = Total.Cost..discounted...6.,
    s7 = Total.Cost..discounted...7.,
    s8 = Total.Cost..discounted...8.,
    s9 = Total.Cost..discounted...9.
    )

bc_totalcost_und <- bc_totalcost_und %>% 
  rename(
    s1 = Total.Cost..undiscounted...1.,
    s2 = Total.Cost..undiscounted...2.,
    s3 = Total.Cost..undiscounted...3.,
    s4 = Total.Cost..undiscounted...4.,
    s5 = Total.Cost..undiscounted...5.,
    s6 = Total.Cost..undiscounted...6.,
    s7 = Total.Cost..undiscounted...7.,
    s8 = Total.Cost..undiscounted...8.,
    s9 = Total.Cost..undiscounted...9.
    )

bc_directmedicalcost_und <- bc_directmedicalcost_und %>% 
  rename(
    s1 = Direct.Medical.Costs..1.,
    s2 = Direct.Medical.Costs..2.,
    s3 = Direct.Medical.Costs..3.,
    s4 = Direct.Medical.Costs..4.,
    s5 = Direct.Medical.Costs..5.,
    s6 = Direct.Medical.Costs..6.,
    s7 = Direct.Medical.Costs..7.,
    s8 = Direct.Medical.Costs..8.,
    s9 = Direct.Medical.Costs..9.
    )

bc_directnonmedicalcost_und <- bc_directnonmedicalcost_und %>% 
  rename(
    s1 = Direct.Nonmedical.Costs..1.,
    s2 = Direct.Nonmedical.Costs..2.,
    s3 = Direct.Nonmedical.Costs..3.,
    s4 = Direct.Nonmedical.Costs..4.,
    s5 = Direct.Nonmedical.Costs..5.,
    s6 = Direct.Nonmedical.Costs..6.,
    s7 = Direct.Nonmedical.Costs..7.,
    s8 = Direct.Nonmedical.Costs..8.,
    s9 = Direct.Nonmedical.Costs..9.
    )

bc_indirectcost_und <- bc_indirectcost_und %>% 
  rename(
    s1 = Indirect.Costs..1.,
    s2 = Indirect.Costs..2.,
    s3 = Indirect.Costs..3.,
    s4 = Indirect.Costs..4.,
    s5 = Indirect.Costs..5.,
    s6 = Indirect.Costs..6.,
    s7 = Indirect.Costs..7.,
    s8 = Indirect.Costs..8.,
    s9 = Indirect.Costs..9.
    )

bc_postfatalcost_und <- bc_postfatalcost_und %>%
  rename(
    s1 = Productivity.Loss.2nd.to.Early.Mortality..1.,
    s2 = Productivity.Loss.2nd.to.Early.Mortality..2.,
    s3 = Productivity.Loss.2nd.to.Early.Mortality..3.,
    s4 = Productivity.Loss.2nd.to.Early.Mortality..4.,
    s5 = Productivity.Loss.2nd.to.Early.Mortality..5.,
    s6 = Productivity.Loss.2nd.to.Early.Mortality..6.,
    s7 = Productivity.Loss.2nd.to.Early.Mortality..7.,
    s8 = Productivity.Loss.2nd.to.Early.Mortality..8.,
    s9 = Productivity.Loss.2nd.to.Early.Mortality..9.
    )


# Calculate incrementals

bc_QALY_d$s1_s7 <- bc_QALY_d$s1 - bc_QALY_d$s7
bc_QALY_d$s2_s7 <- bc_QALY_d$s2 - bc_QALY_d$s7
bc_QALY_d$s3_s7 <- bc_QALY_d$s3 - bc_QALY_d$s7
bc_QALY_d$s4_s7 <- bc_QALY_d$s4 - bc_QALY_d$s7
bc_QALY_d$s5_s7 <- bc_QALY_d$s5 - bc_QALY_d$s7
bc_QALY_d$s6_s7 <- bc_QALY_d$s6 - bc_QALY_d$s7
bc_QALY_d$s8_s7 <- bc_QALY_d$s8 - bc_QALY_d$s7
bc_QALY_d <- round(bc_QALY_d, digits = 4)

bc_QALY_und$s1_s7 <- bc_QALY_und$s1 - bc_QALY_und$s7
bc_QALY_und$s2_s7 <- bc_QALY_und$s2 - bc_QALY_und$s7
bc_QALY_und$s3_s7 <- bc_QALY_und$s3 - bc_QALY_und$s7
bc_QALY_und$s4_s7 <- bc_QALY_und$s4 - bc_QALY_und$s7
bc_QALY_und$s5_s7 <- bc_QALY_und$s5 - bc_QALY_und$s7
bc_QALY_und$s6_s7 <- bc_QALY_und$s6 - bc_QALY_und$s7
bc_QALY_und$s8_s7 <- bc_QALY_und$s8 - bc_QALY_und$s7
bc_QALY_und <- round(bc_QALY_und, digits = 4)

bc_LY_und$s1_s7 <- bc_LY_und$s1 - bc_LY_und$s7
bc_LY_und$s2_s7 <- bc_LY_und$s2 - bc_LY_und$s7
bc_LY_und$s3_s7 <- bc_LY_und$s3 - bc_LY_und$s7
bc_LY_und$s4_s7 <- bc_LY_und$s4 - bc_LY_und$s7
bc_LY_und$s5_s7 <- bc_LY_und$s5 - bc_LY_und$s7
bc_LY_und$s6_s7 <- bc_LY_und$s6 - bc_LY_und$s7
bc_LY_und$s8_s7 <- bc_LY_und$s8 - bc_LY_und$s7
bc_LY_und <- round(bc_LY_und, digits = 4)

bc_totalcost_d$s1_s7 <- bc_totalcost_d$s1 - bc_totalcost_d$s7
bc_totalcost_d$s2_s7 <- bc_totalcost_d$s2 - bc_totalcost_d$s7
bc_totalcost_d$s3_s7 <- bc_totalcost_d$s3 - bc_totalcost_d$s7
bc_totalcost_d$s4_s7 <- bc_totalcost_d$s4 - bc_totalcost_d$s7
bc_totalcost_d$s5_s7 <- bc_totalcost_d$s5 - bc_totalcost_d$s7
bc_totalcost_d$s6_s7 <- bc_totalcost_d$s6 - bc_totalcost_d$s7
bc_totalcost_d$s8_s7 <- bc_totalcost_d$s8 - bc_totalcost_d$s7
bc_totalcost_d <- round(bc_totalcost_d, digits = 4)

bc_totalcost_und$s1_s7 <- bc_totalcost_und$s1 - bc_totalcost_und$s7
bc_totalcost_und$s2_s7 <- bc_totalcost_und$s2 - bc_totalcost_und$s7
bc_totalcost_und$s3_s7 <- bc_totalcost_und$s3 - bc_totalcost_und$s7
bc_totalcost_und$s4_s7 <- bc_totalcost_und$s4 - bc_totalcost_und$s7
bc_totalcost_und$s5_s7 <- bc_totalcost_und$s5 - bc_totalcost_und$s7
bc_totalcost_und$s6_s7 <- bc_totalcost_und$s6 - bc_totalcost_und$s7
bc_totalcost_und$s8_s7 <- bc_totalcost_und$s8 - bc_totalcost_und$s7
bc_totalcost_und <- round(bc_totalcost_und, digits = 4)

bc_directmedicalcost_und$s1_s7 <- bc_directmedicalcost_und$s1 - bc_directmedicalcost_und$s7
bc_directmedicalcost_und$s2_s7 <- bc_directmedicalcost_und$s2 - bc_directmedicalcost_und$s7
bc_directmedicalcost_und$s3_s7 <- bc_directmedicalcost_und$s3 - bc_directmedicalcost_und$s7
bc_directmedicalcost_und$s4_s7 <- bc_directmedicalcost_und$s4 - bc_directmedicalcost_und$s7
bc_directmedicalcost_und$s5_s7 <- bc_directmedicalcost_und$s5 - bc_directmedicalcost_und$s7
bc_directmedicalcost_und$s6_s7 <- bc_directmedicalcost_und$s6 - bc_directmedicalcost_und$s7
bc_directmedicalcost_und$s8_s7 <- bc_directmedicalcost_und$s8 - bc_directmedicalcost_und$s7
bc_directmedicalcost_und <- round(bc_directmedicalcost_und, digits = 4)

bc_directnonmedicalcost_und$s1_s7 <- bc_directnonmedicalcost_und$s1 - bc_directnonmedicalcost_und$s7
bc_directnonmedicalcost_und$s2_s7 <- bc_directnonmedicalcost_und$s2 - bc_directnonmedicalcost_und$s7
bc_directnonmedicalcost_und$s3_s7 <- bc_directnonmedicalcost_und$s3 - bc_directnonmedicalcost_und$s7
bc_directnonmedicalcost_und$s4_s7 <- bc_directnonmedicalcost_und$s4 - bc_directnonmedicalcost_und$s7
bc_directnonmedicalcost_und$s5_s7 <- bc_directnonmedicalcost_und$s5 - bc_directnonmedicalcost_und$s7
bc_directnonmedicalcost_und$s6_s7 <- bc_directnonmedicalcost_und$s6 - bc_directnonmedicalcost_und$s7
bc_directnonmedicalcost_und$s8_s7 <- bc_directnonmedicalcost_und$s8 - bc_directnonmedicalcost_und$s7
bc_directnonmedicalcost_und <- round(bc_directnonmedicalcost_und, digits = 4)

bc_indirectcost_und$s1_s7 <- bc_indirectcost_und$s1 - bc_indirectcost_und$s7
bc_indirectcost_und$s2_s7 <- bc_indirectcost_und$s2 - bc_indirectcost_und$s7
bc_indirectcost_und$s3_s7 <- bc_indirectcost_und$s3 - bc_indirectcost_und$s7
bc_indirectcost_und$s4_s7 <- bc_indirectcost_und$s4 - bc_indirectcost_und$s7
bc_indirectcost_und$s5_s7 <- bc_indirectcost_und$s5 - bc_indirectcost_und$s7
bc_indirectcost_und$s6_s7 <- bc_indirectcost_und$s6 - bc_indirectcost_und$s7
bc_indirectcost_und$s8_s7 <- bc_indirectcost_und$s8 - bc_indirectcost_und$s7
bc_indirectcost_und <- round(bc_indirectcost_und, digits = 4)

bc_postfatalcost_und$s1_s7 <- bc_postfatalcost_und$s1 - bc_postfatalcost_und$s7
bc_postfatalcost_und$s2_s7 <- bc_postfatalcost_und$s2 - bc_postfatalcost_und$s7
bc_postfatalcost_und$s3_s7 <- bc_postfatalcost_und$s3 - bc_postfatalcost_und$s7
bc_postfatalcost_und$s4_s7 <- bc_postfatalcost_und$s4 - bc_postfatalcost_und$s7
bc_postfatalcost_und$s5_s7 <- bc_postfatalcost_und$s5 - bc_postfatalcost_und$s7
bc_postfatalcost_und$s6_s7 <- bc_postfatalcost_und$s6 - bc_postfatalcost_und$s7
bc_postfatalcost_und$s8_s7 <- bc_postfatalcost_und$s8 - bc_postfatalcost_und$s7
bc_postfatalcost_und <- round(bc_postfatalcost_und, digits = 4)

# Now also calculate NMB and NHB
bc_NMB <- data.frame(bc_QALY_d)

bc_NMB$s1 <- bc_QALY_d$s1*WTP - bc_totalcost_d$s1
bc_NMB$s2 <- bc_QALY_d$s2*WTP - bc_totalcost_d$s2
bc_NMB$s3 <- bc_QALY_d$s3*WTP - bc_totalcost_d$s3
bc_NMB$s4 <- bc_QALY_d$s4*WTP - bc_totalcost_d$s4
bc_NMB$s5 <- bc_QALY_d$s5*WTP - bc_totalcost_d$s5
bc_NMB$s6 <- bc_QALY_d$s6*WTP - bc_totalcost_d$s6
bc_NMB$s7 <- bc_QALY_d$s7*WTP - bc_totalcost_d$s7
bc_NMB$s8 <- bc_QALY_d$s8*WTP - bc_totalcost_d$s8
bc_NMB$s9 <- bc_QALY_d$s9*WTP - bc_totalcost_d$s9

bc_NHB <- data.frame(bc_QALY_d)

bc_NHB$s1 <- bc_QALY_d$s1 - bc_totalcost_d$s1/WTP
bc_NHB$s2 <- bc_QALY_d$s2 - bc_totalcost_d$s2/WTP
bc_NHB$s3 <- bc_QALY_d$s3 - bc_totalcost_d$s3/WTP
bc_NHB$s4 <- bc_QALY_d$s4 - bc_totalcost_d$s4/WTP
bc_NHB$s5 <- bc_QALY_d$s5 - bc_totalcost_d$s5/WTP
bc_NHB$s6 <- bc_QALY_d$s6 - bc_totalcost_d$s6/WTP
bc_NHB$s7 <- bc_QALY_d$s7 - bc_totalcost_d$s7/WTP
bc_NHB$s8 <- bc_QALY_d$s8 - bc_totalcost_d$s8/WTP
bc_NHB$s9 <- bc_QALY_d$s9 - bc_totalcost_d$s9/WTP

# Incremental NMB
bc_NMB$s1_s7 <- bc_NMB$s1 - bc_NMB$s7
bc_NMB$s2_s7 <- bc_NMB$s2 - bc_NMB$s7
bc_NMB$s3_s7 <- bc_NMB$s3 - bc_NMB$s7
bc_NMB$s4_s7 <- bc_NMB$s4 - bc_NMB$s7
bc_NMB$s5_s7 <- bc_NMB$s5 - bc_NMB$s7
bc_NMB$s6_s7 <- bc_NMB$s6 - bc_NMB$s7
bc_NMB$s8_s7 <- bc_NMB$s8 - bc_NMB$s7
bc_NMB <- round(bc_NMB, digits = 4)

# Incremental NHB
bc_NHB$s1_s7 <- bc_NHB$s1 - bc_NHB$s7
bc_NHB$s2_s7 <- bc_NHB$s2 - bc_NHB$s7
bc_NHB$s3_s7 <- bc_NHB$s3 - bc_NHB$s7
bc_NHB$s4_s7 <- bc_NHB$s4 - bc_NHB$s7
bc_NHB$s5_s7 <- bc_NHB$s5 - bc_NHB$s7
bc_NHB$s6_s7 <- bc_NHB$s6 - bc_NHB$s7
bc_NHB$s8_s7 <- bc_NHB$s8 - bc_NHB$s7
bc_NHB <- round(bc_NHB, digits = 4)

data.list <- c(bc_QALY_d, bc_QALY_und, bc_LY_und, bc_totalcost_d, bc_totalcost_und, 
               bc_directmedicalcost_und, bc_directnonmedicalcost_und,
               bc_indirectcost_und, bc_postfatalcost_und, bc_NMB, bc_NHB)
return(data.list)
}

```

```{r postprocessing function 2 DR outcomes, echo = FALSE}

fn_process_droutcomes <- function(data_bc){
bc_drduration_all <- subset(data_bc, select = c(
  t_drduration_amikacin..1.,
  t_drduration_amikacin..2.,
  t_drduration_amikacin..3.,
  t_drduration_amikacin..4.,
  t_drduration_amikacin..5.,
  t_drduration_amikacin..6.,
  t_drduration_amikacin..7.,
  t_drduration_amikacin..8.,
  t_drduration_amikacin..9.,
  t_drduration_bed..1.,
  t_drduration_bed..2.,
  t_drduration_bed..3.,
  t_drduration_bed..4.,
  t_drduration_bed..5.,
  t_drduration_bed..6.,
  t_drduration_bed..7.,
  t_drduration_bed..8.,
  t_drduration_bed..9.,
  t_drduration_clofaz..1.,
  t_drduration_clofaz..2.,
  t_drduration_clofaz..3.,
  t_drduration_clofaz..4.,
  t_drduration_clofaz..5.,
  t_drduration_clofaz..6.,
  t_drduration_clofaz..7.,
  t_drduration_clofaz..8.,
  t_drduration_clofaz..9.,
  t_drduration_cyclos..1.,
  t_drduration_cyclos..2.,
  t_drduration_cyclos..3.,
  t_drduration_cyclos..4.,
  t_drduration_cyclos..5.,
  t_drduration_cyclos..6.,
  t_drduration_cyclos..7.,
  t_drduration_cyclos..8.,
  t_drduration_cyclos..9.,
  t_drduration_del..1.,
  t_drduration_del..2.,
  t_drduration_del..3.,
  t_drduration_del..4.,
  t_drduration_del..5.,
  t_drduration_del..6.,
  t_drduration_del..7.,
  t_drduration_del..8.,
  t_drduration_del..9.,
  t_drduration_ethambutol..1.,
  t_drduration_ethambutol..2.,
  t_drduration_ethambutol..3.,
  t_drduration_ethambutol..4.,
  t_drduration_ethambutol..5.,
  t_drduration_ethambutol..6.,
  t_drduration_ethambutol..7.,
  t_drduration_ethambutol..8.,
  t_drduration_ethambutol..9.,
  t_drduration_ethionamide..1.,
  t_drduration_ethionamide..2.,
  t_drduration_ethionamide..3.,
  t_drduration_ethionamide..4.,
  t_drduration_ethionamide..5.,
  t_drduration_ethionamide..6.,
  t_drduration_ethionamide..7.,
  t_drduration_ethionamide..8.,
  t_drduration_ethionamide..9.,
  t_drduration_isoniazid..1.,
  t_drduration_isoniazid..2.,
  t_drduration_isoniazid..3.,
  t_drduration_isoniazid..4.,
  t_drduration_isoniazid..5.,
  t_drduration_isoniazid..6.,
  t_drduration_isoniazid..7.,
  t_drduration_isoniazid..8.,
  t_drduration_isoniazid..9.,
  t_drduration_lin..1.,
  t_drduration_lin..2.,
  t_drduration_lin..3.,
  t_drduration_lin..4.,
  t_drduration_lin..5.,
  t_drduration_lin..6.,
  t_drduration_lin..7.,
  t_drduration_lin..8.,
  t_drduration_lin..9.,
  t_drduration_mox..1.,
  t_drduration_mox..2.,
  t_drduration_mox..3.,
  t_drduration_mox..4.,
  t_drduration_mox..5.,
  t_drduration_mox..6.,
  t_drduration_mox..7.,
  t_drduration_mox..8.,
  t_drduration_mox..9.,
  t_drduration_pretomanid..1.,
  t_drduration_pretomanid..2.,
  t_drduration_pretomanid..3.,
  t_drduration_pretomanid..4.,
  t_drduration_pretomanid..5.,
  t_drduration_pretomanid..6.,
  t_drduration_pretomanid..7.,
  t_drduration_pretomanid..8.,
  t_drduration_pretomanid..9.,
  t_drduration_pyrazinamide..1.,
  t_drduration_pyrazinamide..2.,
  t_drduration_pyrazinamide..3.,
  t_drduration_pyrazinamide..4.,
  t_drduration_pyrazinamide..5.,
  t_drduration_pyrazinamide..6.,
  t_drduration_pyrazinamide..7.,
  t_drduration_pyrazinamide..8.,
  t_drduration_pyrazinamide..9.,
  t_duration_rrtb..1.,
  t_duration_rrtb..2.,
  t_duration_rrtb..3.,
  t_duration_rrtb..4.,
  t_duration_rrtb..5.,
  t_duration_rrtb..6.,
  t_duration_rrtb..7.,
  t_duration_rrtb..8.,
  t_duration_rrtb..9.
))

bc_drduration_activeuntr <- subset(data_bc, select = c(
  t_drduration_activeuntreated_amikacin..1.,
  t_drduration_activeuntreated_amikacin..2.,
  t_drduration_activeuntreated_amikacin..3.,
  t_drduration_activeuntreated_amikacin..4.,
  t_drduration_activeuntreated_amikacin..5.,
  t_drduration_activeuntreated_amikacin..6.,
  t_drduration_activeuntreated_amikacin..7.,
  t_drduration_activeuntreated_amikacin..8.,
  t_drduration_activeuntreated_amikacin..9.,
  t_drduration_activeuntreated_bed..1.,
  t_drduration_activeuntreated_bed..2.,
  t_drduration_activeuntreated_bed..3.,
  t_drduration_activeuntreated_bed..4.,
  t_drduration_activeuntreated_bed..5.,
  t_drduration_activeuntreated_bed..6.,
  t_drduration_activeuntreated_bed..7.,
  t_drduration_activeuntreated_bed..8.,
  t_drduration_activeuntreated_bed..9.,
  t_drduration_activeuntreated_clofaz..1.,
  t_drduration_activeuntreated_clofaz..2.,
  t_drduration_activeuntreated_clofaz..3.,
  t_drduration_activeuntreated_clofaz..4.,
  t_drduration_activeuntreated_clofaz..5.,
  t_drduration_activeuntreated_clofaz..6.,
  t_drduration_activeuntreated_clofaz..7.,
  t_drduration_activeuntreated_clofaz..8.,
  t_drduration_activeuntreated_clofaz..9.,
  t_drduration_activeuntreated_cyclos..1.,
  t_drduration_activeuntreated_cyclos..2.,
  t_drduration_activeuntreated_cyclos..3.,
  t_drduration_activeuntreated_cyclos..4.,
  t_drduration_activeuntreated_cyclos..5.,
  t_drduration_activeuntreated_cyclos..6.,
  t_drduration_activeuntreated_cyclos..7.,
  t_drduration_activeuntreated_cyclos..8.,
  t_drduration_activeuntreated_cyclos..9.,
  t_drduration_activeuntreated_del..1.,
  t_drduration_activeuntreated_del..2.,
  t_drduration_activeuntreated_del..3.,
  t_drduration_activeuntreated_del..4.,
  t_drduration_activeuntreated_del..5.,
  t_drduration_activeuntreated_del..6.,
  t_drduration_activeuntreated_del..7.,
  t_drduration_activeuntreated_del..8.,
  t_drduration_activeuntreated_del..9.,
  t_drduration_activeuntreated_ethambutol..1.,
  t_drduration_activeuntreated_ethambutol..2.,
  t_drduration_activeuntreated_ethambutol..3.,
  t_drduration_activeuntreated_ethambutol..4.,
  t_drduration_activeuntreated_ethambutol..5.,
  t_drduration_activeuntreated_ethambutol..6.,
  t_drduration_activeuntreated_ethambutol..7.,
  t_drduration_activeuntreated_ethambutol..8.,
  t_drduration_activeuntreated_ethambutol..9.,
  t_drduration_activeuntreated_ethionamide..1.,
  t_drduration_activeuntreated_ethionamide..2.,
  t_drduration_activeuntreated_ethionamide..3.,
  t_drduration_activeuntreated_ethionamide..4.,
  t_drduration_activeuntreated_ethionamide..5.,
  t_drduration_activeuntreated_ethionamide..6.,
  t_drduration_activeuntreated_ethionamide..7.,
  t_drduration_activeuntreated_ethionamide..8.,
  t_drduration_activeuntreated_ethionamide..9.,
  t_drduration_activeuntreated_isoniazid..1.,
  t_drduration_activeuntreated_isoniazid..2.,
  t_drduration_activeuntreated_isoniazid..3.,
  t_drduration_activeuntreated_isoniazid..4.,
  t_drduration_activeuntreated_isoniazid..5.,
  t_drduration_activeuntreated_isoniazid..6.,
  t_drduration_activeuntreated_isoniazid..7.,
  t_drduration_activeuntreated_isoniazid..8.,
  t_drduration_activeuntreated_isoniazid..9.,
  t_drduration_activeuntreated_lin..1.,
  t_drduration_activeuntreated_lin..2.,
  t_drduration_activeuntreated_lin..3.,
  t_drduration_activeuntreated_lin..4.,
  t_drduration_activeuntreated_lin..5.,
  t_drduration_activeuntreated_lin..6.,
  t_drduration_activeuntreated_lin..7.,
  t_drduration_activeuntreated_lin..8.,
  t_drduration_activeuntreated_lin..9.,
  t_drduration_activeuntreated_mox..1.,
  t_drduration_activeuntreated_mox..2.,
  t_drduration_activeuntreated_mox..3.,
  t_drduration_activeuntreated_mox..4.,
  t_drduration_activeuntreated_mox..5.,
  t_drduration_activeuntreated_mox..6.,
  t_drduration_activeuntreated_mox..7.,
  t_drduration_activeuntreated_mox..8.,
  t_drduration_activeuntreated_mox..9.,
  t_drduration_activeuntreated_pretomanid..1.,
  t_drduration_activeuntreated_pretomanid..2.,
  t_drduration_activeuntreated_pretomanid..3.,
  t_drduration_activeuntreated_pretomanid..4.,
  t_drduration_activeuntreated_pretomanid..5.,
  t_drduration_activeuntreated_pretomanid..6.,
  t_drduration_activeuntreated_pretomanid..7.,
  t_drduration_activeuntreated_pretomanid..8.,
  t_drduration_activeuntreated_pretomanid..9.,
  t_drduration_activeuntreated_pyrazinamide..1.,
  t_drduration_activeuntreated_pyrazinamide..2.,
  t_drduration_activeuntreated_pyrazinamide..3.,
  t_drduration_activeuntreated_pyrazinamide..4.,
  t_drduration_activeuntreated_pyrazinamide..5.,
  t_drduration_activeuntreated_pyrazinamide..6.,
  t_drduration_activeuntreated_pyrazinamide..7.,
  t_drduration_activeuntreated_pyrazinamide..8.,
  t_drduration_activeuntreated_pyrazinamide..9.,
  t_duration_activetb_untr..1.,
  t_duration_activetb_untr..2.,
  t_duration_activetb_untr..3.,
  t_duration_activetb_untr..4.,
  t_duration_activetb_untr..5.,
  t_duration_activetb_untr..6.,
  t_duration_activetb_untr..7.,
  t_duration_activetb_untr..8.,
  t_duration_activetb_untr..9.
))

## total duration
# s1 vs s7 
bc_drduration_all$amikacin_s1_s7 <- bc_drduration_all$t_drduration_amikacin..1. - bc_drduration_all$t_drduration_amikacin..7.
bc_drduration_all$bed_s1_s7 <- bc_drduration_all$t_drduration_bed..1. - bc_drduration_all$t_drduration_bed..7.
bc_drduration_all$clofaz_s1_s7 <- bc_drduration_all$t_drduration_clofaz..1. - bc_drduration_all$t_drduration_clofaz..7.
bc_drduration_all$cyclos_s1_s7 <- bc_drduration_all$t_drduration_cyclos..1. - bc_drduration_all$t_drduration_cyclos..7.
bc_drduration_all$del_s1_s7 <- bc_drduration_all$t_drduration_del..1. - bc_drduration_all$t_drduration_del..7.
bc_drduration_all$ethambutol_s1_s7 <- bc_drduration_all$t_drduration_ethambutol..1. - bc_drduration_all$t_drduration_ethambutol..7.
bc_drduration_all$ethionamide_s1_s7 <- bc_drduration_all$t_drduration_ethionamide..1. - bc_drduration_all$t_drduration_ethionamide..7.
bc_drduration_all$isoniazid_s1_s7 <- bc_drduration_all$t_drduration_isoniazid..1. - bc_drduration_all$t_drduration_isoniazid..7.
bc_drduration_all$lin_s1_s7 <- bc_drduration_all$t_drduration_lin..1. - bc_drduration_all$t_drduration_lin..7.
bc_drduration_all$mox_s1_s7 <- bc_drduration_all$t_drduration_mox..1. - bc_drduration_all$t_drduration_mox..7.
bc_drduration_all$pretomanid_s1_s7 <- bc_drduration_all$t_drduration_pretomanid..1. - bc_drduration_all$t_drduration_pretomanid..7.
bc_drduration_all$pyrazinamide_s1_s7 <- bc_drduration_all$t_drduration_pyrazinamide..1. - bc_drduration_all$t_drduration_pyrazinamide..7.
bc_drduration_all$rif_s1_s7 <- bc_drduration_all$t_duration_rrtb..1. - bc_drduration_all$t_duration_rrtb..7.

# s2 vs s7 
bc_drduration_all$amikacin_s2_s7 <- bc_drduration_all$t_drduration_amikacin..2. - bc_drduration_all$t_drduration_amikacin..7.
bc_drduration_all$bed_s2_s7 <- bc_drduration_all$t_drduration_bed..2. - bc_drduration_all$t_drduration_bed..7.
bc_drduration_all$clofaz_s2_s7 <- bc_drduration_all$t_drduration_clofaz..2. - bc_drduration_all$t_drduration_clofaz..7.
bc_drduration_all$cyclos_s2_s7 <- bc_drduration_all$t_drduration_cyclos..2. - bc_drduration_all$t_drduration_cyclos..7.
bc_drduration_all$del_s2_s7 <- bc_drduration_all$t_drduration_del..2. - bc_drduration_all$t_drduration_del..7.
bc_drduration_all$ethambutol_s2_s7 <- bc_drduration_all$t_drduration_ethambutol..2. - bc_drduration_all$t_drduration_ethambutol..7.
bc_drduration_all$ethionamide_s2_s7 <- bc_drduration_all$t_drduration_ethionamide..2. - bc_drduration_all$t_drduration_ethionamide..7.
bc_drduration_all$isoniazid_s2_s7 <- bc_drduration_all$t_drduration_isoniazid..2. - bc_drduration_all$t_drduration_isoniazid..7.
bc_drduration_all$lin_s2_s7 <- bc_drduration_all$t_drduration_lin..2. - bc_drduration_all$t_drduration_lin..7.
bc_drduration_all$mox_s2_s7 <- bc_drduration_all$t_drduration_mox..2. - bc_drduration_all$t_drduration_mox..7.
bc_drduration_all$pretomanid_s2_s7 <- bc_drduration_all$t_drduration_pretomanid..2. - bc_drduration_all$t_drduration_pretomanid..7.
bc_drduration_all$pyrazinamide_s2_s7 <- bc_drduration_all$t_drduration_pyrazinamide..2. - bc_drduration_all$t_drduration_pyrazinamide..7.
bc_drduration_all$rif_s2_s7 <- bc_drduration_all$t_duration_rrtb..2. - bc_drduration_all$t_duration_rrtb..7.

#s3 vs s7
bc_drduration_all$amikacin_s3_s7 <- bc_drduration_all$t_drduration_amikacin..3. - bc_drduration_all$t_drduration_amikacin..7.
bc_drduration_all$bed_s3_s7 <- bc_drduration_all$t_drduration_bed..3. - bc_drduration_all$t_drduration_bed..7.
bc_drduration_all$clofaz_s3_s7 <- bc_drduration_all$t_drduration_clofaz..3. - bc_drduration_all$t_drduration_clofaz..7.
bc_drduration_all$cyclos_s3_s7 <- bc_drduration_all$t_drduration_cyclos..3. - bc_drduration_all$t_drduration_cyclos..7.
bc_drduration_all$del_s3_s7 <- bc_drduration_all$t_drduration_del..3. - bc_drduration_all$t_drduration_del..7.
bc_drduration_all$ethambutol_s3_s7 <- bc_drduration_all$t_drduration_ethambutol..3. - bc_drduration_all$t_drduration_ethambutol..7.
bc_drduration_all$ethionamide_s3_s7 <- bc_drduration_all$t_drduration_ethionamide..3. - bc_drduration_all$t_drduration_ethionamide..7.
bc_drduration_all$isoniazid_s3_s7 <- bc_drduration_all$t_drduration_isoniazid..3. - bc_drduration_all$t_drduration_isoniazid..7.
bc_drduration_all$lin_s3_s7 <- bc_drduration_all$t_drduration_lin..3. - bc_drduration_all$t_drduration_lin..7.
bc_drduration_all$mox_s3_s7 <- bc_drduration_all$t_drduration_mox..3. - bc_drduration_all$t_drduration_mox..7.
bc_drduration_all$pretomanid_s3_s7 <- bc_drduration_all$t_drduration_pretomanid..3. - bc_drduration_all$t_drduration_pretomanid..7.
bc_drduration_all$pyrazinamide_s3_s7 <- bc_drduration_all$t_drduration_pyrazinamide..3. - bc_drduration_all$t_drduration_pyrazinamide..7.
bc_drduration_all$rif_s3_s7 <- bc_drduration_all$t_duration_rrtb..3. - bc_drduration_all$t_duration_rrtb..7.

#s4 vs s7
bc_drduration_all$amikacin_s4_s7 <- bc_drduration_all$t_drduration_amikacin..4. - bc_drduration_all$t_drduration_amikacin..7.
bc_drduration_all$bed_s4_s7 <- bc_drduration_all$t_drduration_bed..4. - bc_drduration_all$t_drduration_bed..7.
bc_drduration_all$clofaz_s4_s7 <- bc_drduration_all$t_drduration_clofaz..4. - bc_drduration_all$t_drduration_clofaz..7.
bc_drduration_all$cyclos_s4_s7 <- bc_drduration_all$t_drduration_cyclos..4. - bc_drduration_all$t_drduration_cyclos..7.
bc_drduration_all$del_s4_s7 <- bc_drduration_all$t_drduration_del..4. - bc_drduration_all$t_drduration_del..7.
bc_drduration_all$ethambutol_s4_s7 <- bc_drduration_all$t_drduration_ethambutol..4. - bc_drduration_all$t_drduration_ethambutol..7.
bc_drduration_all$ethionamide_s4_s7 <- bc_drduration_all$t_drduration_ethionamide..4. - bc_drduration_all$t_drduration_ethionamide..7.
bc_drduration_all$isoniazid_s4_s7 <- bc_drduration_all$t_drduration_isoniazid..4. - bc_drduration_all$t_drduration_isoniazid..7.
bc_drduration_all$lin_s4_s7 <- bc_drduration_all$t_drduration_lin..4. - bc_drduration_all$t_drduration_lin..7.
bc_drduration_all$mox_s4_s7 <- bc_drduration_all$t_drduration_mox..4. - bc_drduration_all$t_drduration_mox..7.
bc_drduration_all$pretomanid_s4_s7 <- bc_drduration_all$t_drduration_pretomanid..4. - bc_drduration_all$t_drduration_pretomanid..7.
bc_drduration_all$pyrazinamide_s4_s7 <- bc_drduration_all$t_drduration_pyrazinamide..4. - bc_drduration_all$t_drduration_pyrazinamide..7.
bc_drduration_all$rif_s4_s7 <- bc_drduration_all$t_duration_rrtb..4. - bc_drduration_all$t_duration_rrtb..7.

#s5 vs s7
bc_drduration_all$amikacin_s5_s7 <- bc_drduration_all$t_drduration_amikacin..5. - bc_drduration_all$t_drduration_amikacin..7.
bc_drduration_all$bed_s5_s7 <- bc_drduration_all$t_drduration_bed..5. - bc_drduration_all$t_drduration_bed..7.
bc_drduration_all$clofaz_s5_s7 <- bc_drduration_all$t_drduration_clofaz..5. - bc_drduration_all$t_drduration_clofaz..7.
bc_drduration_all$cyclos_s5_s7 <- bc_drduration_all$t_drduration_cyclos..5. - bc_drduration_all$t_drduration_cyclos..7.
bc_drduration_all$del_s5_s7 <- bc_drduration_all$t_drduration_del..5. - bc_drduration_all$t_drduration_del..7.
bc_drduration_all$ethambutol_s5_s7 <- bc_drduration_all$t_drduration_ethambutol..5. - bc_drduration_all$t_drduration_ethambutol..7.
bc_drduration_all$ethionamide_s5_s7 <- bc_drduration_all$t_drduration_ethionamide..5. - bc_drduration_all$t_drduration_ethionamide..7.
bc_drduration_all$isoniazid_s5_s7 <- bc_drduration_all$t_drduration_isoniazid..5. - bc_drduration_all$t_drduration_isoniazid..7.
bc_drduration_all$lin_s5_s7 <- bc_drduration_all$t_drduration_lin..5. - bc_drduration_all$t_drduration_lin..7.
bc_drduration_all$mox_s5_s7 <- bc_drduration_all$t_drduration_mox..5. - bc_drduration_all$t_drduration_mox..7.
bc_drduration_all$pretomanid_s5_s7 <- bc_drduration_all$t_drduration_pretomanid..5. - bc_drduration_all$t_drduration_pretomanid..7.
bc_drduration_all$pyrazinamide_s5_s7 <- bc_drduration_all$t_drduration_pyrazinamide..5. - bc_drduration_all$t_drduration_pyrazinamide..7.
bc_drduration_all$rif_s5_s7 <- bc_drduration_all$t_duration_rrtb..5. - bc_drduration_all$t_duration_rrtb..7.

#s6 vs s7
bc_drduration_all$amikacin_s6_s7 <- bc_drduration_all$t_drduration_amikacin..6. - bc_drduration_all$t_drduration_amikacin..7.
bc_drduration_all$bed_s6_s7 <- bc_drduration_all$t_drduration_bed..6. - bc_drduration_all$t_drduration_bed..7.
bc_drduration_all$clofaz_s6_s7 <- bc_drduration_all$t_drduration_clofaz..6. - bc_drduration_all$t_drduration_clofaz..7.
bc_drduration_all$cyclos_s6_s7 <- bc_drduration_all$t_drduration_cyclos..6. - bc_drduration_all$t_drduration_cyclos..7.
bc_drduration_all$del_s6_s7 <- bc_drduration_all$t_drduration_del..6. - bc_drduration_all$t_drduration_del..7.
bc_drduration_all$ethambutol_s6_s7 <- bc_drduration_all$t_drduration_ethambutol..6. - bc_drduration_all$t_drduration_ethambutol..7.
bc_drduration_all$ethionamide_s6_s7 <- bc_drduration_all$t_drduration_ethionamide..6. - bc_drduration_all$t_drduration_ethionamide..7.
bc_drduration_all$isoniazid_s6_s7 <- bc_drduration_all$t_drduration_isoniazid..6. - bc_drduration_all$t_drduration_isoniazid..7.
bc_drduration_all$lin_s6_s7 <- bc_drduration_all$t_drduration_lin..6. - bc_drduration_all$t_drduration_lin..7.
bc_drduration_all$mox_s6_s7 <- bc_drduration_all$t_drduration_mox..6. - bc_drduration_all$t_drduration_mox..7.
bc_drduration_all$pretomanid_s6_s7 <- bc_drduration_all$t_drduration_pretomanid..6. - bc_drduration_all$t_drduration_pretomanid..7.
bc_drduration_all$pyrazinamide_s6_s7 <- bc_drduration_all$t_drduration_pyrazinamide..6. - bc_drduration_all$t_drduration_pyrazinamide..7.
bc_drduration_all$rif_s6_s7 <- bc_drduration_all$t_duration_rrtb..6. - bc_drduration_all$t_duration_rrtb..7.

#s8 vs s7
bc_drduration_all$amikacin_s8_s7 <- bc_drduration_all$t_drduration_amikacin..8. - bc_drduration_all$t_drduration_amikacin..7.
bc_drduration_all$bed_s8_s7 <- bc_drduration_all$t_drduration_bed..8. - bc_drduration_all$t_drduration_bed..7.
bc_drduration_all$clofaz_s8_s7 <- bc_drduration_all$t_drduration_clofaz..8. - bc_drduration_all$t_drduration_clofaz..7.
bc_drduration_all$cyclos_s8_s7 <- bc_drduration_all$t_drduration_cyclos..8. - bc_drduration_all$t_drduration_cyclos..7.
bc_drduration_all$del_s8_s7 <- bc_drduration_all$t_drduration_del..8. - bc_drduration_all$t_drduration_del..7.
bc_drduration_all$ethambutol_s8_s7 <- bc_drduration_all$t_drduration_ethambutol..8. - bc_drduration_all$t_drduration_ethambutol..7.
bc_drduration_all$ethionamide_s8_s7 <- bc_drduration_all$t_drduration_ethionamide..8. - bc_drduration_all$t_drduration_ethionamide..7.
bc_drduration_all$isoniazid_s8_s7 <- bc_drduration_all$t_drduration_isoniazid..8. - bc_drduration_all$t_drduration_isoniazid..7.
bc_drduration_all$lin_s8_s7 <- bc_drduration_all$t_drduration_lin..8. - bc_drduration_all$t_drduration_lin..7.
bc_drduration_all$mox_s8_s7 <- bc_drduration_all$t_drduration_mox..8. - bc_drduration_all$t_drduration_mox..7.
bc_drduration_all$pretomanid_s8_s7 <- bc_drduration_all$t_drduration_pretomanid..8. - bc_drduration_all$t_drduration_pretomanid..7.
bc_drduration_all$pyrazinamide_s8_s7 <- bc_drduration_all$t_drduration_pyrazinamide..8. - bc_drduration_all$t_drduration_pyrazinamide..7.
bc_drduration_all$rif_s8_s7 <- bc_drduration_all$t_duration_rrtb..8. - bc_drduration_all$t_duration_rrtb..7.


# only among those with active tb, untreated

# s1 vs s7 
bc_drduration_activeuntr$amikacin_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.
bc_drduration_activeuntr$bed_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_bed..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.
bc_drduration_activeuntr$clofaz_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.
bc_drduration_activeuntr$cyclos_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.
bc_drduration_activeuntr$del_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_del..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.
bc_drduration_activeuntr$ethambutol_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.
bc_drduration_activeuntr$ethionamide_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.
bc_drduration_activeuntr$isoniazid_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.
bc_drduration_activeuntr$lin_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_lin..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.
bc_drduration_activeuntr$mox_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_mox..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.
bc_drduration_activeuntr$pretomanid_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.
bc_drduration_activeuntr$pyrazinamide_s1_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..1. - bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.
bc_drduration_activeuntr$rif_s1_s7 <- bc_drduration_activeuntr$t_duration_activetb_untr..1. - bc_drduration_activeuntr$t_duration_activetb_untr..7.

# s2 vs s7 
bc_drduration_activeuntr$amikacin_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.
bc_drduration_activeuntr$bed_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_bed..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.
bc_drduration_activeuntr$clofaz_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.
bc_drduration_activeuntr$cyclos_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.
bc_drduration_activeuntr$del_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_del..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.
bc_drduration_activeuntr$ethambutol_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.
bc_drduration_activeuntr$ethionamide_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.
bc_drduration_activeuntr$isoniazid_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.
bc_drduration_activeuntr$lin_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_lin..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.
bc_drduration_activeuntr$mox_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_mox..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.
bc_drduration_activeuntr$pretomanid_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.
bc_drduration_activeuntr$pyrazinamide_s2_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..2. - bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.
bc_drduration_activeuntr$rif_s2_s7 <- bc_drduration_activeuntr$t_duration_activetb_untr..2. - bc_drduration_activeuntr$t_duration_activetb_untr..7.

#s3 vs s7
bc_drduration_activeuntr$amikacin_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.
bc_drduration_activeuntr$bed_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_bed..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.
bc_drduration_activeuntr$clofaz_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.
bc_drduration_activeuntr$cyclos_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.
bc_drduration_activeuntr$del_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_del..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.
bc_drduration_activeuntr$ethambutol_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.
bc_drduration_activeuntr$ethionamide_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.
bc_drduration_activeuntr$isoniazid_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.
bc_drduration_activeuntr$lin_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_lin..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.
bc_drduration_activeuntr$mox_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_mox..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.
bc_drduration_activeuntr$pretomanid_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.
bc_drduration_activeuntr$pyrazinamide_s3_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..3. - bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.
bc_drduration_activeuntr$rif_s3_s7 <- bc_drduration_activeuntr$t_duration_activetb_untr..3. - bc_drduration_activeuntr$t_duration_activetb_untr..7.

#s4 vs s7
bc_drduration_activeuntr$amikacin_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.
bc_drduration_activeuntr$bed_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_bed..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.
bc_drduration_activeuntr$clofaz_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.
bc_drduration_activeuntr$cyclos_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.
bc_drduration_activeuntr$del_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_del..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.
bc_drduration_activeuntr$ethambutol_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.
bc_drduration_activeuntr$ethionamide_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.
bc_drduration_activeuntr$isoniazid_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.
bc_drduration_activeuntr$lin_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_lin..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.
bc_drduration_activeuntr$mox_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_mox..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.
bc_drduration_activeuntr$pretomanid_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.
bc_drduration_activeuntr$pyrazinamide_s4_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..4. - bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.
bc_drduration_activeuntr$rif_s4_s7 <- bc_drduration_activeuntr$t_duration_activetb_untr..4. - bc_drduration_activeuntr$t_duration_activetb_untr..7.

#s5 vs s7
bc_drduration_activeuntr$amikacin_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.
bc_drduration_activeuntr$bed_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_bed..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.
bc_drduration_activeuntr$clofaz_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.
bc_drduration_activeuntr$cyclos_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.
bc_drduration_activeuntr$del_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_del..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.
bc_drduration_activeuntr$ethambutol_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.
bc_drduration_activeuntr$ethionamide_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.
bc_drduration_activeuntr$isoniazid_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.
bc_drduration_activeuntr$lin_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_lin..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.
bc_drduration_activeuntr$mox_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_mox..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.
bc_drduration_activeuntr$pretomanid_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.
bc_drduration_activeuntr$pyrazinamide_s5_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..5. - bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.
bc_drduration_activeuntr$rif_s5_s7 <- bc_drduration_activeuntr$t_duration_activetb_untr..5. - bc_drduration_activeuntr$t_duration_activetb_untr..7.

#s6 vs s7
bc_drduration_activeuntr$amikacin_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.
bc_drduration_activeuntr$bed_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_bed..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.
bc_drduration_activeuntr$clofaz_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.
bc_drduration_activeuntr$cyclos_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.
bc_drduration_activeuntr$del_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_del..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.
bc_drduration_activeuntr$ethambutol_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.
bc_drduration_activeuntr$ethionamide_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.
bc_drduration_activeuntr$isoniazid_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.
bc_drduration_activeuntr$lin_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_lin..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.
bc_drduration_activeuntr$mox_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_mox..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.
bc_drduration_activeuntr$pretomanid_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.
bc_drduration_activeuntr$pyrazinamide_s6_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..6. - bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.
bc_drduration_activeuntr$rif_s6_s7 <- bc_drduration_activeuntr$t_duration_activetb_untr..6. - bc_drduration_activeuntr$t_duration_activetb_untr..7.

#s8 vs s7
bc_drduration_activeuntr$amikacin_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.
bc_drduration_activeuntr$bed_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_bed..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.
bc_drduration_activeuntr$clofaz_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.
bc_drduration_activeuntr$cyclos_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.
bc_drduration_activeuntr$del_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_del..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.
bc_drduration_activeuntr$ethambutol_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.
bc_drduration_activeuntr$ethionamide_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.
bc_drduration_activeuntr$isoniazid_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.
bc_drduration_activeuntr$lin_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_lin..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.
bc_drduration_activeuntr$mox_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_mox..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.
bc_drduration_activeuntr$pretomanid_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.
bc_drduration_activeuntr$pyrazinamide_s8_s7 <- bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..8. - bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.
bc_drduration_activeuntr$rif_s8_s7 <- bc_drduration_activeuntr$t_duration_activetb_untr..8. - bc_drduration_activeuntr$t_duration_activetb_untr..7.

data.list <- c(bc_drduration_all, bc_drduration_activeuntr)
}

```

```{r empirical p value function for difference values, echo=FALSE}

# Two-tailed p-value
p_value_diff <- function(x){
  if(quantile(x,0.5)>0){
    p <- ecdf(x)(0)
    p <- round(p*2, 3)
  } else {
    p <- 1-(ecdf(x)(0))
    p <- round(p*2, 3)
  }
  if(p<0.001){
    p <- "<0.001"
  }
  return(p)
}
```

#############################################################################
#
# LOAD BASE CASE DATA FOR SOME SUBSEQUENT CODE SECTIONS
#
#############################################################################

```{r process data 1, echo=FALSE}

#Copy and paste this chunk wherever you need to change the input file 

WTP <- WTP_L

# Load the main csv file, all patients 
data_bc <- read.csv("Results/TreeAgeOutputBaseCase_20231221.csv")
data_bc <- data.frame(data_bc)

data_temp_health <- fn_process_healthoutcomes(data_bc)
data_temp_droutcomes <- fn_process_droutcomes(data_bc)

bc_QALY_d <- data.frame(data_temp_health[1:18])
bc_QALY_und <- data.frame(data_temp_health[19:36])
bc_LY_und <- data.frame(data_temp_health[37:54])
bc_totalcost_d <- data.frame(data_temp_health[55:72])
bc_totalcost_und <- data.frame(data_temp_health[73:90])
bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
bc_indirectcost_und <- data.frame(data_temp_health[127:144])
bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
bc_NMB <- data.frame(data_temp_health[163:180])
bc_NHB <- data.frame(data_temp_health[181:198])


bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])

WTP <- WTP_U

data_temp_health <- fn_process_healthoutcomes(data_bc)

bc_NMB_U <- data.frame(data_temp_health[163:180])
bc_NHB_U <- data.frame(data_temp_health[181:198])

WTP <- WTP_L
```


#############################################################################
#
# CEA PLANE
#
#############################################################################

```{r CE plane, echo = FALSE}
strategy_no <- c(1:8)
who_guideline <- rep(0, 8) 
replace_mox <- rep(0,8) #1 for BPal+Cfz, 0 for BPaL only, 1 for WHO strategies also
dst_upfront <- rep(0,8) #1 for Yes, 0 for no
dst_interval <- rep(1,8) #freq in months

qaly_d_mean <- rep(0, 8)
qaly_d_lower <- rep(0, 8)
qaly_d_upper <- rep(0, 8)
totalcost_d_mean <- rep(0, 8)
totalcost_d_lower <- rep(0, 8)
totalcost_d_upper <- rep(0, 8)


plot <- cbind(strategy_no, 
              who_guideline, 
              replace_mox, 
              dst_upfront,
              dst_interval, 
              qaly_d_mean,
              qaly_d_lower,
              qaly_d_upper,
              totalcost_d_mean,
              totalcost_d_lower,
              totalcost_d_upper)
plot <- data.frame(plot)

plot$who_guideline[1:6] <- "2022 (BPaLM)"
plot$who_guideline[7:8] <- "2020"

plot$replace_mox[c(1,2,5)] <- 1
plot$replace_mox[c(3,4,6)] <- 0
plot$replace_mox[c(7,8)] <- 1

plot$dst_upfront[c(1,2,3,4,7,8)] <- 1

plot$dst_interval[c(1,3,5,6,7)] <- 4

plot$qaly_d_mean[1] <- mean(bc_QALY_d$s1)
plot$qaly_d_mean[2] <- mean(bc_QALY_d$s2)
plot$qaly_d_mean[3] <- mean(bc_QALY_d$s3)
plot$qaly_d_mean[4] <- mean(bc_QALY_d$s4)
plot$qaly_d_mean[5] <- mean(bc_QALY_d$s5)
plot$qaly_d_mean[6] <- mean(bc_QALY_d$s6)
plot$qaly_d_mean[7] <- mean(bc_QALY_d$s7)
plot$qaly_d_mean[8] <- mean(bc_QALY_d$s8)

plot$qaly_d_lower[1] <- quantile(bc_QALY_d$s1, 0.025)
plot$qaly_d_lower[2] <- quantile(bc_QALY_d$s2, 0.025)
plot$qaly_d_lower[3] <- quantile(bc_QALY_d$s3, 0.025)
plot$qaly_d_lower[4] <- quantile(bc_QALY_d$s4, 0.025)
plot$qaly_d_lower[5] <- quantile(bc_QALY_d$s5, 0.025)
plot$qaly_d_lower[6] <- quantile(bc_QALY_d$s6, 0.025)
plot$qaly_d_lower[7] <- quantile(bc_QALY_d$s7, 0.025)
plot$qaly_d_lower[8] <- quantile(bc_QALY_d$s8, 0.025)

plot$qaly_d_upper[1] <- quantile(bc_QALY_d$s1, 0.975)
plot$qaly_d_upper[2] <- quantile(bc_QALY_d$s2, 0.975)
plot$qaly_d_upper[3] <- quantile(bc_QALY_d$s3, 0.975)
plot$qaly_d_upper[4] <- quantile(bc_QALY_d$s4, 0.975)
plot$qaly_d_upper[5] <- quantile(bc_QALY_d$s5, 0.975)
plot$qaly_d_upper[6] <- quantile(bc_QALY_d$s6, 0.975)
plot$qaly_d_upper[7] <- quantile(bc_QALY_d$s7, 0.975)
plot$qaly_d_upper[8] <- quantile(bc_QALY_d$s8, 0.975)

plot$totalcost_d_mean[1] <- mean(bc_totalcost_d$s1)
plot$totalcost_d_mean[2] <- mean(bc_totalcost_d$s2)
plot$totalcost_d_mean[3] <- mean(bc_totalcost_d$s3)
plot$totalcost_d_mean[4] <- mean(bc_totalcost_d$s4)
plot$totalcost_d_mean[5] <- mean(bc_totalcost_d$s5)
plot$totalcost_d_mean[6] <- mean(bc_totalcost_d$s6)
plot$totalcost_d_mean[7] <- mean(bc_totalcost_d$s7)
plot$totalcost_d_mean[8] <- mean(bc_totalcost_d$s8)

plot$totalcost_d_lower[1] <- quantile(bc_totalcost_d$s1, 0.025)
plot$totalcost_d_lower[2] <- quantile(bc_totalcost_d$s2, 0.025)
plot$totalcost_d_lower[3] <- quantile(bc_totalcost_d$s3, 0.025)
plot$totalcost_d_lower[4] <- quantile(bc_totalcost_d$s4, 0.025)
plot$totalcost_d_lower[5] <- quantile(bc_totalcost_d$s5, 0.025)
plot$totalcost_d_lower[6] <- quantile(bc_totalcost_d$s6, 0.025)
plot$totalcost_d_lower[7] <- quantile(bc_totalcost_d$s7, 0.025)
plot$totalcost_d_lower[8] <- quantile(bc_totalcost_d$s8, 0.025)

plot$totalcost_d_upper[1] <- quantile(bc_totalcost_d$s1, 0.975)
plot$totalcost_d_upper[2] <- quantile(bc_totalcost_d$s2, 0.975)
plot$totalcost_d_upper[3] <- quantile(bc_totalcost_d$s3, 0.975)
plot$totalcost_d_upper[4] <- quantile(bc_totalcost_d$s4, 0.975)
plot$totalcost_d_upper[5] <- quantile(bc_totalcost_d$s5, 0.975)
plot$totalcost_d_upper[6] <- quantile(bc_totalcost_d$s6, 0.975)
plot$totalcost_d_upper[7] <- quantile(bc_totalcost_d$s7, 0.975)
plot$totalcost_d_upper[8] <- quantile(bc_totalcost_d$s8, 0.975)
```


```{r CE plane, echo = FALSE}

ceplane <- ggplot(plot,aes(qaly_d_mean,totalcost_d_mean)) + 
  geom_point(size=2, color=plot$who_guideline, 
             shape = ifelse(
                            plot$replace_mox == 1,
                            ifelse(
                              plot$dst_upfront == 0, 17, ifelse(
                                plot$dst_interval >3, 15, 16)),
                            ifelse(
                              plot$dst_upfront == 0, 2, 
                              ifelse(plot$dst_interval ==4, 0, 1)))) +
  labs(x = "Total Discounted QALYs", y = "Total Discounted Cost (2022 USD)", size = 6) + 
  #xlim(10.2,10.8) + 
  #ylim(8000,13000) + 
  #geom_abline(intercept=0, slope=WTP_L, linetype = "dashed") +
  coord_cartesian(ylim=c(7500,12000), xlim = c(10.2, 10.8), clip="off") + 
  annotate("segment", x = plot$qaly_d_mean[5], xend = plot$qaly_d_mean[1], 
            y = plot$totalcost_d_mean[5], yend = plot$totalcost_d_mean[1],
           colour = "black", linewidth = 0.7) +
  annotate("segment", x = plot$qaly_d_mean[1], xend = plot$qaly_d_mean[7], 
            y = plot$totalcost_d_mean[1], yend = plot$totalcost_d_mean[7],
           colour = "black", linewidth = 0.7) +
    annotate("segment", x = plot$qaly_d_mean[7], xend = plot$qaly_d_mean[8], 
            y = plot$totalcost_d_mean[7], yend = plot$totalcost_d_mean[8],
           colour = "black", linewidth = 0.7) +
  annotate("segment", x = plot$qaly_d_mean[1] +0.01, xend = plot$qaly_d_mean[1] +0.04, 
            y = plot$totalcost_d_mean[1], yend = plot$totalcost_d_mean[1],
           colour = "black", linewidth = 0.2) +
  annotate("segment", x = plot$qaly_d_mean[7] +0.01, xend = plot$qaly_d_mean[7] +0.03, 
            y = plot$totalcost_d_mean[7], yend = plot$totalcost_d_mean[7],
           colour = "black", linewidth = 0.2) +
  annotate("segment", x = plot$qaly_d_mean[5] -0.03, xend = plot$qaly_d_mean[5] -0.01, 
            y = plot$totalcost_d_mean[5], yend = plot$totalcost_d_mean[5],
           colour = "black", linewidth = 0.2) +
    annotate("segment", x = plot$qaly_d_mean[8] -0.03, xend = plot$qaly_d_mean[8] -0.01, 
            y = plot$totalcost_d_mean[8], yend = plot$totalcost_d_mean[8],
           colour = "black", linewidth = 0.2) +
  # annotate("segment", x = 10.09, xend = 10.14, 
  #           y = 12800, yend = 12800,
  #          colour = "steelblue2", linewidth = 3) +
  # annotate("segment", x = 10.33, xend = 10.38, 
  #           y = 12800, yend = 12800,
  #          colour = "magenta3", linewidth = 3) +
  #  annotate("segment", x = 10.08, xend = 10.55, 
  #           y = 13000, yend = 13000,
  #          colour = "black", linewidth = 0.5) +
  #  annotate("segment", x = 10.08, xend = 10.55, 
  #           y = 9550, yend = 9550,
  #          colour = "black", linewidth = 0.5) +
  #  annotate("segment", x = 10.08, xend = 10.08, 
  #           y = 9550, yend = 13000,
  #          colour = "black", linewidth = 0.5) +
  #  annotate("segment", x = 10.55, xend = 10.55, 
  #           y = 9550, yend = 13000,
  #          colour = "black", linewidth = 0.5) +
  # annotate("segment", x = 10.1, xend = 10.53, 
  #           y = 11550, yend = 11550,
  #          colour = "black", linewidth = 0.15) +
  # geom_point(aes(x=10.37, y = 10370), size = 2, shape = 15) +
  # geom_point(aes(x=10.37, y = 10050), size = 2, shape = 16) +
  # geom_point(aes(x=10.37, y = 9740), size = 2, shape = 17) +
  # geom_point(aes(x=10.455, y = 10370), size = 2, shape = 0) +
  # geom_point(aes(x=10.455, y = 10050), size = 2, shape = 1) +
  # geom_point(aes(x=10.455, y = 9740), size = 2, shape = 2) +
  theme_classic() + 
  annotate(geom = "text", x = plot$qaly_d_mean[1] +0.04, y = 8450, label = "Strategy (1): \n  6 months BPaLM \n  DST upfront \n  Repeat DST every 4 months \n  BPaLC if Mfx stopped", size = 3, hjust = 0, angle = 0) + 
  annotate(geom = "text", x = plot$qaly_d_mean[7] +0.04, y = 11100, label = "Strategy (7): \n  9-18 month regimens \n  DST upfront \n  Repeat DST every 4 months", size = 3, hjust = 0, angle = 0) +
  annotate(geom = "text", x = plot$qaly_d_mean[8] -0.03, y = 11400, label = "Strategy (8):  \n9-18 month regimens  \nDST upfront  \nRepeat DST every 1 month  ", size = 3, hjust = 1, angle = 0) +
  annotate(geom = "text", x = plot$qaly_d_mean[5] -0.03, y = 8400, label = "Strategy (5):  \n6 months BPaLM  \nNo DST upfront, start at month 4  \nRepeat DST every 4 months  \nBPaLC if Mfx stopped  ", size = 3, hjust = 1, vjust = 1, angle = 0) +
  annotate(geom = "text", x = plot$qaly_d_mean[2] -0.005, y = plot$totalcost_d_mean[2]-35, label = "*", size = 4, hjust = 1, angle = 0)
# +
#   annotate(geom = "text", x = 10.09, y = 12550, 
#            label = "Standard of Care:
#            \n  9 month regimen if FQ-S 
#            \n 18 month regimen if FQ-R 
#            \n 
#            \nSchedule of second-line DST                    
#            \n    
#            \n
#            \nStart of month 1, then 4 monthly 
#            \nStart of month 1, then monthly 
#            \nStart of month 4, then 4 monthly", 
#            size = 3, hjust = 0, vjust = 1, angle = 0, lineheight = 0.7) +
#     annotate(geom = "text", x = 10.33, y = 12550, 
#            label = "6 months BPaLM
#            \n
#            \n
#            \n
#            \nFor 6 months BPaLM only:
#            \nIf Mfx stopped, continue with
#            \n   BPaLC      BPaL only", 
#            size = 3, hjust = 0, vjust = 1, angle = 0, lineheight = 0.7)
ceplane  

ggsave("Fig1a.png", device = "png", 
       path = "Figures_v5",
       scale = 1, units = "cm"
)
```

#############################################################################
#
# CEAC
#
#############################################################################

```{r CEAC setup, echo = FALSE}

# generate a n*8 matrix 

wtp_l <- 0 
wtp_u <- 15000
n_intervals <- 30

wtp <- rep(0,n_intervals+1)
s1 <- rep(0,n_intervals+1)
s2 <- rep(0,n_intervals+1)
s3 <- rep(0,n_intervals+1)
s4 <- rep(0,n_intervals+1)
s5 <- rep(0,n_intervals+1)
s6 <- rep(0,n_intervals+1)
s7 <- rep(0,n_intervals+1)
s8 <- rep(0,n_intervals+1)

plot2 <- cbind(wtp,s1,s2,s3,s4,s5,s6,s7,s8)
plot2 <- data.frame(plot2)

for(i in 1:n_intervals+1){
  plot2$wtp[i] <- wtp_l + wtp_u/n_intervals*(i-1)
}

# Then for each WTP level 

for(i in 1:n_intervals+1){
  WTP <- plot2$wtp[i]
  temp <- fn_process_healthoutcomes(data_bc)
  NMB <- temp[163:180]
  NMB <- NMB[-c(9:18)]
  #print("nrow NMB", nrow(NMB))
  opt <- rep(0, 1000)
  #print("nrow opt", nrow(opt))
  #NMB <- cbind(NMB, opt)
  #print("nrow new NMB", nrow(NMB))
  NMB <- data.frame(NMB)
  #NMB <- as.numeric(unlist(NMB))
  for(j in 1:1000){
    opt[j] <- max.col(NMB[j,], ties.method = "random")
  }
  opt <- as.data.frame(opt)
  n_s1 <- 0
  n_s2 <- 0
  n_s3 <- 0
  n_s4 <- 0
  n_s5 <- 0
  n_s6 <- 0
  n_s7 <- 0
  n_s8 <- 0
  for(k in 1:1000){
    n_s1 <- n_s1 + ifelse(opt[k,1] == 1, 1, 0)
    n_s2 <- n_s2 + ifelse(opt[k,1] == 2, 1, 0)
    n_s3 <- n_s3 + ifelse(opt[k,1] == 3, 1, 0)
    n_s4 <- n_s4 + ifelse(opt[k,1] == 4, 1, 0)
    n_s5 <- n_s5 + ifelse(opt[k,1] == 5, 1, 0)
    n_s6 <- n_s6 + ifelse(opt[k,1] == 6, 1, 0)
    n_s7 <- n_s7 + ifelse(opt[k,1] == 7, 1, 0)
    n_s8 <- n_s8 + ifelse(opt[k,1] == 8, 1, 0)
  }
  plot2$s1[i] <- n_s1/1000
  plot2$s2[i] <- n_s2/1000
  plot2$s3[i] <- n_s3/1000
  plot2$s4[i] <- n_s4/1000
  plot2$s5[i] <- n_s5/1000
  plot2$s6[i] <- n_s6/1000
  plot2$s7[i] <- n_s7/1000
  plot2$s8[i] <- n_s8/1000

  }

# For some reason the WTP = 0 doesn't work so just do that again manually outside the loop 

WTP <- 0
temp <- fn_process_healthoutcomes(data_bc)
NMB <- temp[163:180]
NMB <- NMB[-c(9:18)]
opt <- rep(0, 1000)
NMB <- data.frame(NMB)

for(j in 1:1000){
  opt[j] <- max.col(NMB[j,], ties.method = "random")
}
  
opt <- as.data.frame(opt)

n_s1 <- 0
n_s2 <- 0
n_s3 <- 0
n_s4 <- 0
n_s5 <- 0
n_s6 <- 0
n_s7 <- 0
n_s8 <- 0

for(k in 1:1000){
    n_s1 <- n_s1 + ifelse(opt[k,1] == 1, 1, 0)
    n_s2 <- n_s2 + ifelse(opt[k,1] == 2, 1, 0)
    n_s3 <- n_s3 + ifelse(opt[k,1] == 3, 1, 0)
    n_s4 <- n_s4 + ifelse(opt[k,1] == 4, 1, 0)
    n_s5 <- n_s5 + ifelse(opt[k,1] == 5, 1, 0)
    n_s6 <- n_s6 + ifelse(opt[k,1] == 6, 1, 0)
    n_s7 <- n_s7 + ifelse(opt[k,1] == 7, 1, 0)
    n_s8 <- n_s8 + ifelse(opt[k,1] == 8, 1, 0)
}

plot2$s1[1] <- n_s1/1000
plot2$s2[1] <- n_s2/1000
plot2$s3[1] <- n_s3/1000  
plot2$s4[1] <- n_s4/1000
plot2$s5[1] <- n_s5/1000
plot2$s6[1] <- n_s6/1000
plot2$s7[1] <- n_s7/1000
plot2$s8[1] <- n_s8/1000

WTP <- WTP_L

```

```{r CEAC plot, echo = FALSE}

# Convert the above df to long format 

ceac_plot <- melt(plot2, id.vars = "wtp", variable.name = "Strategy")

ceac_plot$who_guideline <- ifelse(ceac_plot$Strategy %in% c("s7", "s8"), "2020", "2022 (BPaLM)")
ceac_plot$replace_mox <- as.factor(ifelse(ceac_plot$Strategy %in% c("s1","s2","s5", "s7", "s8"), 1, 0))
ceac_plot$dst_upfront <- as.factor(ifelse(ceac_plot$Strategy %in% c("s5", "s6"), 0, 1))
ceac_plot$dst_interval <- as.factor(ifelse(ceac_plot$Strategy %in% c("s2", "s4", "s8"), 1, 4))

ceac <- ggplot(ceac_plot, aes(wtp, value)) + 
  geom_line(aes(color = Strategy)) +
  geom_point(aes(color = Strategy)) +
  xlim(0,15000) +
  ylim(0, 0.6) +
  labs(x = "Willingness to pay (2022 USD/QALY)", y = "Probability of being cost-effective") + 
  theme_classic() + 
  annotate("segment", x = WTP_L, xend = WTP_L, 
            y = 0, yend = 0.6, colour = "black", linetype = "dashed", linewidth = 0.5) +
  annotate("segment", x = WTP_U, xend = WTP_U, 
            y = 0, yend = 0.6, colour = "black", linetype = "dashed", linewidth = 0.5) +
  annotate(geom = "text", x = WTP_L-100, y = 0.58, label = "Lower bound WTP\nfor Moldova", size = 3, hjust = 1, angle = 0) +
  annotate(geom = "text", x = WTP_U+100, y = 0.58, label = "Upper bound WTP\nfor Moldova", size = 3, hjust = 0, angle = 0)
ceac

#Make separate dfs for each strategy you want to graph 
ceac_plot_s1 <- ceac_plot[1:(1+n_intervals),]
ceac_plot_s2 <- ceac_plot[(2+n_intervals):(2+2*n_intervals),]
ceac_plot_s5 <- ceac_plot[(5+4*n_intervals):(5+5*n_intervals),]
ceac_plot_s7 <- ceac_plot[(7+6*n_intervals):(7+7*n_intervals),]
ceac_plot_s8 <- ceac_plot[(8+7*n_intervals):(8+8*n_intervals),]

#Then call each in the plot function 
ceac <- ggplot(ceac_plot_s1, aes(wtp, value)) + 
  scale_color_manual(values = c("magenta3", "magenta3", "magenta3", "steelblue2", "steelblue2"))+
  #theme_bw() +
  geom_point(color = "magenta3", shape = 15, size = 2) +
  geom_line(aes(x=wtp, y = value), color = "magenta3") +
  geom_point(data = ceac_plot_s2, mapping = aes(x=wtp, y = value), color = "magenta3", shape = 16, size = 2)+
  geom_line(data = ceac_plot_s2, mapping = aes(x=wtp, y = value), color = "magenta3")+
  geom_point(data = ceac_plot_s5, mapping = aes(x=wtp, y = value), color = "magenta3", shape = 17, size = 2)+
  geom_line(data = ceac_plot_s5, mapping = aes(x=wtp, y = value), color = "magenta3")+
  geom_point(data = ceac_plot_s7, mapping = aes(x=wtp, y = value), color = "steelblue2", shape = 15, size = 2)+
  geom_line(data = ceac_plot_s7, mapping = aes(x=wtp, y = value), color = "steelblue2")+
  geom_point(data = ceac_plot_s8, mapping = aes(x=wtp, y = value), color = "steelblue2", shape = 16, size = 2)+
  geom_line(data = ceac_plot_s8, mapping = aes(x=wtp, y = value), color = "steelblue2")+
  coord_cartesian(ylim=c(0, 0.6), xlim = c(0, 15000), clip="off") + 
  # xlim(0,15000) +
  # ylim(0, 0.6) +
  labs(x = "Willingness to pay (2022 USD/QALY)", y = "Probability of being cost-effective", color = "", width = 2) + 
  theme_classic() + 
  annotate("segment", x = WTP_L, xend = WTP_L, 
            y = 0, yend = 0.6, colour = "black", linetype = "dashed", linewidth = 0.5) +
  annotate("segment", x = WTP_U, xend = WTP_U, 
            y = 0, yend = 0.6, colour = "black", linetype = "dashed", linewidth = 0.5) +
  annotate(geom = "text", x = WTP_L-100, y = 0.58, label = "Lower bound WTP\nfor Moldova", size = 3, hjust = 1, angle = 0) +
  annotate(geom = "text", x = WTP_U+100, y = 0.58, label = "Upper bound WTP\nfor Moldova", size = 3, hjust = 0, angle = 0)
ceac

# ggsave("Fig1b", device = "png", 
#        path = "Figures_v5",
#        scale = 1, units = "cm"
# )

```

```{r CEA legend}

legend <- ggplot() +
  coord_cartesian(ylim=c(9500,13000), xlim = c(9.9, 10.7), clip="off") + 
  annotate("segment", x = 10.09, xend = 10.14, 
            y = 12800, yend = 12800,
           colour = "steelblue2", linewidth = 3) +
  annotate("segment", x = 10.33, xend = 10.38, 
            y = 12800, yend = 12800,
           colour = "magenta3", linewidth = 3) +
   annotate("segment", x = 10.08, xend = 10.55, 
            y = 13000, yend = 13000,
           colour = "black", linewidth = 0.5) +
   annotate("segment", x = 10.08, xend = 10.55, 
            y = 9550, yend = 9550,
           colour = "black", linewidth = 0.5) +
   annotate("segment", x = 10.08, xend = 10.08, 
            y = 9550, yend = 13000,
           colour = "black", linewidth = 0.5) +
   annotate("segment", x = 10.55, xend = 10.55, 
            y = 9550, yend = 13000,
           colour = "black", linewidth = 0.5) +
  annotate("segment", x = 10.1, xend = 10.53, 
            y = 11550, yend = 11550,
           colour = "black", linewidth = 0.15) +
  geom_point(aes(x=10.37, y = 10370), size = 2, shape = 15) +
  geom_point(aes(x=10.37, y = 10050), size = 2, shape = 16) +
  geom_point(aes(x=10.37, y = 9740), size = 2, shape = 17) +
  geom_point(aes(x=10.455, y = 10370), size = 2, shape = 0) +
  geom_point(aes(x=10.455, y = 10050), size = 2, shape = 1) +
  geom_point(aes(x=10.455, y = 9740), size = 2, shape = 2) +
  theme_classic()+
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none"
        # ,
        #   panel.background=element_blank(),panel.border=element_blank(),
        #   panel.grid.major=element_blank(),
        #   panel.grid.minor=element_blank(),plot.background=element_blank()
        ) +
  annotate(geom = "text", x = 10.09, y = 12550, 
           label = "Standard of Care:
           \n  9 month regimen if FQ-S 
           \n 18 month regimen if FQ-R 
           \n 
           \nSchedule of DST to 2nd line drugs                    
           \n    
           \n
           \nStart month 1, then every 4 months 
           \nStart month 1, then every month
           \nStart month 4, then every 4 months", 
           size = 3, hjust = 0, vjust = 1, angle = 0, lineheight = 0.7) +
    annotate(geom = "text", x = 10.33, y = 12550, 
           label = "6 months BPaLM
           \n
           \n
           \n
           \nFor 6 months BPaLM only:
           \nIf Mfx stopped, continue with
           \n   BPaLC      BPaL only", 
           size = 3, hjust = 0, vjust = 1, angle = 0, lineheight = 0.7)
legend
```

```{r combined CE figure}
fig_cea <- ggarrange(ceplane, ceac, legend,
                    ncol = 1, nrow = 3
                    , heights = c(9, 9, 5.4)
                    , labels = c("A", "B", "")
                    #, align = "v"
                    )
fig_cea

ggsave("Fig1.png", device = "png", 
       path = "Figures_v5"
       #,scale = 1
       ,width = 18, height = 30, units = "cm"
       )

```

#############################################################################
#
# CEA TABLE
#
#############################################################################

```{r CEATable, echo=FALSE}

# All strategies in order of increasing cost 

CEA_table <- tibble(
  "Strategy Name" = c("5) 6 months BPaLM",
                 "1) 6 months BPaLM", "2) 6 months BPaLM",
                 "6) 6 months BPaLM", "3) 6 months BPaLM",
                 "4) 6 months BPaLM", "7) Standard of Care", 
                 "8) Standard of Care"),
  "Alternative regimen if Mfx stopped" = c(
    "BPaLC", "BPaLC", "BPaLC", "BPaL only", "BPaL only", "BPaL only", "--", "--"),
  "2nd line DST at treatment initiation" = c(
    "No", "Yes", "Yes", "No", "Yes", "Yes", "Yes", "Yes"),
  "Routine frequency of subsequent 2nd line DST" = c(
    "Every 4 months", "Every 4 months", "Every 1 month", 
    "Every 4 months", "Every 4 months", "Every 1 month", "Every 4 months", "Every 1 month"), 
  "Undiscounted Total Cost (2022 USD)" = c(
    paste0(trimws(format(round(mean(bc_totalcost_und$s5)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_und$s5, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_und$s5, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_und$s1)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_und$s1, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_und$s1, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_und$s2)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_und$s2, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_und$s2, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_und$s6)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_und$s6, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_und$s6, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_und$s3)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_und$s3, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_und$s3, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_und$s4)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_und$s4, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_und$s4, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_und$s7)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_und$s7, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_und$s7, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_und$s8)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_und$s8, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_und$s8, 0.975)), big.mark=",")), ")")
  ),
  "Discounted Total Cost (2022 USD)" = c(
    paste0(trimws(format(round(mean(bc_totalcost_d$s5)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_d$s5, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_d$s5, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_d$s1)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_d$s1, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_d$s1, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_d$s2)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_d$s2, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_d$s2, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_d$s6)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_d$s6, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_d$s6, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_d$s3)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_d$s3, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_d$s3, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_d$s4)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_d$s4, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_d$s4, 0.975)), big.mark=",")), ")"), 
    paste0(trimws(format(round(mean(bc_totalcost_d$s7)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_d$s7, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_d$s7, 0.975)), big.mark=",")), ")"),
    paste0(trimws(format(round(mean(bc_totalcost_d$s8)), big.mark=",")), " (", trimws(format(round(quantile(bc_totalcost_d$s8, 0.025)), big.mark=",")), ", ", trimws(format(round(quantile(bc_totalcost_d$s8, 0.975)), big.mark=",")), ")")
  ),
  "Undiscounted QALYs" = c(
    paste0(round(mean(bc_QALY_und$s5), 3), " (", round(quantile(bc_QALY_und$s5, 0.025), 2), ", ", round(quantile(bc_QALY_und$s5, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s1), 3), " (", round(quantile(bc_QALY_und$s1, 0.025), 2), ", ", round(quantile(bc_QALY_und$s1, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s2), 3), " (", round(quantile(bc_QALY_und$s2, 0.025), 2), ", ", round(quantile(bc_QALY_und$s2, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s6), 3), " (", round(quantile(bc_QALY_und$s6, 0.025), 2), ", ", round(quantile(bc_QALY_und$s6, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s3), 3), " (", round(quantile(bc_QALY_und$s3, 0.025), 2), ", ", round(quantile(bc_QALY_und$s3, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s4), 3), " (", round(quantile(bc_QALY_und$s4, 0.025), 2), ", ", round(quantile(bc_QALY_und$s4, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s7), 3), " (", round(quantile(bc_QALY_und$s7, 0.025), 2), ", ", round(quantile(bc_QALY_und$s7, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s8), 3), " (", round(quantile(bc_QALY_und$s8, 0.025), 2), ", ", round(quantile(bc_QALY_und$s8, 0.975), 2), ")")
  ),
  "Discounted QALYs" = c(
    paste0(round(mean(bc_QALY_d$s5), 3), " (", round(quantile(bc_QALY_d$s5, 0.025), 2), ", ", round(quantile(bc_QALY_d$s5, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_d$s1), 3), " (", round(quantile(bc_QALY_d$s1, 0.025), 2), ", ", round(quantile(bc_QALY_d$s1, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_d$s2), 3), " (", round(quantile(bc_QALY_d$s2, 0.025), 2), ", ", round(quantile(bc_QALY_d$s2, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_d$s6), 3), " (", round(quantile(bc_QALY_d$s6, 0.025), 2), ", ", round(quantile(bc_QALY_d$s6, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_d$s3), 3), " (", round(quantile(bc_QALY_d$s3, 0.025), 2), ", ", round(quantile(bc_QALY_d$s3, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_d$s4), 3), " (", round(quantile(bc_QALY_d$s4, 0.025), 2), ", ", round(quantile(bc_QALY_d$s4, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_d$s7), 3), " (", round(quantile(bc_QALY_d$s7, 0.025), 2), ", ", round(quantile(bc_QALY_d$s7, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_d$s8), 3), " (", round(quantile(bc_QALY_d$s8, 0.025), 2), ", ", round(quantile(bc_QALY_d$s8, 0.975), 2), ")")
  ),
    "Incremental Discounted Total Cost (2022 USD)" = c(
    paste0("--"), 
    paste0(trimws(format(round(mean(bc_totalcost_d$s1-bc_totalcost_d$s5)), big.mark=",")), " (",
    trimws(format(round(quantile(bc_totalcost_d$s1-bc_totalcost_d$s5, 0.025)), big.mark=",")), ", ", 
    trimws(format(round(quantile(bc_totalcost_d$s1-bc_totalcost_d$s5, 0.975)), big.mark=",")), ")",
          "p=",
          p_value_diff(bc_totalcost_d$s1-bc_totalcost_d$s5)),   
    paste0("--"),
    paste0("--"),
    paste0("--"),
    paste0("--"),
    paste0(trimws(format(round(mean(bc_totalcost_d$s7-bc_totalcost_d$s1)), big.mark=",")), " (",
    trimws(format(round(quantile(bc_totalcost_d$s7-bc_totalcost_d$s1, 0.025)), big.mark=",")), ", ", 
    trimws(format(round(quantile(bc_totalcost_d$s7-bc_totalcost_d$s1, 0.975)), big.mark=",")), ")",
          "p=",
          p_value_diff(bc_totalcost_d$s7-bc_totalcost_d$s1)), 
    paste0(trimws(format(round(mean(bc_totalcost_d$s8-bc_totalcost_d$s7)), big.mark=",")), " (",
    trimws(format(round(quantile(bc_totalcost_d$s8-bc_totalcost_d$s7, 0.025)), big.mark=",")), ", ", 
    trimws(format(round(quantile(bc_totalcost_d$s8-bc_totalcost_d$s7, 0.975)), big.mark=",")), ")",
          "p=",
          p_value_diff(bc_totalcost_d$s8-bc_totalcost_d$s7)) 
  ), 
  "Incremental Discounted QALYs" = c(
    paste0("--"), 
    paste0(round(mean(bc_QALY_d$s1-bc_QALY_d$s5), 4), " (",
    round(quantile(bc_QALY_d$s1-bc_QALY_d$s5, 0.025), 2), ", ", 
    round(quantile(bc_QALY_d$s1-bc_QALY_d$s5, 0.975), 2), ")",
          "p=",
          p_value_diff(bc_QALY_d$s1-bc_QALY_d$s5)),  
    paste0("--"),
    paste0("--"),
    paste0("--"),
    paste0("--"),
    paste0(round(mean(bc_QALY_d$s7-bc_QALY_d$s1), 4), " (",
    round(quantile(bc_QALY_d$s7-bc_QALY_d$s1, 0.025), 2), ", ", 
    round(quantile(bc_QALY_d$s7-bc_QALY_d$s1, 0.975), 2), ")",
          "p=",
          p_value_diff(bc_QALY_d$s7-bc_QALY_d$s1)), 
    paste0(round(mean(bc_QALY_d$s8-bc_QALY_d$s7), 4), " (",
    round(quantile(bc_QALY_d$s8-bc_QALY_d$s7, 0.025), 2), ", ", 
    round(quantile(bc_QALY_d$s8-bc_QALY_d$s7, 0.975), 2), ")",
          "p=",
          p_value_diff(bc_QALY_d$s8-bc_QALY_d$s7))
  ), 
  "Incremental Cost-effectiveness Ratio" = c(
    " ", "2,979", "Dominated*", "Dominated", "Dominated", "Dominated", "58,694", "197,857"
  ),
  "Net Health Benefit, calculated using lower bound WTP for health (QALYs)" = c(
    paste0(round(mean(bc_NHB$s5), 3), " (", round(quantile(bc_NHB$s5, 0.025), 2), ", ", round(quantile(bc_NHB$s5, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB$s1), 3), " (", round(quantile(bc_NHB$s1, 0.025), 2), ", ", round(quantile(bc_NHB$s1, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB$s2), 3), " (", round(quantile(bc_NHB$s2, 0.025), 2), ", ", round(quantile(bc_NHB$s2, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB$s6), 3), " (", round(quantile(bc_NHB$s6, 0.025), 2), ", ", round(quantile(bc_NHB$s6, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB$s3), 3), " (", round(quantile(bc_NHB$s3, 0.025), 2), ", ", round(quantile(bc_NHB$s3, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB$s4), 3), " (", round(quantile(bc_NHB$s4, 0.025), 2), ", ", round(quantile(bc_NHB$s4, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB$s7), 3), " (", round(quantile(bc_NHB$s7, 0.025), 2), ", ", round(quantile(bc_NHB$s7, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB$s8), 3), " (", round(quantile(bc_NHB$s8, 0.025), 2), ", ", round(quantile(bc_NHB$s8, 0.975), 2), ")")
    ), 
  "Net Health Benefit, calculated using upper bound WTP for health (QALYs)" = c(
    paste0(round(mean(bc_NHB_U$s5), 3), " (", round(quantile(bc_NHB_U$s5, 0.025), 2), ", ", round(quantile(bc_NHB_U$s5, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB_U$s1), 3), " (", round(quantile(bc_NHB_U$s1, 0.025), 2), ", ", round(quantile(bc_NHB_U$s1, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB_U$s2), 3), " (", round(quantile(bc_NHB_U$s2, 0.025), 2), ", ", round(quantile(bc_NHB_U$s2, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB_U$s6), 3), " (", round(quantile(bc_NHB_U$s6, 0.025), 2), ", ", round(quantile(bc_NHB_U$s6, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB_U$s3), 3), " (", round(quantile(bc_NHB_U$s3, 0.025), 2), ", ", round(quantile(bc_NHB_U$s3, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB_U$s4), 3), " (", round(quantile(bc_NHB_U$s4, 0.025), 2), ", ", round(quantile(bc_NHB_U$s4, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB_U$s7), 3), " (", round(quantile(bc_NHB_U$s7, 0.025), 2), ", ", round(quantile(bc_NHB_U$s7, 0.975), 2), ")"),
    paste0(round(mean(bc_NHB_U$s8), 3), " (", round(quantile(bc_NHB_U$s8, 0.025), 2), ", ", round(quantile(bc_NHB_U$s8, 0.975), 2), ")") 
    )
)
  
# NOTE: You have to *manually* do each ICER

# Manually check the ordering and do the necessary calculations. 

write.table(CEA_table, file = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5/table1.txt", sep = "|", quote = FALSE, row.names = F)

```

```{r LE table, echo = FALSE}
LE_table <- tibble(
  "Strategy Name" = c("5) 6 months BPaLM",
                 "1) 6 months BPaLM", "2) 6 months BPaLM",
                 "6) 6 months BPaLM", "3) 6 months BPaLM",
                 "4) 6 months BPaLM", "7) Standard of Care", 
                 "8) Standard of Care"),
  "Alternative regimen if Mfx stopped" = c(
    "BPaLC", "BPaLC", "BPaLC", "BPaL only", "BPaL only", "BPaL only", "--", "--"),
  "2nd line DST at treatment initiation" = c(
    "No", "Yes", "Yes", "No", "Yes", "Yes", "Yes", "Yes"),
  "Routine frequency of subsequent 2nd line DST" = c(
    "Every 4 months", "Every 4 months", "Every 1 month", 
    "Every 4 months", "Every 4 months", "Every 1 month", "Every 4 months", "Every 1 month"), 
  "Undiscounted QALYs" = c(
    paste0(round(mean(bc_QALY_und$s5), 3), " (", round(quantile(bc_QALY_und$s5, 0.025), 2), ", ", round(quantile(bc_QALY_und$s5, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s1), 3), " (", round(quantile(bc_QALY_und$s1, 0.025), 2), ", ", round(quantile(bc_QALY_und$s1, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s2), 3), " (", round(quantile(bc_QALY_und$s2, 0.025), 2), ", ", round(quantile(bc_QALY_und$s2, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s6), 3), " (", round(quantile(bc_QALY_und$s6, 0.025), 2), ", ", round(quantile(bc_QALY_und$s6, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s3), 3), " (", round(quantile(bc_QALY_und$s3, 0.025), 2), ", ", round(quantile(bc_QALY_und$s3, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s4), 3), " (", round(quantile(bc_QALY_und$s4, 0.025), 2), ", ", round(quantile(bc_QALY_und$s4, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s7), 3), " (", round(quantile(bc_QALY_und$s7, 0.025), 2), ", ", round(quantile(bc_QALY_und$s7, 0.975), 2), ")"), 
    paste0(round(mean(bc_QALY_und$s8), 3), " (", round(quantile(bc_QALY_und$s8, 0.025), 2), ", ", round(quantile(bc_QALY_und$s8, 0.975), 2), ")")
  )
)
  
# NOTE: You have to *manually* do each ICER

# Manually check the ordering and do the necessary calculations. 

write.table(LE_table, file = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5/tableS3.txt", sep = "|", quote = FALSE, row.names = F)
```


#############################################################################
#
# iNHB
#
#############################################################################


```{r}
#For main text 
paste0("At the lower bound of WTP in Moldova, the iNHB of Strategy (1) compared to Strategy (7) is ", 
      round(mean(bc_NHB$s1_s7),3), 
      " QALYs; (95% UI [", 
      round(quantile(bc_NHB$s1_s7, 0.025),3),
      ", ",
      round(quantile(bc_NHB$s1_s7, 0.975),3),
      "] p=",
      p_value_diff(bc_NHB$s1_s7),
      ")"
      )

paste0("At the upper bound of WTP in Moldova, the iNHB of Strategy (1) compared to Strategy (7) is ", 
      round(mean(bc_NHB_U$s1_s7),3), 
      " QALYs; (95% UI [", 
      round(quantile(bc_NHB_U$s1_s7, 0.025),3),
      ", ",
      round(quantile(bc_NHB_U$s1_s7, 0.975),3),
      "] p=",
      p_value_diff(bc_NHB_U$s1_s7),
      ")"
      )
```

#############################################################################
#
# ICER PLOT
#
#############################################################################

```{r ICE plot1, echo = FALSE}

#Not included in manuscript. Use for debugging etc 

#For S1 incremental to S7
ice_plot_data <- data.frame(x = bc_QALY_d$s1_s7, y = bc_totalcost_d$s1_s7)
#
ggplot(ice_plot_data,aes(x,y)) +
   geom_point(size=0.3, color="lightpink") +
   labs(x = "Incremental QALYs", y = "Incremental Cost (2022 USD)") +
   xlim(-1,1) +
   ylim(-10000,10000) +
   geom_hline(yintercept=0) +
   geom_vline(xintercept=0) +
   geom_abline(intercept=0, slope=WTP_L, linetype = "dashed") +
   theme_bw() +
   annotate(geom = "text", x = 0.75, y = 4400, label = "WTP = 4700 USD/QALY", angle = 25) +
   annotate(geom = "point", x = mean(bc_QALY_d$s1_s7), y = mean(bc_totalcost_d$s1_s7), shape = 18, size = 4, color = "darkmagenta") +
  annotate(geom = "point", x = 0, y = 0, shape = 16, size = 3, color = "blue3") 

ggsave("FigS7.png", device = "png",
        path = "Figures_v5",
        scale = 1, width = 16, height = 14, units = "cm"
)
```


#############################################################################
#
# COST CATEGORIES PLOTS 
#
#############################################################################

```{r Cost categories plots, echo = FALSE}

costcat <- rep(0, 8)
mean <- rep(0, 8)
lower <- rep(0, 8)
upper <- rep(0, 8)
strategy <- rep(0, 8)

plot <- cbind(costcat, mean, lower, upper, strategy)
plot <- data.frame(plot)

plot$costcat[1:2] <- "Direct Medical"
plot$costcat[3:4] <- "Direct Nonmedical"
plot$costcat[5:6] <- "Indirect"
plot$costcat[7:8] <- "Productivity Loss\nfrom Early Mortality"

plot$strategy[c(1,3,5,7)] <- "(1): 6 months BPaLM"
plot$strategy[c(2,4,6,8)] <- "(7): Standard of Care"

plot$mean[1] <- mean(bc_directmedicalcost_und$s1)
plot$mean[2] <- mean(bc_directmedicalcost_und$s7)
plot$mean[3] <- mean(bc_directnonmedicalcost_und$s1)
plot$mean[4] <- mean(bc_directnonmedicalcost_und$s7)
plot$mean[5] <- mean(bc_indirectcost_und$s1)
plot$mean[6] <- mean(bc_indirectcost_und$s7)
plot$mean[7] <- mean(bc_postfatalcost_und$s1)
plot$mean[8] <- mean(bc_postfatalcost_und$s7)

plot$upper[1] <- quantile(bc_directmedicalcost_und$s1, 0.975)
plot$upper[2] <- quantile(bc_directmedicalcost_und$s7, 0.975)
plot$upper[3] <- quantile(bc_directnonmedicalcost_und$s1, 0.975)
plot$upper[4] <- quantile(bc_directnonmedicalcost_und$s7, 0.975)
plot$upper[5] <- quantile(bc_indirectcost_und$s1, 0.975)
plot$upper[6] <- quantile(bc_indirectcost_und$s7, 0.975)
plot$upper[7] <- quantile(bc_postfatalcost_und$s1, 0.975)
plot$upper[8] <- quantile(bc_postfatalcost_und$s7, 0.975)

plot$lower[1] <- quantile(bc_directmedicalcost_und$s1, 0.025)
plot$lower[2] <- quantile(bc_directmedicalcost_und$s7, 0.025)
plot$lower[3] <- quantile(bc_directnonmedicalcost_und$s1, 0.025)
plot$lower[4] <- quantile(bc_directnonmedicalcost_und$s7, 0.025)
plot$lower[5] <- quantile(bc_indirectcost_und$s1, 0.025)
plot$lower[6] <- quantile(bc_indirectcost_und$s7, 0.025)
plot$lower[7] <- quantile(bc_postfatalcost_und$s1, 0.025)
plot$lower[8] <- quantile(bc_postfatalcost_und$s7, 0.025)

ggplot(plot, aes(x=mean, y=costcat, fill=strategy)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  geom_errorbar(aes(xmin=lower, xmax=upper), width=.2,
                 position=position_dodge(.9)) +
  labs(x="Undiscounted Cost (2022 USD)", y = "Cost Category", fill = "Strategy")+
  theme_classic() +
  xlim(0, 12000) +
  scale_fill_manual(breaks = c("(1): 6 months BPaLM",
                               "(7): Standard of Care"),
                    values=c("magenta3", "steelblue2"))

ggsave("Fig2.png", device = "png", 
       path = "Figures_v5",
       scale = 1, width = 20, height = 10, units = "cm"
)

```



#############################################################################
#
# DRUG RESISTANCE DURATIONS TABLE AND PLOTS 
#
#############################################################################

```{r process data 1, echo=FALSE}

#Copy and paste this chunk wherever you need to change the input file 

WTP <- WTP_L

# Load the main csv file, all patients 
data_bc <- read.csv("Results/TreeAgeOutputBaseCase_20231221.csv")
data_bc <- data.frame(data_bc)

data_temp_health <- fn_process_healthoutcomes(data_bc)
data_temp_droutcomes <- fn_process_droutcomes(data_bc)

bc_QALY_d <- data.frame(data_temp_health[1:18])
bc_QALY_und <- data.frame(data_temp_health[19:36])
bc_LY_und <- data.frame(data_temp_health[37:54])
bc_totalcost_d <- data.frame(data_temp_health[55:72])
bc_totalcost_und <- data.frame(data_temp_health[73:90])
bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
bc_indirectcost_und <- data.frame(data_temp_health[127:144])
bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
bc_NMB <- data.frame(data_temp_health[163:180])
bc_NHB <- data.frame(data_temp_health[181:198])


bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])

WTP <- WTP_U

data_temp_health <- fn_process_healthoutcomes(data_bc)

bc_NMB_U <- data.frame(data_temp_health[163:180])
bc_NHB_U <- data.frame(data_temp_health[181:198])

WTP <- WTP_L
```


```{r calculate cumulative incidence}

#Run code to create CI outcomes 

data_bc$ci_dr_amikacin_s1 <- data_bc$t_dr_amikacin..1.-
  data_bc$t_drp_amikacin..1.
data_bc$ci_dr_bed_s1 <- data_bc$t_dr_bed..1.-
  data_bc$t_drp_bed..1.
data_bc$ci_dr_clofaz_s1 <- data_bc$t_dr_clofaz..1.-
  data_bc$t_drp_clofaz..1.
data_bc$ci_dr_cyclos_s1 <- data_bc$t_dr_cyclos..1.-
  data_bc$t_drp_cyclos..1.
data_bc$ci_dr_del_s1 <- data_bc$t_dr_del..1.-
  data_bc$t_drp_del..1.
data_bc$ci_dr_ethambutol_s1 <- data_bc$t_dr_ethambutol..1.-
  data_bc$t_drp_ethambutol..1.
data_bc$ci_dr_ethionamide_s1 <- data_bc$t_dr_ethionamide..1.-
  data_bc$t_drp_ethionamide..1.
data_bc$ci_dr_isoniazid_s1 <- data_bc$t_dr_isoniazid..1.-
  data_bc$t_drp_isoniazid..1.
data_bc$ci_dr_lin_s1 <- data_bc$t_dr_lin..1.-
  data_bc$t_drp_lin..1.
data_bc$ci_dr_mox_s1 <- data_bc$t_dr_mox..1.-
  data_bc$t_drp_mox..1.
data_bc$ci_dr_pretomanid_s1 <- data_bc$t_dr_pretomanid..1.-
  data_bc$t_drp_pretomanid..1.
data_bc$ci_dr_pyrazinamide_s1 <- data_bc$t_dr_pyrazinamide..1.-
  data_bc$t_drp_pyrazinamide..1.

data_bc$ci_dr_amikacin_s7 <- data_bc$t_dr_amikacin..7.-
  data_bc$t_drp_amikacin..7.
data_bc$ci_dr_bed_s7 <- data_bc$t_dr_bed..7.-
  data_bc$t_drp_bed..7.
data_bc$ci_dr_clofaz_s7 <- data_bc$t_dr_clofaz..7.-
  data_bc$t_drp_clofaz..7.
data_bc$ci_dr_cyclos_s7 <- data_bc$t_dr_cyclos..7.-
  data_bc$t_drp_cyclos..7.
data_bc$ci_dr_del_s7 <- data_bc$t_dr_del..7.-
  data_bc$t_drp_del..7.
data_bc$ci_dr_ethambutol_s7 <- data_bc$t_dr_ethambutol..7.-
  data_bc$t_drp_ethambutol..7.
data_bc$ci_dr_ethionamide_s7 <- data_bc$t_dr_ethionamide..7.-
  data_bc$t_drp_ethionamide..7.
data_bc$ci_dr_isoniazid_s7 <- data_bc$t_dr_isoniazid..7.-
  data_bc$t_drp_isoniazid..7.
data_bc$ci_dr_lin_s7 <- data_bc$t_dr_lin..7.-
  data_bc$t_drp_lin..7.
data_bc$ci_dr_mox_s7 <- data_bc$t_dr_mox..7.-
  data_bc$t_drp_mox..7.
data_bc$ci_dr_pretomanid_s7 <- data_bc$t_dr_pretomanid..7.-
  data_bc$t_drp_pretomanid..7.
data_bc$ci_dr_pyrazinamide_s7 <- data_bc$t_dr_pyrazinamide..7.-
  data_bc$t_drp_pyrazinamide..7.

```


```{r drduration table}
#Table to provide p-values 

drugs <- c("Amikacin", "Bedaquiline", "Clofazimine", "Cycloserine", "Delamanid", "Ethambutol", "Ethionamide", "Isoniazid", "Linezolid", "Moxifloxacin", "Pretomanid", "Pyrazinamide", "Rifampicin")

dr_dur_all_s1 <- c(
  paste0(round(mean(bc_drduration_all$t_drduration_amikacin..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_amikacin..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_amikacin..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_bed..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_bed..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_bed..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_clofaz..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_clofaz..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_clofaz..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_cyclos..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_cyclos..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_cyclos..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_del..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_del..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_del..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_ethambutol..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_ethambutol..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_ethambutol..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_ethionamide..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_ethionamide..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_ethionamide..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_isoniazid..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_isoniazid..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_isoniazid..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_lin..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_lin..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_lin..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_mox..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_mox..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_mox..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_pretomanid..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_pretomanid..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_pretomanid..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_pyrazinamide..1.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_pyrazinamide..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_pyrazinamide..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_duration_rrtb..1.),2), " (",
        round(quantile(bc_drduration_all$t_duration_rrtb..1., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_duration_rrtb..1., 0.975),2), ")"
        )
)


dr_dur_all_s7 <- c(
  paste0(round(mean(bc_drduration_all$t_drduration_amikacin..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_amikacin..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_amikacin..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_bed..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_bed..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_bed..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_clofaz..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_clofaz..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_clofaz..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_cyclos..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_cyclos..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_cyclos..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_del..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_del..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_del..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_ethambutol..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_ethambutol..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_ethambutol..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_ethionamide..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_ethionamide..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_ethionamide..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_isoniazid..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_isoniazid..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_isoniazid..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_lin..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_lin..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_lin..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_mox..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_mox..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_mox..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_pretomanid..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_pretomanid..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_pretomanid..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_drduration_pyrazinamide..7.),2), " (",
        round(quantile(bc_drduration_all$t_drduration_pyrazinamide..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_drduration_pyrazinamide..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$t_duration_rrtb..7.),2), " (",
        round(quantile(bc_drduration_all$t_duration_rrtb..7., 0.025),2), ", ",
        round(quantile(bc_drduration_all$t_duration_rrtb..7., 0.975),2), ")"
        )
)
  
dr_dur_diff_all <- c(
  paste0(round(mean(bc_drduration_all$amikacin_s1_s7),2), " (",
        round(quantile(bc_drduration_all$amikacin_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$amikacin_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$bed_s1_s7),2), " (",
        round(quantile(bc_drduration_all$bed_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$bed_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$clofaz_s1_s7),2), " (",
        round(quantile(bc_drduration_all$clofaz_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$clofaz_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$cyclos_s1_s7),2), " (",
        round(quantile(bc_drduration_all$cyclos_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$cyclos_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$del_s1_s7),2), " (",
        round(quantile(bc_drduration_all$del_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$del_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$ethambutol_s1_s7),2), " (",
        round(quantile(bc_drduration_all$ethambutol_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$ethambutol_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$ethionamide_s1_s7),2), " (",
        round(quantile(bc_drduration_all$ethionamide_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$ethionamide_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$isoniazid_s1_s7),2), " (",
        round(quantile(bc_drduration_all$isoniazid_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$isoniazid_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$lin_s1_s7),2), " (",
        round(quantile(bc_drduration_all$lin_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$lin_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$mox_s1_s7),2), " (",
        round(quantile(bc_drduration_all$mox_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$mox_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$pretomanid_s1_s7),2), " (",
        round(quantile(bc_drduration_all$pretomanid_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$pretomanid_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$pyrazinamide_s1_s7),2), " (",
        round(quantile(bc_drduration_all$pyrazinamide_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$pyrazinamide_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_all$rif_s1_s7),2), " (",
        round(quantile(bc_drduration_all$rif_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_all$rif_s1_s7, 0.975),2), ")"
        )
)

dr_dur_diff_all_pval <- c(
  p_value_diff(bc_drduration_all$amikacin_s1_s7),
  p_value_diff(bc_drduration_all$bed_s1_s7),
  p_value_diff(bc_drduration_all$clofaz_s1_s7),
  p_value_diff(bc_drduration_all$cyclos_s1_s7),
  p_value_diff(bc_drduration_all$del_s1_s7),
  p_value_diff(bc_drduration_all$ethambutol_s1_s7),
  p_value_diff(bc_drduration_all$ethionamide_s1_s7),
  p_value_diff(bc_drduration_all$isoniazid_s1_s7),
  p_value_diff(bc_drduration_all$lin_s1_s7),
  p_value_diff(bc_drduration_all$mox_s1_s7),
  p_value_diff(bc_drduration_all$pretomanid_s1_s7),
  p_value_diff(bc_drduration_all$pyrazinamide_s1_s7),
  p_value_diff(bc_drduration_all$rif_s1_s7)
)

 dr_dur_activeuntr_s1 <- c(
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_del..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_del..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_del..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..1., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_duration_activetb_untr..1.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_duration_activetb_untr..1., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_duration_activetb_untr..1., 0.975),2), ")"
        )
)

dr_dur_activeuntr_s7 <- c(
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_del..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_del..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7., 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$t_duration_activetb_untr..7.),2), " (",
        round(quantile(bc_drduration_activeuntr$t_duration_activetb_untr..7., 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$t_duration_activetb_untr..7., 0.975),2), ")"
        )
)

dr_dur_diff_activeuntr <- c(
  paste0(round(mean(bc_drduration_activeuntr$amikacin_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$amikacin_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$amikacin_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$bed_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$bed_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$bed_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$clofaz_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$clofaz_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$clofaz_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$cyclos_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$cyclos_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$cyclos_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$del_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$del_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$del_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$ethambutol_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$ethambutol_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$ethambutol_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$ethionamide_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$ethionamide_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$ethionamide_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$isoniazid_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$isoniazid_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$isoniazid_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$lin_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$lin_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$lin_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$mox_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$mox_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$mox_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$pretomanid_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$pretomanid_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$pretomanid_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$pyrazinamide_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$pyrazinamide_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$pyrazinamide_s1_s7, 0.975),2), ")"
        ),
  paste0(round(mean(bc_drduration_activeuntr$rif_s1_s7),2), " (",
        round(quantile(bc_drduration_activeuntr$rif_s1_s7, 0.025),2), ", ",
        round(quantile(bc_drduration_activeuntr$rif_s1_s7, 0.975),2), ")"
        )
)

dr_dur_diff_activeuntr_pval <- c(
  p_value_diff(bc_drduration_activeuntr$amikacin_s1_s7),
  p_value_diff(bc_drduration_activeuntr$bed_s1_s7),
  p_value_diff(bc_drduration_activeuntr$clofaz_s1_s7),
  p_value_diff(bc_drduration_activeuntr$cyclos_s1_s7),
  p_value_diff(bc_drduration_activeuntr$del_s1_s7),
  p_value_diff(bc_drduration_activeuntr$ethambutol_s1_s7),
  p_value_diff(bc_drduration_activeuntr$ethionamide_s1_s7),
  p_value_diff(bc_drduration_activeuntr$isoniazid_s1_s7),
  p_value_diff(bc_drduration_activeuntr$lin_s1_s7),
  p_value_diff(bc_drduration_activeuntr$mox_s1_s7),
  p_value_diff(bc_drduration_activeuntr$pretomanid_s1_s7),
  p_value_diff(bc_drduration_activeuntr$pyrazinamide_s1_s7),
  p_value_diff(bc_drduration_activeuntr$rif_s1_s7)
)

dr_ci_s1 <- c(
  paste0(round(100*mean(data_bc$ci_dr_amikacin_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_amikacin_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_amikacin_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_bed_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_bed_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_bed_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_clofaz_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_clofaz_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_clofaz_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_cyclos_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_cyclos_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_cyclos_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_del_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_del_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_del_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_ethambutol_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_ethambutol_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_ethambutol_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_ethionamide_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_ethionamide_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_ethionamide_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_isoniazid_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_isoniazid_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_isoniazid_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_lin_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_lin_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_lin_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_mox_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_mox_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_mox_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_pretomanid_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_pretomanid_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_pretomanid_s1, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_pyrazinamide_s1),2), " (",
        round(100*quantile(data_bc$ci_dr_pyrazinamide_s1, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_pyrazinamide_s1, 0.975),2), ")"
        ),
  paste0("N/A")
)


dr_ci_s7 <- c(
  paste0(round(100*mean(data_bc$ci_dr_amikacin_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_amikacin_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_amikacin_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_bed_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_bed_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_bed_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_clofaz_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_clofaz_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_clofaz_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_cyclos_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_cyclos_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_cyclos_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_del_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_del_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_del_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_ethambutol_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_ethambutol_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_ethambutol_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_ethionamide_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_ethionamide_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_ethionamide_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_isoniazid_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_isoniazid_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_isoniazid_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_lin_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_lin_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_lin_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_mox_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_mox_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_mox_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_pretomanid_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_pretomanid_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_pretomanid_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_pyrazinamide_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_pyrazinamide_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_pyrazinamide_s7, 0.975),2), ")"
        ),
  paste0("N/A")
)
  
dr_ci_diff <- c(
  paste0(round(100*mean(data_bc$ci_dr_amikacin_s1-data_bc$ci_dr_amikacin_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_amikacin_s1-data_bc$ci_dr_amikacin_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_amikacin_s1-data_bc$ci_dr_amikacin_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_bed_s1-data_bc$ci_dr_bed_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_bed_s1-data_bc$ci_dr_bed_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_bed_s1-data_bc$ci_dr_bed_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_clofaz_s1-data_bc$ci_dr_clofaz_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_clofaz_s1-data_bc$ci_dr_clofaz_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_clofaz_s1-data_bc$ci_dr_clofaz_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_cyclos_s1-data_bc$ci_dr_cyclos_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_cyclos_s1-data_bc$ci_dr_cyclos_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_cyclos_s1-data_bc$ci_dr_cyclos_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_del_s1-data_bc$ci_dr_del_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_del_s1-data_bc$ci_dr_del_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_del_s1-data_bc$ci_dr_del_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_ethambutol_s1-data_bc$ci_dr_ethambutol_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_ethambutol_s1-data_bc$ci_dr_ethambutol_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_ethambutol_s1-data_bc$ci_dr_ethambutol_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_ethionamide_s1-data_bc$ci_dr_ethionamide_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_ethionamide_s1-data_bc$ci_dr_ethionamide_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_ethionamide_s1-data_bc$ci_dr_ethionamide_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_isoniazid_s1-data_bc$ci_dr_isoniazid_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_isoniazid_s1-data_bc$ci_dr_isoniazid_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_isoniazid_s1-data_bc$ci_dr_isoniazid_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_lin_s1-data_bc$ci_dr_lin_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_lin_s1-data_bc$ci_dr_lin_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_lin_s1-data_bc$ci_dr_lin_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_mox_s1-data_bc$ci_dr_mox_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_mox_s1-data_bc$ci_dr_mox_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_mox_s1-data_bc$ci_dr_mox_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_pretomanid_s1-data_bc$ci_dr_pretomanid_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_pretomanid_s1-data_bc$ci_dr_pretomanid_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_pretomanid_s1-data_bc$ci_dr_pretomanid_s7, 0.975),2), ")"
        ),
  paste0(round(100*mean(data_bc$ci_dr_pyrazinamide_s1-data_bc$ci_dr_pyrazinamide_s7),2), " (",
        round(100*quantile(data_bc$ci_dr_pyrazinamide_s1-data_bc$ci_dr_pyrazinamide_s7, 0.025),2), ", ",
        round(100*quantile(data_bc$ci_dr_pyrazinamide_s1-data_bc$ci_dr_pyrazinamide_s7, 0.975),2), ")"
        ),
  paste0("N/A")
)

dr_ci_diff_pval <- c(
  p_value_diff(data_bc$ci_dr_amikacin_s1-data_bc$ci_dr_amikacin_s7),
  p_value_diff(data_bc$ci_dr_bed_s1-data_bc$ci_dr_bed_s7),
  p_value_diff(data_bc$ci_dr_clofaz_s1-data_bc$ci_dr_clofaz_s7),
  p_value_diff(data_bc$ci_dr_cyclos_s1-data_bc$ci_dr_cyclos_s7),
  p_value_diff(data_bc$ci_dr_del_s1-data_bc$ci_dr_del_s7),
  p_value_diff(data_bc$ci_dr_ethambutol_s1-data_bc$ci_dr_ethambutol_s7),
  p_value_diff(data_bc$ci_dr_ethionamide_s1-data_bc$ci_dr_ethionamide_s7),
  p_value_diff(data_bc$ci_dr_isoniazid_s1-data_bc$ci_dr_isoniazid_s7),
  p_value_diff(data_bc$ci_dr_lin_s1-data_bc$ci_dr_lin_s7),
  p_value_diff(data_bc$ci_dr_mox_s1-data_bc$ci_dr_mox_s7),
  p_value_diff(data_bc$ci_dr_pretomanid_s1-data_bc$ci_dr_pretomanid_s7),
  p_value_diff(data_bc$ci_dr_pyrazinamide_s1-data_bc$ci_dr_pyrazinamide_s7),
  paste0("N/A")
)

dr_tbl <- data.frame(drugs,
                          dr_dur_all_s1,
                          dr_dur_all_s7, 
                          dr_dur_diff_all, 
                          dr_dur_diff_all_pval,
                          dr_dur_activeuntr_s1,
                          dr_dur_activeuntr_s7, 
                          dr_dur_diff_activeuntr, 
                          dr_dur_diff_activeuntr_pval,
                          dr_ci_s1,
                          dr_ci_s7, 
                          dr_ci_diff, 
                          dr_ci_diff_pval)

dr_tbl <- rename(dr_tbl,
                  "Drugs" = drugs,
                  "Duration with resistance, 6 months BPaLM, entire cohort (months)" = dr_dur_all_s1,
                  "Duration with resistance, SOC, entire cohort (months)" = dr_dur_all_s7,
                  "Difference in duration, BPaLM vs. SOC, entire cohort" = dr_dur_diff_all,
                  "p-value" = dr_dur_diff_all_pval,
                  "Duration with resistance, 6 months BPaLM, active untreated TB (months)" = dr_dur_activeuntr_s1,
                  "Duration with resistance, SOC, active untreated TB (months)" = dr_dur_activeuntr_s7,
                  "Difference in duration, BPaLM vs. SOC, active untreated TB" = dr_dur_diff_activeuntr,
                  "p-value " = dr_dur_diff_activeuntr_pval,
                  "Lifetime cumulative incidence of resistance, 6 months BPaLM (%)" = dr_ci_s1,
                  "Lifetime cumulative incidence of resistance, SOC (%)" = dr_ci_s7,
                  "Difference in cumulative incidence, BPaLM vs. SOC (p.p.)" = dr_ci_diff,
                  "p-value  " = dr_ci_diff_pval
)


dr_tbl <- tibble(dr_tbl)

# dr_duration_diff_table <- tibble(data.frame(x, 
#                                             drduration_diff_all,
#                                             pvals_all, 
#                                             drduration_diff_activeuntr, 
#                                             pvals_activeuntr))

write.table(dr_tbl, file = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5/tableS5.txt", sep = "|", quote = FALSE, row.names = F)
```

```{r dr plot 4 and 5, echo = FALSE}

x <- c("Amikacin", "Bedaquiline", "Clofazimine", "Cycloserine", "Delamanid", "Ethambutol", "Ethionamide", "Isoniazid", "Linezolid", "Moxifloxacin", "Pretomanid", "Pyrazinamide", "Rifampicin")

#For S1 incremental to S7

## ALL DR DURATION

ymean <- c(
  mean(bc_drduration_all$amikacin_s1_s7),
  mean(bc_drduration_all$bed_s1_s7),
  mean(bc_drduration_all$clofaz_s1_s7),
  mean(bc_drduration_all$cyclos_s1_s7),
  mean(bc_drduration_all$del_s1_s7),
  mean(bc_drduration_all$ethambutol_s1_s7),
  mean(bc_drduration_all$ethionamide_s1_s7),
  mean(bc_drduration_all$isoniazid_s1_s7),
  mean(bc_drduration_all$lin_s1_s7),
  mean(bc_drduration_all$mox_s1_s7),
  mean(bc_drduration_all$pretomanid_s1_s7),
  mean(bc_drduration_all$pyrazinamide_s1_s7),
  mean(bc_drduration_all$rif_s1_s7)
)

ylower <- c(
  quantile(bc_drduration_all$amikacin_s1_s7, 0.025),
  quantile(bc_drduration_all$bed_s1_s7, 0.025),
  quantile(bc_drduration_all$clofaz_s1_s7, 0.025),
  quantile(bc_drduration_all$cyclos_s1_s7, 0.025),
  quantile(bc_drduration_all$del_s1_s7, 0.025),
  quantile(bc_drduration_all$ethambutol_s1_s7, 0.025),
  quantile(bc_drduration_all$ethionamide_s1_s7, 0.025),
  quantile(bc_drduration_all$isoniazid_s1_s7, 0.025),
  quantile(bc_drduration_all$lin_s1_s7, 0.025),
  quantile(bc_drduration_all$mox_s1_s7, 0.025),
  quantile(bc_drduration_all$pretomanid_s1_s7, 0.025),
  quantile(bc_drduration_all$pyrazinamide_s1_s7, 0.025),
  quantile(bc_drduration_all$rif_s1_s7, 0.025)
)

yupper <- c(
  quantile(bc_drduration_all$amikacin_s1_s7, 0.975),
  quantile(bc_drduration_all$bed_s1_s7, 0.975),
  quantile(bc_drduration_all$clofaz_s1_s7, 0.975),
  quantile(bc_drduration_all$cyclos_s1_s7, 0.975),
  quantile(bc_drduration_all$del_s1_s7, 0.975),
  quantile(bc_drduration_all$ethambutol_s1_s7, 0.975),
  quantile(bc_drduration_all$ethionamide_s1_s7, 0.975),
  quantile(bc_drduration_all$isoniazid_s1_s7, 0.975),
  quantile(bc_drduration_all$lin_s1_s7, 0.975),
  quantile(bc_drduration_all$mox_s1_s7, 0.975),
  quantile(bc_drduration_all$pretomanid_s1_s7, 0.975),
  quantile(bc_drduration_all$pyrazinamide_s1_s7, 0.975),
  quantile(bc_drduration_all$rif_s1_s7, 0.975)
)

pop <- rep("Entire cohort", 13)

plot4_data_a <- data.frame(x, ymean, ylower, yupper, pop)


## DR DURATION ONLY AMONG THOSE WITH ACTIVE, UNTREATED TB 

ymean <- c(
  mean(bc_drduration_activeuntr$amikacin_s1_s7),
  mean(bc_drduration_activeuntr$bed_s1_s7),
  mean(bc_drduration_activeuntr$clofaz_s1_s7),
  mean(bc_drduration_activeuntr$cyclos_s1_s7),
  mean(bc_drduration_activeuntr$del_s1_s7),
  mean(bc_drduration_activeuntr$ethambutol_s1_s7),
  mean(bc_drduration_activeuntr$ethionamide_s1_s7),
  mean(bc_drduration_activeuntr$isoniazid_s1_s7),
  mean(bc_drduration_activeuntr$lin_s1_s7),
  mean(bc_drduration_activeuntr$mox_s1_s7),
  mean(bc_drduration_activeuntr$pretomanid_s1_s7),
  mean(bc_drduration_activeuntr$pyrazinamide_s1_s7),
  mean(bc_drduration_activeuntr$rif_s1_s7)
)

ylower <- c(
  quantile(bc_drduration_activeuntr$amikacin_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$bed_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$clofaz_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$cyclos_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$del_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$ethambutol_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$ethionamide_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$isoniazid_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$lin_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$mox_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$pretomanid_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$pyrazinamide_s1_s7, 0.025),
  quantile(bc_drduration_activeuntr$rif_s1_s7, 0.025)
)

yupper <- c(
  quantile(bc_drduration_activeuntr$amikacin_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$bed_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$clofaz_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$cyclos_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$del_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$ethambutol_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$ethionamide_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$isoniazid_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$lin_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$mox_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$pretomanid_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$pyrazinamide_s1_s7, 0.975),
  quantile(bc_drduration_activeuntr$rif_s1_s7, 0.975)
)

pop <- rep("Only those with higher\ntransmission risk\n(i.e., active TB no\nlonger receiving \ntreatment)", 13)

plot4_data_b <- data.frame(x, ymean, ylower, yupper, pop)

plot4_data <- rbind(plot4_data_a, plot4_data_b)


ggplot(plot4_data_a,aes(x, ymean, col = pop)) + 
  geom_point(size=1.5, position = position_nudge(x = 0.35)) + 
  scale_colour_manual(values=c('darkslategrey', "aquamarine"))+
  theme_bw() +
  geom_errorbar(aes(ymin=ylower,ymax=yupper, width=0.2),
                position = position_nudge(x = 0.35)) +
  geom_point(data = plot4_data_b, mapping = aes(x = x, y = ymean), size = 1.5, 
             position = position_nudge(x = 0.65)) +
  geom_errorbar(data = plot4_data_b, mapping = aes(ymin= ylower, ymax = yupper, width = 0.2), 
                position = position_nudge(x = 0.65)) +
  labs(x = "Drug", y = "Difference in the mean duration with TB disease \n resistant to each drug (months)",
       color = "Counting time with \nresistance among:", width = 2) +
  # scale_y_continuous("Difference in the mean duration with TB disease \n resistant to each drug (months)") +
  #ylim(-6,2) + 
  geom_hline(yintercept=0) + 
  coord_cartesian(ylim=c(-6,2), xlim = c(1.5,13.5), clip="off") + 
  theme(legend.position = c(0.2,0.2)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.7, vjust = 0.8)) +
  theme(plot.margin = margin(0.2, 5, 0.2, 0.2, "cm")) +
  theme(legend.background = element_rect(fill = "white", linetype = "solid", color = "black")) + 
  annotate("segment", x = 14.7, xend = 14.7, y = 0.2, yend = 2,
           colour = "black", linewidth = 1, arrow = arrow()) + 
  annotate("segment", x = 14.7, xend = 14.7, y = -0.2, yend = -2,
           colour = "black", linewidth = 1, arrow = arrow()) + 
  annotate("text", x = 15.2, y = 1.2, label = "BPaLM INCREASES\ntime with TB disease \nresistant to drug, \ncompared to SOC", size = 3, hjust=0) +
  annotate("text", x = 15.2, y = -1.1, label = "BPaLM DECREASES\ntime with TB disease \nresistant to drug, \ncompared to SOC", size = 3, hjust=0)

ggsave("Fig3.png", device = "png", 
       path = "Figures_v5",
       scale = 1, width = 18, height = 12, units = "cm"
)

```

#inactive
```{r DR duration totals (not incremental) all, echo = FALSE}

# drugs <- c("Amikacin", "Bedaquiline", "Clofazimine", "Cycloserine", "Delamanid", "Ethambutol", "Ethionamide", "Isoniazid", "Linezolid", "Moxifloxacin", "Pretomanid", "Pyrazinamide", "Rifampicin")
# 
# #S1 
# 
# ymean <- c(
#   mean(bc_drduration_all$t_drduration_amikacin..1.),
#   mean(bc_drduration_all$t_drduration_bed..1.),
#   mean(bc_drduration_all$t_drduration_clofaz..1.),
#   mean(bc_drduration_all$t_drduration_cyclos..1.),
#   mean(bc_drduration_all$t_drduration_del..1.),
#   mean(bc_drduration_all$t_drduration_ethambutol..1.),
#   mean(bc_drduration_all$t_drduration_ethionamide..1.),
#   mean(bc_drduration_all$t_drduration_isoniazid..1.),
#   mean(bc_drduration_all$t_drduration_lin..1.),
#   mean(bc_drduration_all$t_drduration_mox..1.),
#   mean(bc_drduration_all$t_drduration_pretomanid..1.),
#   mean(bc_drduration_all$t_drduration_pyrazinamide..1.),
#   mean(bc_drduration_all$t_duration_rrtb..1.)
# )
# 
# ylower <- c(
#   quantile(bc_drduration_all$t_drduration_amikacin..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_bed..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_clofaz..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_cyclos..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_del..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_ethambutol..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_ethionamide..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_isoniazid..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_lin..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_mox..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_pretomanid..1., 0.025),
#   quantile(bc_drduration_all$t_drduration_pyrazinamide..1., 0.025),
#   quantile(bc_drduration_all$t_duration_rrtb..1., 0.025)
# )
# 
# yupper <- c(
#   quantile(bc_drduration_all$t_drduration_amikacin..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_bed..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_clofaz..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_cyclos..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_del..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_ethambutol..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_ethionamide..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_isoniazid..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_lin..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_mox..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_pretomanid..1., 0.975),
#   quantile(bc_drduration_all$t_drduration_pyrazinamide..1., 0.975),
#   quantile(bc_drduration_all$t_duration_rrtb..1., 0.975)
# )
# 
# Strategy <- rep("(1): 6 months BPaLM", 13)
# 
# plot_s1 <- data.frame(drugs, ymean, ylower, yupper, Strategy)
# 
# # S7
# 
# ymean <- c(
#   mean(bc_drduration_all$t_drduration_amikacin..7.),
#   mean(bc_drduration_all$t_drduration_bed..7.),
#   mean(bc_drduration_all$t_drduration_clofaz..7.),
#   mean(bc_drduration_all$t_drduration_cyclos..7.),
#   mean(bc_drduration_all$t_drduration_del..7.),
#   mean(bc_drduration_all$t_drduration_ethambutol..7.),
#   mean(bc_drduration_all$t_drduration_ethionamide..7.),
#   mean(bc_drduration_all$t_drduration_isoniazid..7.),
#   mean(bc_drduration_all$t_drduration_lin..7.),
#   mean(bc_drduration_all$t_drduration_mox..7.),
#   mean(bc_drduration_all$t_drduration_pretomanid..7.),
#   mean(bc_drduration_all$t_drduration_pyrazinamide..7.),
#   mean(bc_drduration_all$t_duration_rrtb..7.)
# )
# 
# ylower <- c(
#   quantile(bc_drduration_all$t_drduration_amikacin..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_bed..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_clofaz..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_cyclos..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_del..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_ethambutol..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_ethionamide..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_isoniazid..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_lin..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_mox..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_pretomanid..7., 0.025),
#   quantile(bc_drduration_all$t_drduration_pyrazinamide..7., 0.025),
#   quantile(bc_drduration_all$t_duration_rrtb..7., 0.025)
# )
# 
# yupper <- c(
#   quantile(bc_drduration_all$t_drduration_amikacin..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_bed..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_clofaz..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_cyclos..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_del..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_ethambutol..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_ethionamide..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_isoniazid..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_lin..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_mox..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_pretomanid..7., 0.975),
#   quantile(bc_drduration_all$t_drduration_pyrazinamide..7., 0.975),
#   quantile(bc_drduration_all$t_duration_rrtb..7., 0.975)
# )
# 
# 
# Strategy <- rep("(7): Standard of Care", 13)
# 
# plot_s7 <- data.frame(drugs, ymean, ylower, yupper, Strategy)
# 
# plot <- rbind(plot_s1, plot_s7)
# 
# fig_s8a <- ggplot(plot, aes(x=drugs, y=ymean, fill=Strategy)) + 
#   geom_bar(stat="identity", color="black", 
#            position=position_dodge()) +
#   geom_errorbar(aes(ymin=ylower, ymax=yupper), width=.2,
#                  position=position_dodge(.9)) +
#   labs(x="", y = "Mean cohort duration with resistance, counting time \n among all individuals with TB disease (months)")+
#   theme_bw() +
#   ylim(0, 21) +
#   # scale_fill_manual(values=c('mediumpurple3','mediumpurple1', "steelblue2"))+
#   scale_fill_manual(values=c('magenta3', "steelblue2"))+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
# fig_s8a 

# ggsave("FigS8a.png", device = "png",
#        path = "Figures_v5",
#        scale = 1, width = 18, height = 12, units = "cm"
# )


```

#inactive
```{r DR duration totals (not incremental) active untreated, echo = FALSE}

# drugs <- c("Amikacin", "Bedaquiline", "Clofazimine", "Cycloserine", "Delamanid", "Ethambutol", "Ethionamide", "Isoniazid", "Linezolid", "Moxifloxacin", "Pretomanid", "Pyrazinamide", "Rifampicin")
# 
# # S1
# 
# ymean <- c(
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_del..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..1.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..1.),
#   mean(bc_drduration_activeuntr$t_duration_activetb_untr..1.)
# )
# 
# ylower <- c(
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_del..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..1., 0.025),
#   quantile(bc_drduration_activeuntr$t_duration_activetb_untr..1., 0.025)
# )
# 
# yupper <- c(
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_del..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..1., 0.975),
#   quantile(bc_drduration_activeuntr$t_duration_activetb_untr..1., 0.975)
# )
# 
# Strategy <- rep("(1): 6 months BPaLM", 13)
# 
# plot_s1 <- data.frame(drugs, ymean, ylower, yupper, Strategy)
# 
# # S7
# 
# ymean <- c(
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_del..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7.),
#   mean(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7.),
#   mean(bc_drduration_activeuntr$t_duration_activetb_untr..7.)
# )
# 
# ylower <- c(
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_del..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7., 0.025),
#   quantile(bc_drduration_activeuntr$t_duration_activetb_untr..7., 0.025)
# )
# 
# yupper <- c(
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_amikacin..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_bed..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_clofaz..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_cyclos..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_del..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethambutol..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_ethionamide..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_isoniazid..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_lin..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_mox..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pretomanid..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_drduration_activeuntreated_pyrazinamide..7., 0.975),
#   quantile(bc_drduration_activeuntr$t_duration_activetb_untr..7., 0.975)
# )
# 
# Strategy <- rep("(7): Standard of Care", 13)
# 
# plot_s7 <- data.frame(drugs, ymean, ylower, yupper, Strategy)
# 
# plot <- rbind(plot_s1, plot_s7)
# 
# fig_s8b <- ggplot(plot, aes(x=drugs, y=ymean, fill=Strategy)) + 
#   geom_bar(stat="identity", color="black", 
#            position=position_dodge()) +
#   geom_errorbar(aes(ymin=ylower, ymax=yupper), width=.2,
#                  position=position_dodge(.9)) +
#   labs(x="Drug", y = "Mean cohort duration with resistance, counting time \nonly when individuals have TB disease not currently \nbeing treated (months)")+
#   theme_bw() +
#   ylim(0, 5) +
#   # scale_fill_manual(values=c('mediumpurple3','mediumpurple1', "steelblue2"))+
#   scale_fill_manual(values=c("magenta3", "steelblue2"))+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
# fig_s8b
# 
# fig_s8 <- ggarrange(fig_s8a, fig_s8b,
#                     ncol = 1, nrow = 2,
#                     labels = c("A", "B"),
#                     align = "v",
#                     common.legend = TRUE
#                     )
# fig_s8
# 
# ggsave("FigS9.png", device = "png",
#        path = "Figures_v5",
#        scale = 1, width = 22, height = 26, units = "cm"
# )

```
#############################################################################
#
# SEVERE ADVERSE EVENTS
#
#############################################################################

```{r}

#For main text 
paste0("The total number of SAEs in (1) was ", 
      round(mean(data_bc$t_sae_total_ever..1.),4), 
      "; (95% UI [", 
      round(quantile(data_bc$t_sae_total_ever..1., 0.025),4),
      ", ",
      round(quantile(data_bc$t_sae_total_ever..1., 0.975),4),
      "])"
      )

paste0("The total number of SAEs in (7) was ", 
      round(mean(data_bc$t_sae_total_ever..7.),4), 
      "; (95% UI [", 
      round(quantile(data_bc$t_sae_total_ever..7., 0.025),4),
      ", ",
      round(quantile(data_bc$t_sae_total_ever..7., 0.975),4),
      "])"
      )

paste0("The change in total number of SAEs, (1) compared to (7), was was ", 
      round(mean(data_bc$t_sae_total_ever..1.-data_bc$t_sae_total_ever..7.),4), 
      "; (95% UI [", 
      round(quantile(data_bc$t_sae_total_ever..1.-data_bc$t_sae_total_ever..7., 0.025),4),
      ", ",
      round(quantile(data_bc$t_sae_total_ever..1.-data_bc$t_sae_total_ever..7., 0.975),4),
      "] p=",
      p_value_diff(data_bc$t_sae_total_ever..1.-data_bc$t_sae_total_ever..7.),
      ")"
      )

```


```{r saes, echo = FALSE}

drugs <- c("Amikacin", "Bedaquiline", "Clofazimine", "Cycloserine", "Delamanid", "Ethambutol", "Ethionamide", "Isoniazid", "Linezolid", "Moxifloxacin", "Pretomanid", "Pyrazinamide")

## EVER SAE FOR EACH DRUG, S1

ymean <- c(
  mean(data_bc$t_sae_ever_amikacin..1.),
  mean(data_bc$t_sae_ever_bed..1.),
  mean(data_bc$t_sae_ever_clofaz..1.),
  mean(data_bc$t_sae_ever_cyclos..1.),
  mean(data_bc$t_sae_ever_del..1.),
  mean(data_bc$t_sae_ever_ethambutol..1.),
  mean(data_bc$t_sae_ever_ethionamide..1.),
  mean(data_bc$t_sae_ever_isoniazid..1.),
  mean(data_bc$t_sae_ever_lin..1.),
  mean(data_bc$t_sae_ever_mox..1.),
  mean(data_bc$t_sae_ever_pretomanid..1.),
  mean(data_bc$t_sae_ever_pyrazinamide..1.)
)

ylower <- c(
  quantile(data_bc$t_sae_ever_amikacin..1., 0.025),
  quantile(data_bc$t_sae_ever_bed..1., 0.025),
  quantile(data_bc$t_sae_ever_clofaz..1., 0.025),
  quantile(data_bc$t_sae_ever_cyclos..1., 0.025),
  quantile(data_bc$t_sae_ever_del..1., 0.025),
  quantile(data_bc$t_sae_ever_ethambutol..1., 0.025),
  quantile(data_bc$t_sae_ever_ethionamide..1., 0.025),
  quantile(data_bc$t_sae_ever_isoniazid..1., 0.025),
  quantile(data_bc$t_sae_ever_lin..1., 0.025),
  quantile(data_bc$t_sae_ever_mox..1., 0.025),
  quantile(data_bc$t_sae_ever_pretomanid..1., 0.025),
  quantile(data_bc$t_sae_ever_pyrazinamide..1., 0.025)
)

yupper <- c(
  quantile(data_bc$t_sae_ever_amikacin..1., 0.975),
  quantile(data_bc$t_sae_ever_bed..1., 0.975),
  quantile(data_bc$t_sae_ever_clofaz..1., 0.975),
  quantile(data_bc$t_sae_ever_cyclos..1., 0.975),
  quantile(data_bc$t_sae_ever_del..1., 0.975),
  quantile(data_bc$t_sae_ever_ethambutol..1., 0.975),
  quantile(data_bc$t_sae_ever_ethionamide..1., 0.975),
  quantile(data_bc$t_sae_ever_isoniazid..1., 0.975),
  quantile(data_bc$t_sae_ever_lin..1., 0.975),
  quantile(data_bc$t_sae_ever_mox..1., 0.975),
  quantile(data_bc$t_sae_ever_pretomanid..1., 0.975),
  quantile(data_bc$t_sae_ever_pyrazinamide..1., 0.975)
)

Strategy <- rep("(1): 6 months BPaLM", 12)

plot_sae_s1 <- data.frame(drugs, ymean, ylower, yupper, Strategy)

# AND NOW FOR S7

ymean <- c(
  mean(data_bc$t_sae_ever_amikacin..7.),
  mean(data_bc$t_sae_ever_bed..7.),
  mean(data_bc$t_sae_ever_clofaz..7.),
  mean(data_bc$t_sae_ever_cyclos..7.),
  mean(data_bc$t_sae_ever_del..7.),
  mean(data_bc$t_sae_ever_ethambutol..7.),
  mean(data_bc$t_sae_ever_ethionamide..7.),
  mean(data_bc$t_sae_ever_isoniazid..7.),
  mean(data_bc$t_sae_ever_lin..7.),
  mean(data_bc$t_sae_ever_mox..7.),
  mean(data_bc$t_sae_ever_pretomanid..7.),
  mean(data_bc$t_sae_ever_pyrazinamide..7.)
)

ylower <- c(
  quantile(data_bc$t_sae_ever_amikacin..7., 0.025),
  quantile(data_bc$t_sae_ever_bed..7., 0.025),
  quantile(data_bc$t_sae_ever_clofaz..7., 0.025),
  quantile(data_bc$t_sae_ever_cyclos..7., 0.025),
  quantile(data_bc$t_sae_ever_del..7., 0.025),
  quantile(data_bc$t_sae_ever_ethambutol..7., 0.025),
  quantile(data_bc$t_sae_ever_ethionamide..7., 0.025),
  quantile(data_bc$t_sae_ever_isoniazid..7., 0.025),
  quantile(data_bc$t_sae_ever_lin..7., 0.025),
  quantile(data_bc$t_sae_ever_mox..7., 0.025),
  quantile(data_bc$t_sae_ever_pretomanid..7., 0.025),
  quantile(data_bc$t_sae_ever_pyrazinamide..7., 0.025)
)

yupper <- c(
  quantile(data_bc$t_sae_ever_amikacin..7., 0.975),
  quantile(data_bc$t_sae_ever_bed..7., 0.975),
  quantile(data_bc$t_sae_ever_clofaz..7., 0.975),
  quantile(data_bc$t_sae_ever_cyclos..7., 0.975),
  quantile(data_bc$t_sae_ever_del..7., 0.975),
  quantile(data_bc$t_sae_ever_ethambutol..7., 0.975),
  quantile(data_bc$t_sae_ever_ethionamide..7., 0.975),
  quantile(data_bc$t_sae_ever_isoniazid..7., 0.975),
  quantile(data_bc$t_sae_ever_lin..7., 0.975),
  quantile(data_bc$t_sae_ever_mox..7., 0.975),
  quantile(data_bc$t_sae_ever_pretomanid..7., 0.975),
  quantile(data_bc$t_sae_ever_pyrazinamide..7., 0.975)
)

Strategy <- rep("(7): Standard of Care", 12)

plot_sae_s7 <- data.frame(drugs, ymean, ylower, yupper, Strategy)

# plot_sae <- rbind(plot_sae_sr1, plot_sae_sr2)
# plot_sae <- rbind(plot_sae, plot_sae_who)

plot_sae <- rbind(plot_sae_s1, plot_sae_s7)

ggplot(plot_sae, aes(x=drugs, y=ymean, fill=Strategy)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  geom_errorbar(aes(ymin=ylower, ymax=yupper), width=.2,
                 position=position_dodge(.9)) +
  labs(x="Drug", y = "Lifetime cumulative incidence of Grade 4-5 SAEs\n(per patient)")+
  theme_classic() +
  ylim(0, 0.25) +
  # scale_fill_manual(values=c('mediumpurple3','mediumpurple1', "steelblue2"))+
  scale_fill_manual(values=c('magenta3', "steelblue2"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

ggsave("Fig4.png", device = "png", 
       path = "Figures_v5",
       scale = 1, width = 18, height = 12, units = "cm"
)
```


#############################################################################
#
# SENSITIVITY ANALYSIS ON THE HRR FOR CURE IN THE BPaLM REGIMEN 
#
#############################################################################

```{r process data 2, echo=FALSE}

#Copy and paste this chunk wherever you need to change the input file 

WTP <- WTP_L

# Load the main csv file, all patients 
data_bc <- read.csv("Results/TreeAgeOutputHRRSensAnal_20231225.csv")
data_bc <- data.frame(data_bc)

data_temp_health <- fn_process_healthoutcomes(data_bc)
data_temp_droutcomes <- fn_process_droutcomes(data_bc)

bc_QALY_d <- data.frame(data_temp_health[1:18])
bc_QALY_und <- data.frame(data_temp_health[19:36])
bc_LY_und <- data.frame(data_temp_health[37:54])
bc_totalcost_d <- data.frame(data_temp_health[55:72])
bc_totalcost_und <- data.frame(data_temp_health[73:90])
bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
bc_indirectcost_und <- data.frame(data_temp_health[127:144])
bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
bc_NMB <- data.frame(data_temp_health[163:180])
bc_NHB <- data.frame(data_temp_health[181:198])


bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])

WTP <- WTP_U

data_temp_health <- fn_process_healthoutcomes(data_bc)

bc_NMB_U <- data.frame(data_temp_health[163:180])
bc_NHB_U <- data.frame(data_temp_health[181:198])

WTP <- WTP_L

```

```{r HRR SA, echo=FALSE}
######################################################
# First, Run the above code instead for the SA on HRR
######################################################

### NHB 

# First graph the NHB of the three strategies as a function of the HRR
sa1.1 <- ggplot(bc_NHB, aes(dist_HRR_cure_SensAnalysis, s1_s7)) + 
  geom_point(size=0.1, color="turquoise4") + 
  labs(x = "", y = "Incremental NHB (QALYs)", width = 2) +
  ylim(-1,2.5) + 
  geom_hline(yintercept=0) +
  geom_vline(xintercept=1.59, linetype = "dashed") +
  # ggtitle("Sensitivity Analysis on the HRR of cure for BPaLM compared to the SOC regimens (conditional on the same number of effective drugs)") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) + 
  geom_smooth(color = "red", level = 0) + 
  theme_bw() + 
  theme(text = element_text(size = 14)) +
  annotate(geom = "text", x = 1.56, y = 2.1, label = "Base case", angle = 90, size = 5) + 
  annotate(geom = "text", x = 1.62, y = 2.1, label = "HRR = 1.59", angle = 90, size = 5)
sa1.1

```

```{r HRR SA, echo=FALSE}
### QALYs

sa2.1 <- ggplot(bc_QALY_und, aes(dist_HRR_cure_SensAnalysis, s1_s7)) + 
  geom_point(size=0.1, color="turquoise4") + 
  labs(x = "", y = "Incremental QALYs", width = 2) +
  ylim(-1.5,1.5) + 
  geom_hline(yintercept=0) +
  geom_vline(xintercept=1.59, linetype = "dashed") +
  # ggtitle("Sensitivity Analysis on the HRR of cure for Simplified Regimens compared to the \n WHO regimens (conditional on the same number of effective drugs)") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) + 
  geom_smooth(color = "red", level = 0) + 
  theme_bw() +
  theme(text = element_text(size = 14))

  #annotate(geom = "text", x = 1.54, y = 0.9, label = "Base case", angle = 90, size = 4) + 
  #annotate(geom = "text", x = 1.64, y = 0.9, label = "HRR = 1.59", angle = 90, size = 4)
sa2.1
```

```{r HRR SA, echo=FALSE}
### LYs

sa3.1 <- ggplot(bc_LY_und, aes(dist_HRR_cure_SensAnalysis, s1_s7)) + 
  geom_point(size=0.1, color="turquoise4") + 
  labs(x = "HRR of cure for BPaLM compared to the SOC", y = "Incremental Life Years", width = 2) +
  ylim(-1.5,1) + 
  geom_hline(yintercept=0) +
  geom_vline(xintercept=1.59, linetype = "dashed") +
  # ggtitle("Sensitivity Analysis on the HRR of cure for Simplified Regimens compared to the \n WHO regimens (conditional on the same number of effective drugs)") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) + 
  geom_smooth(color = "red", level = 0) + 
  theme_bw() +
  theme(text = element_text(size = 14)) +
  annotate(geom = "text", x = 1.55, y = 0.7, label = "Base case", angle = 90, size = 5) + 
  annotate(geom = "text", x = 1.63, y = 0.7, label = "HRR = 1.59", angle = 90, size =5)
sa3.1
```

```{r HRR SA, echo=FALSE}
### Cost

sa4.1 <- ggplot(bc_totalcost_und, aes(dist_HRR_cure_SensAnalysis, s1_s7)) + 
  geom_point(size=0.1, color="turquoise4") + 
  labs(x = "HRR of cure for BPaLM compared to the SOC", y = "Incremental Total Cost (2022 USD)", width = 2) +
  ylim(-8000,1000) + 
  geom_hline(yintercept=0) +
  geom_vline(xintercept=1.59, linetype = "dashed") +
  # ggtitle("Sensitivity Analysis on the HRR of cure for Simplified Regimens compared to the \n WHO regimens (conditional on the same number of effective drugs)") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) + 
  geom_smooth(color = "red", level = 0) + 
  theme_bw() +
  theme(text = element_text(size = 14)) 
  #annotate(geom = "text", x = 1.54, y = 0.9, label = "Base case", angle = 90, size = 4) + 
  #annotate(geom = "text", x = 1.64, y = 0.9, label = "HRR = 1.59", angle = 90, size = 4)
sa4.1
```

#############################################################################
#
# SENSITIVITY ANALYSIS ON THE PROPORTION WITH FQ RESISTANCE
#
#############################################################################

```{r process data 3, echo=FALSE}

#Copy and paste this chunk wherever you need to change the input file 

WTP <- WTP_L

# Load the main csv file, all patients 
data_bc <- read.csv("Results/TreeAgeOutputFQRSensAnal_20231227.csv")
data_bc <- data.frame(data_bc)

data_temp_health <- fn_process_healthoutcomes(data_bc)
data_temp_droutcomes <- fn_process_droutcomes(data_bc)

bc_QALY_d <- data.frame(data_temp_health[1:18])
bc_QALY_und <- data.frame(data_temp_health[19:36])
bc_LY_und <- data.frame(data_temp_health[37:54])
bc_totalcost_d <- data.frame(data_temp_health[55:72])
bc_totalcost_und <- data.frame(data_temp_health[73:90])
bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
bc_indirectcost_und <- data.frame(data_temp_health[127:144])
bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
bc_NMB <- data.frame(data_temp_health[163:180])
bc_NHB <- data.frame(data_temp_health[181:198])


bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])

WTP <- WTP_U

data_temp_health <- fn_process_healthoutcomes(data_bc)

bc_NMB_U <- data.frame(data_temp_health[163:180])
bc_NHB_U <- data.frame(data_temp_health[181:198])

WTP <- WTP_L


```

```{r FQR SA, echo=FALSE}
######################################################
# First, Run the above code instead for the SA on FQR
######################################################

### NHB 

# First graph the NHB of the strategies as a function of the FQR proportion
sa1.2 <- ggplot(bc_NHB, aes(dist_FQR, s1_s7)) + 
  geom_point(size=0.1, color="turquoise4") + 
  labs(x = "", y = str_wrap(""), width = 2) +
  ylim(-1,2.5) + 
  geom_hline(yintercept=0) +
  geom_vline(xintercept=0.28, linetype = "dashed") +
  # ggtitle("Sensitivity Analysis on the Prevalence of Fluoroquinolone Resistance") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) + 
  geom_smooth(color = "red", level = 0) + 
  theme_bw() + 
  theme(text = element_text(size = 14)) +
  annotate(geom = "text", x = 0.265, y = 2.1, label = "Base case", angle = 90, size = 5) + 
  annotate(geom = "text", x = 0.305, y = 2.1, label = "prevalence \n= 0.28", angle = 90, size = 5)

sa1.2
```


```{r FQR SA, echo=FALSE}
### QALYs

sa2.2 <- ggplot(bc_QALY_und, aes(dist_FQR, s1_s7)) + 
  geom_point(size=0.1, color="turquoise4") + 
  labs(x = "", y = str_wrap(""), width = 2) +
  ylim(- 1.5 , 1.5) + 
  geom_hline(yintercept=0) +
  geom_vline(xintercept=0.28, linetype = "dashed") +
  # ggtitle("Sensitivity Analysis on the Prevalence of Fluoroquinolone Resistance") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) + 
  geom_smooth(color = "red", level = 0) + 
  theme_bw() +
  theme(text = element_text(size = 14)) 
#+ 
  # annotate(geom = "text", x = 0.27, y = -0.75, label = "Base case value", angle = 90, size = 3) + 
  # annotate(geom = "text", x = 0.29, y = -0.75, label = "prevalence = 0.28", angle = 90, size = 3)

sa2.2
```



```{r FQR SA, echo=FALSE}
### LYs

sa3.2 <- ggplot(bc_LY_und, aes(dist_FQR, s1_s7)) + 
  geom_point(size=0.1, color="turquoise4") + 
  labs(x = "Prevalence of FQR among patients with RR-TB", y = "", width = 2) +
  ylim(- 1.5, 1 ) + 
  geom_hline(yintercept=0) +
  geom_vline(xintercept=0.28, linetype = "dashed") +
  # ggtitle("Sensitivity Analysis on the Prevalence of Fluoroquinolone Resistance") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) + 
  geom_smooth(color = "red", level = 0) +
  theme_bw() +
  theme(text = element_text(size = 14)) +
  annotate(geom = "text", x = 0.265, y = 0.7, label = "Base case", angle = 90, size = 5) + 
  annotate(geom = "text", x = 0.305, y = 0.7, label = "prevalence\n= 0.28", angle = 90, size = 5)

sa3.2
```


```{r FQR SA, echo=FALSE}

### Total cost

# First graph the NMB of the strategies as a function of the FQR proportion
sa4.2 <- ggplot(bc_totalcost_und, aes(dist_FQR, s1_s7)) + 
  geom_point(size=0.1, color="turquoise4") + 
  labs(x = "Prevalence of FQ resistance among RR-TB", y = str_wrap(""), width = 2) +
  ylim(-8000,1000) + 
  geom_hline(yintercept=0) +
  geom_vline(xintercept=0.28, linetype = "dashed") +
  # ggtitle("Sensitivity Analysis on the Prevalence of Fluoroquinolone Resistance") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) + 
  geom_smooth(color = "red", level = 0) + 
  theme_bw() +
  theme(text = element_text(size = 14))

  # annotate(geom = "text", x = 0.27, y = 7500, label = "Base case value", angle = 90, size = 3) + 
  # annotate(geom = "text", x = 0.29, y = 7500, label = "prevalence = 0.28", angle = 90, size = 3)

sa4.2
```


```{r combine sa plots}
fig_sa <- ggarrange(sa1.1, sa1.2, sa2.1, sa2.2, sa4.1, sa4.2,
                    ncol = 2, nrow = 3, align = "v")
fig_sa

ggsave("Fig5.png", device = "png", 
       path = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5",
       scale = 1
       , width = 28, height = 33, units = "cm"
)


#LYs only for supplement
fig_sa_ly <- ggarrange(sa3.1, sa3.2,
                    ncol = 2, nrow = 1, align = "h")
fig_sa_ly

ggsave("FigS8.png", device = "png", 
       path = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5",
       scale = 1
       , width = 28, height = 11, units = "cm"
)
```


####
# RUN BELOW FOR DEBUGGING ONLY 
####

# ```{r FQR SA, echo=FALSE}
# # BONUS QALYs figure, non-incremental
# 
# sa9.9 <- ggplot(bc_QALY, aes(dist_FQR, sr1)) +
#   geom_point(size=0.1, color="turquoise4") +
#   geom_point(aes(dist_FQR, who), size=0.1, color = "red") +
#   labs(x = "Prevalence of FQR among patients with RR-TB", y = str_wrap("Incremental QALE of SR1 compared to WHO (QALYs)"), width = 2) +
#   ylim(8, 14) +
#   geom_hline(yintercept=0) +
#   geom_vline(xintercept=0.28, linetype = "dashed") +
#   # ggtitle("Sensitivity Analysis on the Prevalence of Fluoroquinolone Resistance") +
#   theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) +
#   geom_smooth(aes(dist_FQR, sr1), color = "turquoise4", level = 0) +
#   geom_smooth(aes(dist_FQR, who), color = "red", level = 0) +
#   theme_bw() +
#   annotate(geom = "text", x = 0.27, y = -0.75, label = "Base case value", angle = 90, size = 3) +
#   annotate(geom = "text", x = 0.29, y = -0.75, label = "prevalence = 0.28", angle = 90, size = 3)
# 
# sa9.9
# 
# ggsave("Fig_SA_FQR_absoluteQALYs", device = "png",
#        path = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5",
#        scale = 1, width = 18, height = 12, units = "cm"
# )
# ```
# 
# ```{r FQR SA, echo=FALSE}
# ### BONUS LYs figure, non-incremental
# 
# sa9.10 <- ggplot(bc_LY, aes(dist_FQR, sr1)) +
#   geom_point(size=0.1, color="turquoise4") +
#   geom_point(aes(dist_FQR, who), size=0.1, color = "red") +
#   labs(x = "Prevalence of FQR among patients with RR-TB", y = str_wrap("Incremental LE of SR1 compared to WHO (LYs)"), width = 2) +
#   ylim(8, 14) +
#   geom_hline(yintercept=0) +
#   geom_vline(xintercept=0.28, linetype = "dashed") +
#   # ggtitle("Sensitivity Analysis on the Prevalence of Fluoroquinolone Resistance") +
#   theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1)) +
#   geom_smooth(aes(dist_FQR, sr1), color = "turquoise4", level = 0) +
#   geom_smooth(aes(dist_FQR, who), color = "red", level = 0) +
#   theme_bw() +
#   annotate(geom = "text", x = 0.27, y = -0.75, label = "Base case value", angle = 90, size = 3) +
#   annotate(geom = "text", x = 0.29, y = -0.75, label = "prevalence = 0.28", angle = 90, size = 3)
# 
# sa9.10
# 
# ggsave("Fig_SA_FQR_absoluteLYs", device = "png",
#        path = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5",
#        scale = 1, width = 18, height = 12, units = "cm"
# )
# ```

#############################################################################
#
# SCENARIO ANALYSIS INCORPORATING POSTFATAL PRODUCTIVITY LOSSES
#
#############################################################################

# Removed from manuscript as didn't provide any valuable insight (negligible change) 

# ```{r process data 5, echo=FALSE}
# 
# #Copy and paste this chunk wherever you need to change the input file 
# 
# WTP <- WTP_L
# 
# # Load the main csv file, all patients 
# data_bc <- read.csv("Results/TreeAgeOutputBaseCase_20230418.csv")
# data_bc <- data.frame(data_bc)
# 
# data_temp_health <- fn_process_healthoutcomes(data_bc)
# data_temp_droutcomes <- fn_process_droutcomes(data_bc)
# 
# bc_QALY_d <- data.frame(data_temp_health[1:18])
# bc_QALY_und <- data.frame(data_temp_health[19:36])
# bc_LY_und <- data.frame(data_temp_health[37:54])
# bc_totalcost_d <- data.frame(data_temp_health[55:72])
# bc_totalcost_und <- data.frame(data_temp_health[73:90])
# bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
# bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
# bc_indirectcost_und <- data.frame(data_temp_health[127:144])
# bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
# bc_NMB <- data.frame(data_temp_health[163:180])
# bc_NHB <- data.frame(data_temp_health[181:198])
# 
# 
# bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
# bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])
# 
# WTP <- WTP_U
# 
# data_temp_health <- fn_process_healthoutcomes(data_bc)
# 
# bc_NMB_U <- data.frame(data_temp_health[163:180])
# bc_NHB_U <- data.frame(data_temp_health[181:198])
# 
# WTP <- WTP_L
# 
# ```


#############################################################################
#
# VALIDATION FIGURES 
#
#############################################################################

```{r process data 6, echo=FALSE}

#Copy and paste this chunk wherever you need to change the input file 

WTP <- WTP_L

# Load the main csv file, all patients 
data_bc <- read.csv("Results/TreeAgeOutputBaseCase_20231221.csv")
data_bc <- data.frame(data_bc)

data_temp_health <- fn_process_healthoutcomes(data_bc)
data_temp_droutcomes <- fn_process_droutcomes(data_bc)

bc_QALY_d <- data.frame(data_temp_health[1:18])
bc_QALY_und <- data.frame(data_temp_health[19:36])
bc_LY_und <- data.frame(data_temp_health[37:54])
bc_totalcost_d <- data.frame(data_temp_health[55:72])
bc_totalcost_und <- data.frame(data_temp_health[73:90])
bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
bc_indirectcost_und <- data.frame(data_temp_health[127:144])
bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
bc_NMB <- data.frame(data_temp_health[163:180])
bc_NHB <- data.frame(data_temp_health[181:198])


bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])

WTP <- WTP_U

data_temp_health <- fn_process_healthoutcomes(data_bc)

bc_NMB_U <- data.frame(data_temp_health[163:180])
bc_NHB_U <- data.frame(data_temp_health[181:198])

WTP <- WTP_L

```

```{r validation figure ALL, echo=FALSE}
#Validation figure

who_data_mdr <- read.csv("/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/WHO_data_mdr.csv")

model_s7 <- c(0, 
               0, 
               mean(data_bc$t_failed_eot..7.), 
               mean(data_bc$t_ltfu_eot..7.),
               mean(data_bc$t_death_eot..7.),
               0)
model_s7[2] <- 1-sum(model_s7)
model_s7[1] <- 9001

model_s1 <- c(0,
               0, 
               mean(data_bc$t_failed_eot..1.), 
               mean(data_bc$t_ltfu_eot..1.),
               mean(data_bc$t_death_eot..1.),
               0)

model_s1[2] <- 1-sum(model_s1)
model_s1[1] <- 9002

for(i in 1:nrow(who_data_mdr)){
  for(j in 2:6){
    who_data_mdr[i,j] <- who_data_mdr[i,j]/who_data_mdr[i,7]
  }
}

who_data_mdr <- who_data_mdr[,-7]

who_data_mdr <- rbind(who_data_mdr, model_s7)
who_data_mdr <- rbind(who_data_mdr, model_s1)

who_data_mdr2 <- rbind(who_data_mdr, who_data_mdr)
who_data_mdr2 <- rbind(who_data_mdr2, who_data_mdr)
who_data_mdr2 <- rbind(who_data_mdr2, who_data_mdr)
who_data_mdr2 <- rbind(who_data_mdr2, who_data_mdr)

Value <- rep(0,60)
Outcome <- rep(0, 60)
who_data_mdr2 <- cbind(who_data_mdr2, Value)
who_data_mdr2 <- cbind(who_data_mdr2, Outcome)

for(i in 1:12){
  who_data_mdr2[i,7] <- who_data_mdr2[i,6]
  who_data_mdr2[i,8] <- "1"
}

for(i in 13:24){
  who_data_mdr2[i,7] <- who_data_mdr2[i,4]
  who_data_mdr2[i,8] <- "2"
}

for(i in 25:36){
  who_data_mdr2[i,7] <- who_data_mdr2[i,5]
  who_data_mdr2[i,8] <- "3"
}

for(i in 37:48){
  who_data_mdr2[i,7] <- who_data_mdr2[i,3]
  who_data_mdr2[i,8] <- "4"
}

for(i in 49:60){
  who_data_mdr2[i,7] <- who_data_mdr2[i,2]
  who_data_mdr2[i,8] <- "5"
}

who_data_mdr2 <- who_data_mdr2[,-(2:6)]

who_data_mdr2 <- data.frame(who_data_mdr2)
who_data_mdr2$Value <- as.numeric(who_data_mdr2$Value)
who_data_mdr2$Year <- as.character(who_data_mdr2$Year)

fig_s11 <- ggplot(data = who_data_mdr2,
       aes(fill = Outcome, y = Value, x = Year)) +
 geom_col(position = "fill",
          width = 0.8) +
  labs(x = " ", y = "Proportion", fill = "End of Treatment \nOutcome") + 
  scale_fill_manual(labels = c("Not Evaluated", "Dead", "LTFU", "Failed by Treatment", "Success"), 
                     values = c("grey", "purple4", "mediumorchid1", "plum1", "turquoise4")) +
  theme_bw() + 
  scale_x_discrete(labels = c("2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019",
                              "Strategy (7)\nStandard\nof Care\n", "Strategy (1)\n6 months\nBPaLM")) + 
  geom_vline(xintercept = 10.5, linetype = "dashed", color = "gray3") + 
  annotate("text", x = 11.5, y = -0.27, label = "Modeled \nEstimates") + 
  annotate("text", x = 6, y = -0.25, label = "Data reported to WHO") + 
  coord_cartesian(ylim=c(0,1),clip="off") + 
  theme(plot.margin = margin(0.5, 0, 2, 0, "cm")) + 
  annotate("segment", x = 0.7, xend = 10.3, y = -0.2, yend = -0.2) + 
  annotate("segment", x = 10.7, xend = 12.3, y = -0.2, yend = -0.2)
fig_s11

ggsave("FigS9.png", device = "png", 
       scale = 1, width = 27, height = 14, units = "cm"
)
```

#############################################################################
#
# CUMULATIVE INCIDENCE OF RESISTANCE
#
#############################################################################

#inactive
```{r cumulative incidence of resistance, echo = FALSE }

# drugs <- c("Amikacin", "Bedaquiline", "Clofazimine", "Cycloserine", "Delamanid", "Ethambutol", "Ethionamide", "Isoniazid", "Linezolid", "Moxifloxacin", "Pretomanid", "Pyrazinamide")
# 
# #For SR1 incremental to WHO 
# 
# data_bc$ci_dr_amikacin_s1 <- data_bc$t_dr_amikacin..1.-
#   data_bc$t_drp_amikacin..1.
# data_bc$ci_dr_bed_s1 <- data_bc$t_dr_bed..1.-
#   data_bc$t_drp_bed..1.
# data_bc$ci_dr_clofaz_s1 <- data_bc$t_dr_clofaz..1.-
#   data_bc$t_drp_clofaz..1.
# data_bc$ci_dr_cyclos_s1 <- data_bc$t_dr_cyclos..1.-
#   data_bc$t_drp_cyclos..1.
# data_bc$ci_dr_del_s1 <- data_bc$t_dr_del..1.-
#   data_bc$t_drp_del..1.
# data_bc$ci_dr_ethambutol_s1 <- data_bc$t_dr_ethambutol..1.-
#   data_bc$t_drp_ethambutol..1.
# data_bc$ci_dr_ethionamide_s1 <- data_bc$t_dr_ethionamide..1.-
#   data_bc$t_drp_ethionamide..1.
# data_bc$ci_dr_isoniazid_s1 <- data_bc$t_dr_isoniazid..1.-
#   data_bc$t_drp_isoniazid..1.
# data_bc$ci_dr_lin_s1 <- data_bc$t_dr_lin..1.-
#   data_bc$t_drp_lin..1.
# data_bc$ci_dr_mox_s1 <- data_bc$t_dr_mox..1.-
#   data_bc$t_drp_mox..1.
# data_bc$ci_dr_pretomanid_s1 <- data_bc$t_dr_pretomanid..1.-
#   data_bc$t_drp_pretomanid..1.
# data_bc$ci_dr_pyrazinamide_s1 <- data_bc$t_dr_pyrazinamide..1.-
#   data_bc$t_drp_pyrazinamide..1.
# 
# data_bc$ci_dr_amikacin_s7 <- data_bc$t_dr_amikacin..7.-
#   data_bc$t_drp_amikacin..7.
# data_bc$ci_dr_bed_s7 <- data_bc$t_dr_bed..7.-
#   data_bc$t_drp_bed..7.
# data_bc$ci_dr_clofaz_s7 <- data_bc$t_dr_clofaz..7.-
#   data_bc$t_drp_clofaz..7.
# data_bc$ci_dr_cyclos_s7 <- data_bc$t_dr_cyclos..7.-
#   data_bc$t_drp_cyclos..7.
# data_bc$ci_dr_del_s7 <- data_bc$t_dr_del..7.-
#   data_bc$t_drp_del..7.
# data_bc$ci_dr_ethambutol_s7 <- data_bc$t_dr_ethambutol..7.-
#   data_bc$t_drp_ethambutol..7.
# data_bc$ci_dr_ethionamide_s7 <- data_bc$t_dr_ethionamide..7.-
#   data_bc$t_drp_ethionamide..7.
# data_bc$ci_dr_isoniazid_s7 <- data_bc$t_dr_isoniazid..7.-
#   data_bc$t_drp_isoniazid..7.
# data_bc$ci_dr_lin_s7 <- data_bc$t_dr_lin..7.-
#   data_bc$t_drp_lin..7.
# data_bc$ci_dr_mox_s7 <- data_bc$t_dr_mox..7.-
#   data_bc$t_drp_mox..7.
# data_bc$ci_dr_pretomanid_s7 <- data_bc$t_dr_pretomanid..7.-
#   data_bc$t_drp_pretomanid..7.
# data_bc$ci_dr_pyrazinamide_s7 <- data_bc$t_dr_pyrazinamide..7.-
#   data_bc$t_drp_pyrazinamide..7.
# 
#   
# ymean <- c(
#   mean(data_bc$ci_dr_amikacin_s1),
#   mean(data_bc$ci_dr_bed_s1),
#   mean(data_bc$ci_dr_clofaz_s1),
#   mean(data_bc$ci_dr_cyclos_s1),
#   mean(data_bc$ci_dr_del_s1),
#   mean(data_bc$ci_dr_ethambutol_s1),
#   mean(data_bc$ci_dr_ethionamide_s1),
#   mean(data_bc$ci_dr_isoniazid_s1),
#   mean(data_bc$ci_dr_lin_s1),
#   mean(data_bc$ci_dr_mox_s1),
#   mean(data_bc$ci_dr_pretomanid_s1),
#   mean(data_bc$ci_dr_pyrazinamide_s1)
# )
# 
# ylower <- c(
#   quantile(data_bc$ci_dr_amikacin_s1, 0.025),
#   quantile(data_bc$ci_dr_bed_s1, 0.025),
#   quantile(data_bc$ci_dr_clofaz_s1, 0.025),
#   quantile(data_bc$ci_dr_cyclos_s1, 0.025),
#   quantile(data_bc$ci_dr_del_s1, 0.025),
#   quantile(data_bc$ci_dr_ethambutol_s1, 0.025),
#   quantile(data_bc$ci_dr_ethionamide_s1, 0.025),
#   quantile(data_bc$ci_dr_isoniazid_s1, 0.025),
#   quantile(data_bc$ci_dr_lin_s1, 0.025),
#   quantile(data_bc$ci_dr_mox_s1, 0.025),
#   quantile(data_bc$ci_dr_pretomanid_s1, 0.025),
#   quantile(data_bc$ci_dr_pyrazinamide_s1, 0.025)
# )
# 
# yupper <- c(
#   quantile(data_bc$ci_dr_amikacin_s1, 0.975),
#   quantile(data_bc$ci_dr_bed_s1, 0.975),
#   quantile(data_bc$ci_dr_clofaz_s1, 0.975),
#   quantile(data_bc$ci_dr_cyclos_s1, 0.975),
#   quantile(data_bc$ci_dr_del_s1, 0.975),
#   quantile(data_bc$ci_dr_ethambutol_s1, 0.975),
#   quantile(data_bc$ci_dr_ethionamide_s1, 0.975),
#   quantile(data_bc$ci_dr_isoniazid_s1, 0.975),
#   quantile(data_bc$ci_dr_lin_s1, 0.975),
#   quantile(data_bc$ci_dr_mox_s1, 0.975),
#   quantile(data_bc$ci_dr_pretomanid_s1, 0.975),
#   quantile(data_bc$ci_dr_pyrazinamide_s1, 0.975)
# )
# 
# Strategy <- rep("(1): 6 months BPaLM", 12)
# 
# plot_ci_dr_s1 <- data.frame(drugs, ymean, ylower, yupper, Strategy)
# 
# 
# # and now for who 
# 
# ymean <- c(
#   mean(data_bc$ci_dr_amikacin_s7),
#   mean(data_bc$ci_dr_bed_s7),
#   mean(data_bc$ci_dr_clofaz_s7),
#   mean(data_bc$ci_dr_cyclos_s7),
#   mean(data_bc$ci_dr_del_s7),
#   mean(data_bc$ci_dr_ethambutol_s7),
#   mean(data_bc$ci_dr_ethionamide_s7),
#   mean(data_bc$ci_dr_isoniazid_s7),
#   mean(data_bc$ci_dr_lin_s7),
#   mean(data_bc$ci_dr_mox_s7),
#   mean(data_bc$ci_dr_pretomanid_s7),
#   mean(data_bc$ci_dr_pyrazinamide_s7)
# )
# 
# ylower <- c(
#   quantile(data_bc$ci_dr_amikacin_s7, 0.025),
#   quantile(data_bc$ci_dr_bed_s7, 0.025),
#   quantile(data_bc$ci_dr_clofaz_s7, 0.025),
#   quantile(data_bc$ci_dr_cyclos_s7, 0.025),
#   quantile(data_bc$ci_dr_del_s7, 0.025),
#   quantile(data_bc$ci_dr_ethambutol_s7, 0.025),
#   quantile(data_bc$ci_dr_ethionamide_s7, 0.025),
#   quantile(data_bc$ci_dr_isoniazid_s7, 0.025),
#   quantile(data_bc$ci_dr_lin_s7, 0.025),
#   quantile(data_bc$ci_dr_mox_s7, 0.025),
#   quantile(data_bc$ci_dr_pretomanid_s7, 0.025),
#   quantile(data_bc$ci_dr_pyrazinamide_s7, 0.025)
# )
# 
# yupper <- c(
#   quantile(data_bc$ci_dr_amikacin_s7, 0.975),
#   quantile(data_bc$ci_dr_bed_s7, 0.975),
#   quantile(data_bc$ci_dr_clofaz_s7, 0.975),
#   quantile(data_bc$ci_dr_cyclos_s7, 0.975),
#   quantile(data_bc$ci_dr_del_s7, 0.975),
#   quantile(data_bc$ci_dr_ethambutol_s7, 0.975),
#   quantile(data_bc$ci_dr_ethionamide_s7, 0.975),
#   quantile(data_bc$ci_dr_isoniazid_s7, 0.975),
#   quantile(data_bc$ci_dr_lin_s7, 0.975),
#   quantile(data_bc$ci_dr_mox_s7, 0.975),
#   quantile(data_bc$ci_dr_pretomanid_s7, 0.975),
#   quantile(data_bc$ci_dr_pyrazinamide_s7, 0.975)
# )
# 
# 
# Strategy <- rep("(7): Standard of Care", 12)
# 
# plot_ci_dr_s7 <- data.frame(drugs, ymean, ylower, yupper, Strategy)
# 
# plot_ci_dr <- rbind(plot_ci_dr_s1, plot_ci_dr_s7)
# 
# ggplot(plot_ci_dr, aes(x=drugs, y=ymean, fill=Strategy)) + 
#   geom_bar(stat="identity", color="black", 
#            position=position_dodge()) +
#   geom_errorbar(aes(ymin=ylower, ymax=yupper), width=.2,
#                  position=position_dodge(.9)) +
#   labs(x="Drug", y = "Cumulative incidence of resistance (proportion of cohort)")+
#   theme_classic() +
#   ylim(0, 0.1) +
#   # scale_fill_manual(values=c('mediumpurple3','mediumpurple1', "steelblue2"))+
#   scale_fill_manual(values=c("magenta3", 'steelblue2'))+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
# 
# ggsave("FigS10.png", device = "png", 
#        path = "Figures_v5",
#        scale = 1, width = 24, height = 14, units = "cm"
# )
```


#############################################################################
#
# FIG S4 
#
#############################################################################

```{r}
p_acq_res <- read.csv("tbl_acq_resistance.csv")

p_acq_res_plot<- ggplot(p_acq_res, aes(x=Number.of.effective.drugs.in.regimen, y = Rate.per.month.of.acquiring.resistance.to.a.new.drug)) +
  geom_bar(stat = "identity", fill = "turquoise3") +
  ylim(0,0.2) + 
  labs(x="Number of effective drugs in regimen", y = "Rate per month of acquiring resistance\nto each of the remaining effective drugs")+
  theme_bw()

p_acq_res_plot

ggsave("FigS4.png", device = "png", 
       path = "Figures_v5",
       scale = 1, units = "cm"
)
```

#############################################################################
#
# FIG S5 
#
#############################################################################

```{r}
p_res_wgs <- read.csv("p_resistance_wgs.csv")

p_res_wgs$drug <- factor(p_res_wgs$drug, levels = p_res_wgs$drug)

p_res_wgs_plot <- ggplot(p_res_wgs, aes(x=drug, y = prop)) +
  geom_bar(stat = "identity", fill = "turquoise3") +
  ylim(0,1) + 
  labs(x="Drug", y = "Proportion with resistance at treatment initiation")+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  annotate(geom = "point", x = 11, y = 0.025, shape = 8)


ggsave("FigS5.png", device = "png", 
       path = "Figures_v5",
       scale = 1, units = "cm"
)
```

#############################################################################
#
# COMPARING HEALTH OUTCOME MEASURES OVER DIFFERENT TIME HORIZONS
#
#############################################################################


##### 6 MONTHS ######
```{r process data 6, echo=FALSE}

#Copy and paste this chunk wherever you need to change the input file 

WTP <- WTP_L

# Load the main csv file, all patients 
data_bc <- read.csv("Results/TreeAgeOutput_6mo_20231221.csv")
data_bc <- data.frame(data_bc)

data_temp_health <- fn_process_healthoutcomes(data_bc)
data_temp_droutcomes <- fn_process_droutcomes(data_bc)

bc_QALY_d <- data.frame(data_temp_health[1:18])
bc_QALY_und <- data.frame(data_temp_health[19:36])
bc_LY_und <- data.frame(data_temp_health[37:54])
bc_totalcost_d <- data.frame(data_temp_health[55:72])
bc_totalcost_und <- data.frame(data_temp_health[73:90])
bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
bc_indirectcost_und <- data.frame(data_temp_health[127:144])
bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
bc_NMB <- data.frame(data_temp_health[163:180])
bc_NHB <- data.frame(data_temp_health[181:198])


bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])

WTP <- WTP_U

data_temp_health <- fn_process_healthoutcomes(data_bc)

bc_NMB_U <- data.frame(data_temp_health[163:180])
bc_NHB_U <- data.frame(data_temp_health[181:198])

WTP <- WTP_L

```

```{r HOTable, echo=FALSE}

healthoutcomes_table_6mo <- tibble(
  "Strategy Name" = c(
                 "", "7) Standard of Care", "1) 6 months BPaLM"), 
  "Alternative regimen if Mfx stopped" = c(
    "",  "--", "BPaLC"),
  "2nd line DST at treatment initiation" = c(
    "", "Yes", "Yes"),
  "Routine frequency of subsequent 2nd line DST" = c(
    "", "Every 4 months", "Every 4 months"),
  "1) Unfavorable outcome (based on TB-PRACTECAL trial definition)" = c(
    "Proportion (%)",
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..7.,0.975),1), big.mark=",")),
          ")"),
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..1.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.,0.975),1), big.mark=",")),
          ")")
  ),
  "2) Unfavorable outcome (based on TB-PRACTECAL trial definition)" = c(
    "Risk Difference (percentage points)",
    "",
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.,0.975),1), big.mark=",")),
          ") p=",
          p_value_diff(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.))
  ),
  "3) Unfavorable outcome (based on WHO definition)" = c(
    "Proportion (%)",
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..7.,0.975),1), big.mark=",")),
          ")"),
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..1.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.,0.975),1), big.mark=",")),
          ")")
  ),
  "4) Unfavorable outcome (based on WHO definition)" = c(
    "Risk Difference (percentage points)",
     "",
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.,0.975),1), big.mark=",")),
          ") p=",
          p_value_diff(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.))
  )
  # ,
  # "5) True cure" = c(
  #   "%",
  #   paste(round(100*mean(data_bc$t_cured..7.),1), 
  #         "(",
  #         round(100*quantile(data_bc$t_cured..7.,0.025),1),
  #         ",",
  #         round(100*quantile(data_bc$t_cured..7.,0.975),1),
  #         ")"),
  #   paste(round(100*mean(data_bc$t_cured..1.),1), 
  #         "(",
  #         round(100*quantile(data_bc$t_cured..1.,0.025),1),
  #         ",",
  #         round(100*quantile(data_bc$t_cured..1.,0.975),1),
  #         ")")
  # ),
  # "6) True cure" = c(
  #   "Difference",
  #    "",
  #    paste(round(100*mean(data_bc$t_cured..1.-data_bc$t_cured..7.),1), 
  #         "(",
  #         round(100*quantile(data_bc$t_cured..1.-data_bc$t_cured..7.,0.025),1),
  #         ",",
  #         round(100*quantile(data_bc$t_cured..1.-data_bc$t_cured..7.,0.975),1),
  #         ")",
  #         "p=",
  #         p_value_diff(data_bc$t_cured..1.-data_bc$t_cured..7.))
  # ),
  # "7) QALYs (undiscounted)" = c(
  #   "",
  #   paste(round(mean(bc_QALY_und$s7),3), 
  #         "(",
  #         round(quantile(bc_QALY_und$s7,0.025),3),
  #         ",",
  #         round(quantile(bc_QALY_und$s7,0.975),3),
  #         ")"),
  #   paste(round(mean(bc_QALY_und$s1),3), 
  #         "(",
  #         round(quantile(bc_QALY_und$s1,0.025),3),
  #         ",",
  #         round(quantile(bc_QALY_und$s1,0.975),3),
  #         ")")
  # ),
  # "8) QALYs (undiscounted)" = c(
  #   "Difference",
  #     "",
  #     paste(round(mean(bc_QALY_und$s1-bc_QALY_und$s7),3), 
  #         "(",
  #         round(quantile(bc_QALY_und$s1-bc_QALY_und$s7,0.025),3),
  #         ",",
  #         round(quantile(bc_QALY_und$s1-bc_QALY_und$s7,0.975),3),
  #         ")",
  #         "p=",
  #         p_value_diff(bc_QALY_und$s1-bc_QALY_und$s7))
  # ),
  # "9) LYs (undiscounted)" = c(
  #   "",
  #   paste(round(mean(bc_LY_und$s7),3), 
  #         "(",
  #         round(quantile(bc_LY_und$s7,0.025),3),
  #         ",",
  #         round(quantile(bc_LY_und$s7,0.975),3),
  #         ")"),
  #   paste(round(mean(bc_LY_und$s1),3), 
  #         "(",
  #         round(quantile(bc_LY_und$s1,0.025),3),
  #         ",",
  #         round(quantile(bc_LY_und$s1,0.975),3),
  #         ")")
  # ),
  # "10) LYs (undiscounted)" = c(
  #   "Difference",
  #        "",
  #   paste(round(mean(bc_LY_und$s1-bc_LY_und$s7),3), 
  #         "(",
  #         round(quantile(bc_LY_und$s1-bc_LY_und$s7,0.025),3),
  #         ",",
  #         round(quantile(bc_LY_und$s1-bc_LY_und$s7,0.975),3),
  #         ")",
  #         "p=",
  #         p_value_diff(bc_LY_und$s1-bc_LY_und$s7))
  # )
)
  

write.table(healthoutcomes_table_6mo, file = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5/tableS4a.txt", sep = "|", quote = FALSE, row.names = F)

```


##### 12 MONTHS ######
```{r process data 6, echo=FALSE}

#Copy and paste this chunk wherever you need to change the input file 

WTP <- WTP_L

# Load the main csv file, all patients 
data_bc <- read.csv("Results/TreeAgeOutput_12mo_20231228.csv")
data_bc <- data.frame(data_bc)

data_temp_health <- fn_process_healthoutcomes(data_bc)
data_temp_droutcomes <- fn_process_droutcomes(data_bc)

bc_QALY_d <- data.frame(data_temp_health[1:18])
bc_QALY_und <- data.frame(data_temp_health[19:36])
bc_LY_und <- data.frame(data_temp_health[37:54])
bc_totalcost_d <- data.frame(data_temp_health[55:72])
bc_totalcost_und <- data.frame(data_temp_health[73:90])
bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
bc_indirectcost_und <- data.frame(data_temp_health[127:144])
bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
bc_NMB <- data.frame(data_temp_health[163:180])
bc_NHB <- data.frame(data_temp_health[181:198])


bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])

WTP <- WTP_U

data_temp_health <- fn_process_healthoutcomes(data_bc)

bc_NMB_U <- data.frame(data_temp_health[163:180])
bc_NHB_U <- data.frame(data_temp_health[181:198])

WTP <- WTP_L

```

```{r HOTable, echo=FALSE}

healthoutcomes_table_12mo <- tibble(
  "Strategy Name" = c(
                 "", "7) Standard of Care", "1) 6 months BPaLM"), 
  "Alternative regimen if Mfx stopped" = c(
    "",  "--", "BPaLC"),
  "2nd line DST at treatment initiation" = c(
    "", "Yes", "Yes"),
  "Routine frequency of subsequent 2nd line DST" = c(
    "", "Every 4 months", "Every 4 months"),
  "1) Unfavorable outcome (based on TB-PRACTECAL trial definition)" = c(
    "Proportion (%)",
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..7.,0.975),1), big.mark=",")),
          ")"),
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..1.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.,0.975),1), big.mark=",")),
          ")")
  ),
  "2) Unfavorable outcome (based on TB-PRACTECAL trial definition)" = c(
    "Risk Difference (percentage points)",
    "",
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.,0.975),1), big.mark=",")),
          ") p=",
          p_value_diff(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.))
  ),
  "3) Unfavorable outcome (based on WHO definition)" = c(
    "Proportion (%)",
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..7.,0.975),1), big.mark=",")),
          ")"),
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..1.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.,0.975),1), big.mark=",")),
          ")")
  ),
  "4) Unfavorable outcome (based on WHO definition)" = c(
    "Risk Difference (percentage points)",
     "",
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.,0.975),1), big.mark=",")),
          ") p=",
          p_value_diff(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.))
  )
)

write.table(healthoutcomes_table_12mo, file = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5/tableS4b.txt", sep = "|", quote = FALSE, row.names = F)

```



##### 72 WEEKS / 17 MONTHS ######
```{r process data 6, echo=FALSE}

#Copy and paste this chunk wherever you need to change the input file 

WTP <- WTP_L

# Load the main csv file, all patients 
data_bc <- read.csv("Results/TreeAgeOutput_17mo_20231229.csv")
data_bc <- data.frame(data_bc)

data_temp_health <- fn_process_healthoutcomes(data_bc)
data_temp_droutcomes <- fn_process_droutcomes(data_bc)

bc_QALY_d <- data.frame(data_temp_health[1:18])
bc_QALY_und <- data.frame(data_temp_health[19:36])
bc_LY_und <- data.frame(data_temp_health[37:54])
bc_totalcost_d <- data.frame(data_temp_health[55:72])
bc_totalcost_und <- data.frame(data_temp_health[73:90])
bc_directmedicalcost_und <- data.frame(data_temp_health[91:108])
bc_directnonmedicalcost_und <- data.frame(data_temp_health[109:126])
bc_indirectcost_und <- data.frame(data_temp_health[127:144])
bc_postfatalcost_und <- data.frame(data_temp_health[145:162])
bc_NMB <- data.frame(data_temp_health[163:180])
bc_NHB <- data.frame(data_temp_health[181:198])


bc_drduration_all <- data.frame(data_temp_droutcomes[1:208])
bc_drduration_activeuntr <- data.frame(data_temp_droutcomes[209:416])

WTP <- WTP_U

data_temp_health <- fn_process_healthoutcomes(data_bc)

bc_NMB_U <- data.frame(data_temp_health[163:180])
bc_NHB_U <- data.frame(data_temp_health[181:198])

WTP <- WTP_L

```

```{r HOTable, echo=FALSE}

healthoutcomes_table_72w <- tibble(
  "Strategy Name" = c(
                 "", "7) Standard of Care", "1) 6 months BPaLM"), 
  "Alternative regimen if Mfx stopped" = c(
    "",  "--", "BPaLC"),
  "2nd line DST at treatment initiation" = c(
    "", "Yes", "Yes"),
  "Routine frequency of subsequent 2nd line DST" = c(
    "", "Every 4 months", "Every 4 months"),
  "1) Unfavorable outcome (based on TB-PRACTECAL trial definition)" = c(
    "Proportion (%)",
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..7.,0.975),1), big.mark=",")),
          ")"),
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..1.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.,0.975),1), big.mark=",")),
          ")")
  ),
  "2) Unfavorable outcome (based on TB-PRACTECAL trial definition)" = c(
    "Risk Difference (percentage points)",
    "",
    paste0(trimws(format(round(100*mean(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.,0.975),1), big.mark=",")),
          ") p=",
          p_value_diff(data_bc$t_unfavorable_practecal..1.-data_bc$t_unfavorable_practecal..7.))
  ),
  "3) Unfavorable outcome (based on WHO definition)" = c(
    "Proportion (%)",
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..7.,0.975),1), big.mark=",")),
          ")"),
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..1.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.,0.975),1), big.mark=",")),
          ")")
  ),
  "4) Unfavorable outcome (based on WHO definition)" = c(
    "Risk Difference (percentage points)",
     "",
    paste0(trimws(format(round(100*mean(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.),1), big.mark=",")),
          " (",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.,0.025),1), big.mark=",")),
          ", ",
          trimws(format(round(100*quantile(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.,0.975),1), big.mark=",")),
          ") p=",
          p_value_diff(data_bc$t_nonsuccess_eot..1.-data_bc$t_nonsuccess_eot..7.))
  )
)
  
write.table(healthoutcomes_table_72w, file = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5/tableS4c.txt", sep = "|", quote = FALSE, row.names = F)

```


#############################################################################
#
# Budget Impact
#
#############################################################################

```{r process data BIA 1, echo=FALSE}
#load five files 
rawcost_12mo <- data.frame(read.csv("Results/TreeAgeOutput_12mo_20231228.csv"))
rawcost_24mo <- data.frame(read.csv("Results/TreeAgeOutput_24mo_20231230.csv"))
rawcost_36mo <- data.frame(read.csv("Results/TreeAgeOutput_36mo_20240103.csv"))
rawcost_48mo <- data.frame(read.csv("Results/TreeAgeOutput_48mo_20240105.csv"))
rawcost_60mo <- data.frame(read.csv("Results/TreeAgeOutput_60mo_20240108.csv"))

c_annual <- data.frame(matrix(nrow = 1000, ncol = 40))  

c_annual_cols <- c("c_drugs_1_0_12", "c_drugs_1_12_24", "c_drugs_1_24_36", "c_drugs_1_36_48", "c_drugs_1_48_60",
                   "c_drugs_7_0_12", "c_drugs_7_12_24", "c_drugs_7_24_36", "c_drugs_7_36_48", "c_drugs_7_48_60",
                   "c_lab_1_0_12", "c_lab_1_12_24", "c_lab_1_24_36", "c_lab_1_36_48", "c_lab_1_48_60",
                   "c_lab_7_0_12", "c_lab_7_12_24", "c_lab_7_24_36", "c_lab_7_36_48", "c_lab_7_48_60",
                   "c_rcare_1_0_12", "c_rcare_1_12_24", "c_rcare_1_24_36", "c_rcare_1_36_48", "c_rcare_1_48_60",
                   "c_rcare_7_0_12", "c_rcare_7_12_24", "c_rcare_7_24_36", "c_rcare_7_36_48", "c_rcare_7_48_60",
                   "c_nrcare_1_0_12", "c_nrcare_1_12_24", "c_nrcare_1_24_36", "c_nrcare_1_36_48", "c_nrcare_1_48_60",
                   "c_nrcare_7_0_12", "c_nrcare_7_12_24", "c_nrcare_7_24_36", "c_nrcare_7_36_48", "c_nrcare_7_48_60")

colnames(c_annual) <- c_annual_cols

#Fill columns from raw Treeage outputs
c_annual$c_drugs_1_0_12 <- rawcost_12mo$Drug.Costs..1.
c_annual$c_drugs_1_12_24 <- rawcost_24mo$Drug.Costs..1. - rawcost_12mo$Drug.Costs..1. 
c_annual$c_drugs_1_24_36 <- rawcost_36mo$Drug.Costs..1. - rawcost_24mo$Drug.Costs..1. 
c_annual$c_drugs_1_36_48 <- rawcost_48mo$Drug.Costs..1. - rawcost_36mo$Drug.Costs..1. 
c_annual$c_drugs_1_48_60 <- rawcost_60mo$Drug.Costs..1. - rawcost_48mo$Drug.Costs..1. 

c_annual$c_drugs_7_0_12 <- rawcost_12mo$Drug.Costs..7.
c_annual$c_drugs_7_12_24 <- rawcost_24mo$Drug.Costs..7. - rawcost_12mo$Drug.Costs..7. 
c_annual$c_drugs_7_24_36 <- rawcost_36mo$Drug.Costs..7. - rawcost_24mo$Drug.Costs..7. 
c_annual$c_drugs_7_36_48 <- rawcost_48mo$Drug.Costs..7. - rawcost_36mo$Drug.Costs..7. 
c_annual$c_drugs_7_48_60 <- rawcost_60mo$Drug.Costs..7. - rawcost_48mo$Drug.Costs..7. 

c_annual$c_lab_1_0_12 <- rawcost_12mo$Laboratory.Costs..1.
c_annual$c_lab_1_12_24 <- rawcost_24mo$Laboratory.Costs..1. - rawcost_12mo$Laboratory.Costs..1. 
c_annual$c_lab_1_24_36 <- rawcost_36mo$Laboratory.Costs..1. - rawcost_24mo$Laboratory.Costs..1. 
c_annual$c_lab_1_36_48 <- rawcost_48mo$Laboratory.Costs..1. - rawcost_36mo$Laboratory.Costs..1. 
c_annual$c_lab_1_48_60 <- rawcost_60mo$Laboratory.Costs..1. - rawcost_48mo$Laboratory.Costs..1. 

c_annual$c_lab_7_0_12 <- rawcost_12mo$Laboratory.Costs..7.
c_annual$c_lab_7_12_24 <- rawcost_24mo$Laboratory.Costs..7. - rawcost_12mo$Laboratory.Costs..7. 
c_annual$c_lab_7_24_36 <- rawcost_36mo$Laboratory.Costs..7. - rawcost_24mo$Laboratory.Costs..7. 
c_annual$c_lab_7_36_48 <- rawcost_48mo$Laboratory.Costs..7. - rawcost_36mo$Laboratory.Costs..7. 
c_annual$c_lab_7_48_60 <- rawcost_60mo$Laboratory.Costs..7. - rawcost_48mo$Laboratory.Costs..7. 

c_annual$c_rcare_1_0_12 <- rawcost_12mo$Routine.Care.Costs..1.
c_annual$c_rcare_1_12_24 <- rawcost_24mo$Routine.Care.Costs..1. - rawcost_12mo$Routine.Care.Costs..1. 
c_annual$c_rcare_1_24_36 <- rawcost_36mo$Routine.Care.Costs..1. - rawcost_24mo$Routine.Care.Costs..1. 
c_annual$c_rcare_1_36_48 <- rawcost_48mo$Routine.Care.Costs..1. - rawcost_36mo$Routine.Care.Costs..1. 
c_annual$c_rcare_1_48_60 <- rawcost_60mo$Routine.Care.Costs..1. - rawcost_48mo$Routine.Care.Costs..1. 

c_annual$c_rcare_7_0_12 <- rawcost_12mo$Routine.Care.Costs..7.
c_annual$c_rcare_7_12_24 <- rawcost_24mo$Routine.Care.Costs..7. - rawcost_12mo$Routine.Care.Costs..7. 
c_annual$c_rcare_7_24_36 <- rawcost_36mo$Routine.Care.Costs..7. - rawcost_24mo$Routine.Care.Costs..7. 
c_annual$c_rcare_7_36_48 <- rawcost_48mo$Routine.Care.Costs..7. - rawcost_36mo$Routine.Care.Costs..7. 
c_annual$c_rcare_7_48_60 <- rawcost_60mo$Routine.Care.Costs..7. - rawcost_48mo$Routine.Care.Costs..7. 

c_annual$c_nrcare_1_0_12 <- rawcost_12mo$Nonroutine.Care.Costs..1.
c_annual$c_nrcare_1_12_24 <- rawcost_24mo$Nonroutine.Care.Costs..1. - rawcost_12mo$Nonroutine.Care.Costs..1. 
c_annual$c_nrcare_1_24_36 <- rawcost_36mo$Nonroutine.Care.Costs..1. - rawcost_24mo$Nonroutine.Care.Costs..1. 
c_annual$c_nrcare_1_36_48 <- rawcost_48mo$Nonroutine.Care.Costs..1. - rawcost_36mo$Nonroutine.Care.Costs..1. 
c_annual$c_nrcare_1_48_60 <- rawcost_60mo$Nonroutine.Care.Costs..1. - rawcost_48mo$Nonroutine.Care.Costs..1. 

c_annual$c_nrcare_7_0_12 <- rawcost_12mo$Nonroutine.Care.Costs..7.
c_annual$c_nrcare_7_12_24 <- rawcost_24mo$Nonroutine.Care.Costs..7. - rawcost_12mo$Nonroutine.Care.Costs..7. 
c_annual$c_nrcare_7_24_36 <- rawcost_36mo$Nonroutine.Care.Costs..7. - rawcost_24mo$Nonroutine.Care.Costs..7. 
c_annual$c_nrcare_7_36_48 <- rawcost_48mo$Nonroutine.Care.Costs..7. - rawcost_36mo$Nonroutine.Care.Costs..7. 
c_annual$c_nrcare_7_48_60 <- rawcost_60mo$Nonroutine.Care.Costs..7. - rawcost_48mo$Nonroutine.Care.Costs..7. 

#Calculate incrementals for Strategy 1 as compared to Strategy 7 
c_annual$incr_c_drugs_0_12 <- c_annual$c_drugs_1_0_12 - c_annual$c_drugs_7_0_12
c_annual$incr_c_drugs_12_24 <- c_annual$c_drugs_1_12_24 - c_annual$c_drugs_7_12_24
c_annual$incr_c_drugs_24_36 <- c_annual$c_drugs_1_24_36 - c_annual$c_drugs_7_24_36
c_annual$incr_c_drugs_36_48 <- c_annual$c_drugs_1_36_48 - c_annual$c_drugs_7_36_48
c_annual$incr_c_drugs_48_60 <- c_annual$c_drugs_1_48_60 - c_annual$c_drugs_7_48_60

c_annual$incr_c_lab_0_12 <- c_annual$c_lab_1_0_12 - c_annual$c_lab_7_0_12
c_annual$incr_c_lab_12_24 <- c_annual$c_lab_1_12_24 - c_annual$c_lab_7_12_24
c_annual$incr_c_lab_24_36 <- c_annual$c_lab_1_24_36 - c_annual$c_lab_7_24_36
c_annual$incr_c_lab_36_48 <- c_annual$c_lab_1_36_48 - c_annual$c_lab_7_36_48
c_annual$incr_c_lab_48_60 <- c_annual$c_lab_1_48_60 - c_annual$c_lab_7_48_60

c_annual$incr_c_rcare_0_12 <- c_annual$c_rcare_1_0_12 - c_annual$c_rcare_7_0_12
c_annual$incr_c_rcare_12_24 <- c_annual$c_rcare_1_12_24 - c_annual$c_rcare_7_12_24
c_annual$incr_c_rcare_24_36 <- c_annual$c_rcare_1_24_36 - c_annual$c_rcare_7_24_36
c_annual$incr_c_rcare_36_48 <- c_annual$c_rcare_1_36_48 - c_annual$c_rcare_7_36_48
c_annual$incr_c_rcare_48_60 <- c_annual$c_rcare_1_48_60 - c_annual$c_rcare_7_48_60

c_annual$incr_c_nrcare_0_12 <- c_annual$c_nrcare_1_0_12 - c_annual$c_nrcare_7_0_12
c_annual$incr_c_nrcare_12_24 <- c_annual$c_nrcare_1_12_24 - c_annual$c_nrcare_7_12_24
c_annual$incr_c_nrcare_24_36 <- c_annual$c_nrcare_1_24_36 - c_annual$c_nrcare_7_24_36
c_annual$incr_c_nrcare_36_48 <- c_annual$c_nrcare_1_36_48 - c_annual$c_nrcare_7_36_48
c_annual$incr_c_nrcare_48_60 <- c_annual$c_nrcare_1_48_60 - c_annual$c_nrcare_7_48_60

#Convert to monthly 
c_monthly <- c_annual/12

#Get into format for next code chunk, including total columns summed across the budget categories 
bia <- c_monthly[,41:60]
bia$incr_c_total_0_12 <- bia$incr_c_drugs_0_12 + bia$incr_c_lab_0_12 + bia$incr_c_rcare_0_12 + bia$incr_c_nrcare_0_12
bia$incr_c_total_12_24 <- bia$incr_c_drugs_12_24 + bia$incr_c_lab_12_24 + bia$incr_c_rcare_12_24 + bia$incr_c_nrcare_12_24
bia$incr_c_total_24_36 <- bia$incr_c_drugs_24_36 + bia$incr_c_lab_24_36 + bia$incr_c_rcare_24_36 + bia$incr_c_nrcare_24_36
bia$incr_c_total_36_48 <- bia$incr_c_drugs_36_48 + bia$incr_c_lab_36_48 + bia$incr_c_rcare_36_48 + bia$incr_c_nrcare_36_48
bia$incr_c_total_48_60 <- bia$incr_c_drugs_48_60 + bia$incr_c_lab_48_60 + bia$incr_c_rcare_48_60 + bia$incr_c_nrcare_48_60
```

```{r process data BIA 2, echo=FALSE}
# Generate 1000 draws from r.v. for case notifications per year 
# As per Table S1, sd assumed to be 1/3 of mean
cn_yr <- rnorm(1000, mean = 644, sd = 644/3)
cn_mo = cn_yr/12

# set number of simulations
bia_sims <- 1000

#generate final results matrix bia_sims*25
bia_2 <- data.frame(matrix(nrow = bia_sims, ncol = 25))

bia_2_cols <- c(
  "bi_drugs_y1", "bi_drugs_y2", "bi_drugs_y3", "bi_drugs_y4", "bi_drugs_y5",
  "bi_lab_y1", "bi_lab_y2", "bi_lab_y3", "bi_lab_y4", "bi_lab_y5",
  "bi_rcare_y1", "bi_rcare_y2", "bi_rcare_y3", "bi_rcare_y4", "bi_rcare_y5",
  "bi_nrcare_y1", "bi_nrcare_y2", "bi_nrcare_y3", "bi_nrcare_y4", "bi_nrcare_y5",
  "bi_total_y1", "bi_total_y2", "bi_total_y3", "bi_total_y4", "bi_total_y5"
)

colnames(bia_2) <- bia_2_cols

columns <- c(
  "c_mo_1",
  "c_mo_2",
  "c_mo_3",
  "c_mo_4",
  "c_mo_5",
  "c_mo_6",
  "c_mo_7",
  "c_mo_8",
  "c_mo_9",
  "c_mo_10",
  "c_mo_11",
  "c_mo_12",
  "c_mo_13",
  "c_mo_14",
  "c_mo_15",
  "c_mo_16",
  "c_mo_17",
  "c_mo_18",
  "c_mo_19",
  "c_mo_20",
  "c_mo_21",
  "c_mo_22",
  "c_mo_23",
  "c_mo_24",
  "c_mo_25",
  "c_mo_26",
  "c_mo_27",
  "c_mo_28",
  "c_mo_29",
  "c_mo_30",
  "c_mo_31",
  "c_mo_32",
  "c_mo_33",
  "c_mo_34",
  "c_mo_35",
  "c_mo_36",
  "c_mo_37",
  "c_mo_38",
  "c_mo_39",
  "c_mo_40",
  "c_mo_41",
  "c_mo_42",
  "c_mo_43",
  "c_mo_44",
  "c_mo_45",
  "c_mo_46",
  "c_mo_47",
  "c_mo_48",
  "c_mo_49",
  "c_mo_50",
  "c_mo_51",
  "c_mo_52",
  "c_mo_53",
  "c_mo_54",
  "c_mo_55",
  "c_mo_56",
  "c_mo_57",
  "c_mo_58",
  "c_mo_59",
  "c_mo_60")

row_numbers <- seq(1,1000,1)

for(i in 1:bia_sims){
  #draw with replacement one value from cn_mo 
  cn <- sample(cn_mo, 1, replace = TRUE)
  
  #draw with replacement one row number from the budget PSA results
  sample_bi_row <- sample(row_numbers, 1, TRUE)
  
  #generate 5 zero matrices 60x60, one for each of 4 budget categories and one for total
  bi_drugs <- data.frame(matrix(nrow=60, ncol = 60))
  bi_lab <- data.frame(matrix(nrow=60, ncol = 60))
  bi_rcare <- data.frame(matrix(nrow=60, ncol = 60))
  bi_nrcare <- data.frame(matrix(nrow=60, ncol = 60))
  bi_total <- data.frame(matrix(nrow=60, ncol = 60))
  
  colnames(bi_drugs) <- columns
  colnames(bi_lab) <- columns
  colnames(bi_rcare) <- columns
  colnames(bi_nrcare) <- columns
  colnames(bi_total) <- columns
  
  #drugs, fill row 1 starting in column 1. make sure to multiply by cn_mo 
  for(j in 1:nrow(bi_drugs)){
    for(k in 1:ncol(bi_drugs)){
      if(j>k){
        bi_drugs[j,k] <- 0 
      } else if(k-(j-1)<=12){
          bi_drugs[j,k] <- bia$incr_c_drugs_0_12[sample_bi_row]*cn
      } else if(k-(j-1)<=24){
          bi_drugs[j,k] <- bia$incr_c_drugs_12_24[sample_bi_row]*cn
      } else if(k-(j-1)<=36){
          bi_drugs[j,k] <- bia$incr_c_drugs_24_36[sample_bi_row]*cn
      } else if(k-(j-1)<=48){
          bi_drugs[j,k] <- bia$incr_c_drugs_36_48[sample_bi_row]*cn
      } else {
          bi_drugs[j,k] <- bia$incr_c_drugs_48_60[sample_bi_row]*cn
      }
    }
  }
  
  for(j in 1:nrow(bi_lab)){
    for(k in 1:ncol(bi_lab)){
      if(j>k){
        bi_lab[j,k] <- 0 
      } else if(k-(j-1)<=12){
          bi_lab[j,k] <- bia$incr_c_lab_0_12[sample_bi_row]*cn
      } else if(k-(j-1)<=24){
          bi_lab[j,k] <- bia$incr_c_lab_12_24[sample_bi_row]*cn
      } else if(k-(j-1)<=36){
          bi_lab[j,k] <- bia$incr_c_lab_24_36[sample_bi_row]*cn
      } else if(k-(j-1)<=48){
          bi_lab[j,k] <- bia$incr_c_lab_36_48[sample_bi_row]*cn
      } else {
          bi_lab[j,k] <- bia$incr_c_lab_48_60[sample_bi_row]*cn
      }
    }
  }

  for(j in 1:nrow(bi_rcare)){
    for(k in 1:ncol(bi_rcare)){
      if(j>k){
        bi_rcare[j,k] <- 0 
      } else if(k-(j-1)<=12){
          bi_rcare[j,k] <- bia$incr_c_rcare_0_12[sample_bi_row]*cn
      } else if(k-(j-1)<=24){
          bi_rcare[j,k] <- bia$incr_c_rcare_12_24[sample_bi_row]*cn
      } else if(k-(j-1)<=36){
          bi_rcare[j,k] <- bia$incr_c_rcare_24_36[sample_bi_row]*cn
      } else if(k-(j-1)<=48){
          bi_rcare[j,k] <- bia$incr_c_rcare_36_48[sample_bi_row]*cn
      } else {
          bi_rcare[j,k] <- bia$incr_c_rcare_48_60[sample_bi_row]*cn
      }
    }
  }  

  for(j in 1:nrow(bi_nrcare)){
    for(k in 1:ncol(bi_nrcare)){
      if(j>k){
        bi_nrcare[j,k] <- 0 
      } else if(k-(j-1)<=12){
          bi_nrcare[j,k] <- bia$incr_c_nrcare_0_12[sample_bi_row]*cn
      } else if(k-(j-1)<=24){
          bi_nrcare[j,k] <- bia$incr_c_nrcare_12_24[sample_bi_row]*cn
      } else if(k-(j-1)<=36){
          bi_nrcare[j,k] <- bia$incr_c_nrcare_24_36[sample_bi_row]*cn
      } else if(k-(j-1)<=48){
          bi_nrcare[j,k] <- bia$incr_c_nrcare_36_48[sample_bi_row]*cn
      } else {
          bi_nrcare[j,k] <- bia$incr_c_nrcare_48_60[sample_bi_row]*cn
      }
    }
  }
  
  for(j in 1:nrow(bi_total)){
    for(k in 1:ncol(bi_total)){
      if(j>k){
        bi_total[j,k] <- 0 
      } else if(k-(j-1)<=12){
          bi_total[j,k] <- bia$incr_c_total_0_12[sample_bi_row]*cn
      } else if(k-(j-1)<=24){
          bi_total[j,k] <- bia$incr_c_total_12_24[sample_bi_row]*cn
      } else if(k-(j-1)<=36){
          bi_total[j,k] <- bia$incr_c_total_24_36[sample_bi_row]*cn
      } else if(k-(j-1)<=48){
          bi_total[j,k] <- bia$incr_c_total_36_48[sample_bi_row]*cn
      } else {
          bi_total[j,k] <- bia$incr_c_total_48_60[sample_bi_row]*cn
      }
    }
  }
  
  #sum totals for Y1 (cols 1-12), Y2, Y3, Y4, Y5
  bia_2[i,1] <- sum(bi_drugs[,1:12])
  bia_2[i,2] <- sum(bi_drugs[,13:24])
  bia_2[i,3] <- sum(bi_drugs[,25:36])
  bia_2[i,4] <- sum(bi_drugs[,37:48])
  bia_2[i,5] <- sum(bi_drugs[,49:60])
  
  bia_2[i,6] <- sum(bi_lab[,1:12])
  bia_2[i,7] <- sum(bi_lab[,13:24])
  bia_2[i,8] <- sum(bi_lab[,25:36])
  bia_2[i,9] <- sum(bi_lab[,37:48])
  bia_2[i,10] <- sum(bi_lab[,49:60])

  bia_2[i,11] <- sum(bi_rcare[,1:12])
  bia_2[i,12] <- sum(bi_rcare[,13:24])
  bia_2[i,13] <- sum(bi_rcare[,25:36])
  bia_2[i,14] <- sum(bi_rcare[,37:48])
  bia_2[i,15] <- sum(bi_rcare[,49:60])

  bia_2[i,16] <- sum(bi_nrcare[,1:12])
  bia_2[i,17] <- sum(bi_nrcare[,13:24])
  bia_2[i,18] <- sum(bi_nrcare[,25:36])
  bia_2[i,19] <- sum(bi_nrcare[,37:48])
  bia_2[i,20] <- sum(bi_nrcare[,49:60])
  
  bia_2[i,21] <- sum(bi_total[,1:12])
  bia_2[i,22] <- sum(bi_total[,13:24])
  bia_2[i,23] <- sum(bi_total[,25:36])
  bia_2[i,24] <- sum(bi_total[,37:48])
  bia_2[i,25] <- sum(bi_total[,49:60])
}

```

#Repeat for Absolute for Strategy 1
#Correction: NO! This would require additional assumptions around how to calculate 
#budget for those already receiving care at the time of the policy decision 
#Could be done with more time?
# ```{r process data BIA, echo=FALSE}
# 
# # Load the main budg_abs_1 file
# budg_abs_1 <- read.csv("Results/BudgetAbsoluteVals_20231206.csv")
# budg_abs_1 <- data.frame(budg_abs_1)
# # Generate 1000 draws from r.v. for case notifications per year 
# 
# # set number of simulations
# budg_abs_1_sims <- 1000
# 
# #generate final results matrix budg_abs_1_sims*25
# budg_abs_1_2 <- data.frame(matrix(nrow = budg_abs_1_sims, ncol = 5))
# 
# budg_abs_1_2_cols <- c(
#   "bi_total_y1", "bi_total_y2", "bi_total_y3", "bi_total_y4", "bi_total_y5"
# )
# 
# colnames(budg_abs_1_2) <- budg_abs_1_2_cols
# 
# for(i in 1:budg_abs_1_sims){
#   #draw with replacement one value from cn_mo 
#   cn <- sample(cn_mo, 1, replace = TRUE)
#   
#   #draw with replacement one row number from the budget PSA results
#   sample_bi_row <- sample(bi_row, 1, replace = TRUE)
#   
#   #generate 5 zero matrices 60x60, one for each of 4 budget categories and one for total
#   bi_total <- data.frame(matrix(nrow=60, ncol = 60))
#   
#   colnames(bi_total) <- columns
#   
#   for(j in 1:nrow(bi_total)){
#     for(k in 1:ncol(bi_total)){
#       if(j>k){
#         bi_total[j,k] <- 0 
#       } else if(k-(j-1)<=12){
#           bi_total[j,k] <- budg_abs_1$c_total_1_0_12[sample_bi_row]*cn
#       } else if(k-(j-1)<=24){
#           bi_total[j,k] <- budg_abs_1$c_total_1_12_24[sample_bi_row]*cn
#       } else if(k-(j-1)<=36){
#           bi_total[j,k] <- budg_abs_1$c_total_1_24_36[sample_bi_row]*cn
#       } else if(k-(j-1)<=48){
#           bi_total[j,k] <- budg_abs_1$c_total_1_36_48[sample_bi_row]*cn
#       } else {
#           bi_total[j,k] <- budg_abs_1$c_total_1_48_60[sample_bi_row]*cn
#       }
#     }
#   }
#   
#   #sum totals for Y1 (cols 1-12), Y2, Y3, Y4, Y5
#   budg_abs_1_2[i,1] <- sum(bi_total[,1:12])
#   budg_abs_1_2[i,2] <- sum(bi_total[,13:24])
#   budg_abs_1_2[i,3] <- sum(bi_total[,25:36])
#   budg_abs_1_2[i,4] <- sum(bi_total[,37:48])
#   budg_abs_1_2[i,5] <- sum(bi_total[,49:60])
# }
# 
# ```


```{r}

# x is vector length 3
# n is num of decimal places 
# format() adds in commas and forces certain number of d.ps 
# trim removes stuff at front 

# use apply to use this in tibble 

BI_table <- tibble(
  "Budget Year" = c("Year 1",
                 "Year 2", "Year 3",
                 "Year 4", "Year 5", "Total"),
  "Drugs" = c(
    paste0(trimws(format(round(mean(bia_2$bi_drugs_y1)), big.mark=",")), " (",
          trimws(format(round(quantile(bia_2$bi_drugs_y1, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_drugs_y1, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_drugs_y1)),
    paste0(trimws(format(round(mean(bia_2$bi_drugs_y2)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_drugs_y2, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_drugs_y2, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_drugs_y2)),
    paste0(trimws(format(round(mean(bia_2$bi_drugs_y3)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_drugs_y3, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_drugs_y3, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_drugs_y3)),
    paste0(trimws(format(round(mean(bia_2$bi_drugs_y4)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_drugs_y4, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_drugs_y4, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_drugs_y4)),
    paste0(trimws(format(round(mean(bia_2$bi_drugs_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_drugs_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_drugs_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_drugs_y5)),
    paste0(trimws(format(round(mean(bia_2$bi_drugs_y1+
                       bia_2$bi_drugs_y2+
                       bia_2$bi_drugs_y3+
                       bia_2$bi_drugs_y4+
                       bia_2$bi_drugs_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_drugs_y1+
                       bia_2$bi_drugs_y2+
                       bia_2$bi_drugs_y3+
                       bia_2$bi_drugs_y4+
                       bia_2$bi_drugs_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_drugs_y1+
                       bia_2$bi_drugs_y2+
                       bia_2$bi_drugs_y3+
                       bia_2$bi_drugs_y4+
                       bia_2$bi_drugs_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_drugs_y1+
                       bia_2$bi_drugs_y2+
                       bia_2$bi_drugs_y3+
                       bia_2$bi_drugs_y4+
                       bia_2$bi_drugs_y5))
  ),
  "Laboratory Tests" = c(
    paste0(trimws(format(round(mean(bia_2$bi_lab_y1)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_lab_y1, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_lab_y1, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_lab_y1)),
    paste0(trimws(format(round(mean(bia_2$bi_lab_y2)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_lab_y2, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_lab_y2, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_lab_y2)),
    paste0(trimws(format(round(mean(bia_2$bi_lab_y3)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_lab_y3, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_lab_y3, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_lab_y3)),
    paste0(trimws(format(round(mean(bia_2$bi_lab_y4)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_lab_y4, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_lab_y4, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_lab_y4)),
    paste0(trimws(format(round(mean(bia_2$bi_lab_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_lab_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_lab_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_lab_y5)),
    paste0(trimws(format(round(mean(bia_2$bi_lab_y1+
                       bia_2$bi_lab_y2+
                       bia_2$bi_lab_y3+
                       bia_2$bi_lab_y4+
                       bia_2$bi_lab_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_lab_y1+
                       bia_2$bi_lab_y2+
                       bia_2$bi_lab_y3+
                       bia_2$bi_lab_y4+
                       bia_2$bi_lab_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_lab_y1+
                       bia_2$bi_lab_y2+
                       bia_2$bi_lab_y3+
                       bia_2$bi_lab_y4+
                       bia_2$bi_lab_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_lab_y1+
                       bia_2$bi_lab_y2+
                       bia_2$bi_lab_y3+
                       bia_2$bi_lab_y4+
                       bia_2$bi_lab_y5))
  ),
  "Routine Care" = c(
    paste0(trimws(format(round(mean(bia_2$bi_rcare_y1)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_rcare_y1, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_rcare_y1, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_rcare_y1)),
    paste0(trimws(format(round(mean(bia_2$bi_rcare_y2)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_rcare_y2, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_rcare_y2, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_rcare_y2)),
    paste0(trimws(format(round(mean(bia_2$bi_rcare_y3)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_rcare_y3, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_rcare_y3, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_rcare_y3)),
    paste0(trimws(format(round(mean(bia_2$bi_rcare_y4)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_rcare_y4, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_rcare_y4, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_rcare_y4)),
    paste0(trimws(format(round(mean(bia_2$bi_rcare_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_rcare_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_rcare_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_rcare_y5)),
    paste0(trimws(format(round(mean(bia_2$bi_rcare_y1+
                       bia_2$bi_rcare_y2+
                       bia_2$bi_rcare_y3+
                       bia_2$bi_rcare_y4+
                       bia_2$bi_rcare_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_rcare_y1+
                       bia_2$bi_rcare_y2+
                       bia_2$bi_rcare_y3+
                       bia_2$bi_rcare_y4+
                       bia_2$bi_rcare_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_rcare_y1+
                       bia_2$bi_rcare_y2+
                       bia_2$bi_rcare_y3+
                       bia_2$bi_rcare_y4+
                       bia_2$bi_rcare_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_rcare_y1+
                       bia_2$bi_rcare_y2+
                       bia_2$bi_rcare_y3+
                       bia_2$bi_rcare_y4+
                       bia_2$bi_rcare_y5))
  ),
  "Nonroutine Care" = c(
    paste0(trimws(format(round(mean(bia_2$bi_nrcare_y1)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_nrcare_y1, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_nrcare_y1, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_nrcare_y1)),
    paste0(trimws(format(round(mean(bia_2$bi_nrcare_y2)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_nrcare_y2, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_nrcare_y2, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_nrcare_y2)),
    paste0(trimws(format(round(mean(bia_2$bi_nrcare_y3)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_nrcare_y3, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_nrcare_y3, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_nrcare_y3)),
    paste0(trimws(format(round(mean(bia_2$bi_nrcare_y4)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_nrcare_y4, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_nrcare_y4, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_nrcare_y4)),
    paste0(trimws(format(round(mean(bia_2$bi_nrcare_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_nrcare_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_nrcare_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_nrcare_y5)),
    paste0(trimws(format(round(mean(bia_2$bi_nrcare_y1+
                       bia_2$bi_nrcare_y2+
                       bia_2$bi_nrcare_y3+
                       bia_2$bi_nrcare_y4+
                       bia_2$bi_nrcare_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_nrcare_y1+
                       bia_2$bi_nrcare_y2+
                       bia_2$bi_nrcare_y3+
                       bia_2$bi_nrcare_y4+
                       bia_2$bi_nrcare_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_nrcare_y1+
                       bia_2$bi_nrcare_y2+
                       bia_2$bi_nrcare_y3+
                       bia_2$bi_nrcare_y4+
                       bia_2$bi_nrcare_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_nrcare_y1+
                       bia_2$bi_nrcare_y2+
                       bia_2$bi_nrcare_y3+
                       bia_2$bi_nrcare_y4+
                       bia_2$bi_nrcare_y5))
  ),
  "Total" = c(
    paste0(trimws(format(round(mean(bia_2$bi_total_y1)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_total_y1, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_total_y1, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_total_y1)),
    paste0(trimws(format(round(mean(bia_2$bi_total_y2)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_total_y2, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_total_y2, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_total_y2)),
    paste0(trimws(format(round(mean(bia_2$bi_total_y3)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_total_y3, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_total_y3, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_total_y3)),
    paste0(trimws(format(round(mean(bia_2$bi_total_y4)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_total_y4, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_total_y4, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_total_y4)),
    paste0(trimws(format(round(mean(bia_2$bi_total_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_total_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_total_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_total_y5)),
    paste0(trimws(format(round(mean(bia_2$bi_total_y1+
                       bia_2$bi_total_y2+
                       bia_2$bi_total_y3+
                       bia_2$bi_total_y4+
                       bia_2$bi_total_y5)), big.mark=",")), " (", 
          trimws(format(round(quantile(bia_2$bi_total_y1+
                       bia_2$bi_total_y2+
                       bia_2$bi_total_y3+
                       bia_2$bi_total_y4+
                       bia_2$bi_total_y5, 0.025)), big.mark=",")), ", ",
          trimws(format(round(quantile(bia_2$bi_total_y1+
                       bia_2$bi_total_y2+
                       bia_2$bi_total_y3+
                       bia_2$bi_total_y4+
                       bia_2$bi_total_y5, 0.975)), big.mark=",")), ") p=",
          p_value_diff(bia_2$bi_total_y1+
                       bia_2$bi_total_y2+
                       bia_2$bi_total_y3+
                       bia_2$bi_total_y4+
                       bia_2$bi_total_y5))
  )
)

rm(bi_row, bia_sims, bi_drugs, bi_lab, bi_nrcare, bi_rcare, bi_total, bia, bia_2, cn, cn_yr, c_mo_40, cn_gen, cn_MLD)

write.table(BI_table, file = "/Users/Lyndon/Documents/DR-TB Simplified Regimen Moldova/Figures_v5/tableBI.txt", sep = "|", quote = FALSE, row.names = F)
```




